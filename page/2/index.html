<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<!--添加头部进度条-->
<!-- <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 2px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style> -->
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="曾大稳丶">
<meta property="og:url" content="http://www.zengzhaowen.cn/page/2/index.html">
<meta property="og:site_name" content="曾大稳丶">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="曾大稳丶">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.zengzhaowen.cn/page/2/"/>





  <title>曾大稳丶</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ccc0cac4d5d9e6f8efec9c129ada134d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">曾大稳丶</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android配置EGL环境.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android配置EGL环境.html" itemprop="url">Android配置EGL环境</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-14T17:25:46+08:00">
                2018-08-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android配置EGL环境.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android配置EGL环境.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,164字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>EGL</p>
<blockquote>
<p>是<code>OpenGL ES</code>和本地窗口系统的接口，不同平台上<code>EGL</code>配置是不一样的，而<br><code>OpenGL</code>的调用方式是一致的，就是说：<code>OpenGL</code>跨平台就是依赖于<code>EGL</code>接口。<br>我的得理解是：在一个平台上搭建<code>OpenGL</code>的环境。</p>
</blockquote>
<p>为什么要自己创建EGL环境？  </p>
<blockquote>
<p>有的人会想，在android里面系统已经提供了<code>GLSurfaceView</code><br>，已经有了<code>EGL</code>环境，我们为什么还要自己搭建这个环境呢？<br>当我们需要把同一个场景渲染到不同的<code>Surface</code>上时，此时系统<code>GLSurfaceView</code><br>就不能满足需求了，所以我们需要自己创建<code>EGL</code>环境来实现渲染操作。<br>注意: <code>OpenGL</code>整体是一个状态机，通过改变状态就能改变后续的渲染方式，而<br><code>EGLContext（EgL上下文）</code>就保存有所有状态，因此可以通过共享<code>EGLContext</code><br>来实现同一场景渲染到不同的<code>Surface</code>上。</p>
</blockquote>
<p><code>Android</code>配置<code>egl</code>环境我们根据<code>GLSurfaceView</code>源码来实现。在<code>GLSurfaceView</code>源码里面，当调用<code>setRenderer</code>的时候会开启一个线程<code>GLThread</code>,<code>GLThread</code>调用<code>start</code>的时候会初始化<code>EglHelper</code>来配置<code>egl</code>环境，然后一个<code>while(true)</code>执行，根据不同的标识判断执行<code>egl</code>的环境配置，<code>Renderer</code>的<code>onSurfaceCreated</code>,<code>onSurfaceChanged</code>,<code>onDrawFrame</code>等函数。</p>
<p>从源码得知我们配置<code>egl</code>环境主要根据<code>GLSurfaceView.EglHelper</code>来写，主要分为已下几步：</p>
<blockquote>
<p>1、得到Egl实例<br>2、得到默认的显示设备（就是窗口）<br>3、初始化默认显示设备<br>4、设置显示设备的属性<br>5、从系统中获取对应属性的配置<br>6、创建EglContext<br>7、创建渲染的Surface<br>8、绑定EglContext和Surface到显示设备中<br>9、刷新数据，显示渲染场景  </p>
</blockquote>
<p>最终代码如下:<br>EglHelper.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.zzw.glsurfaceviewdemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.Surface;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.egl.EGL10;</span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.egl.EGLConfig;</span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.egl.EGLContext;</span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.egl.EGLDisplay;</span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.egl.EGLSurface;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EglHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"EglHelper"</span>;</span><br><span class="line">    <span class="keyword">private</span> EGL10 mEgl;</span><br><span class="line">    <span class="keyword">private</span> EGLDisplay mEglDisplay;</span><br><span class="line">    <span class="keyword">private</span> EGLContext mEglContext;</span><br><span class="line">    <span class="keyword">private</span> EGLSurface mEglSurface;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initEgl</span><span class="params">(Surface surface, EGLContext eglContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 得到Egl实例</span></span><br><span class="line">        mEgl = (EGL10) EGLContext.getEGL();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 得到默认的显示设备（就是窗口）</span></span><br><span class="line">        mEglDisplay = mEgl.eglGetDisplay(EGL10.EGL_DEFAULT_DISPLAY);</span><br><span class="line">        <span class="keyword">if</span> (mEglDisplay == EGL10.EGL_NO_DISPLAY) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"eglGetDisplay failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 初始化默认显示设备</span></span><br><span class="line">        <span class="keyword">int</span>[] version = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">if</span> (!mEgl.eglInitialize(mEglDisplay, version)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"eglInitialize failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 设置显示设备的属性</span></span><br><span class="line">        <span class="keyword">int</span>[] attrib_list = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;</span><br><span class="line">                EGL10.EGL_RED_SIZE, mRedSize,</span><br><span class="line">                EGL10.EGL_GREEN_SIZE, mGreenSize,</span><br><span class="line">                EGL10.EGL_BLUE_SIZE, mBlueSize,</span><br><span class="line">                EGL10.EGL_ALPHA_SIZE, mAlphaSize,</span><br><span class="line">                EGL10.EGL_DEPTH_SIZE, mDepthSize,</span><br><span class="line">                EGL10.EGL_STENCIL_SIZE, mStencilSize,</span><br><span class="line">                EGL10.EGL_RENDERABLE_TYPE, mRenderType,<span class="comment">//egl版本  2.0</span></span><br><span class="line">                EGL10.EGL_NONE&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] num_config = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (!mEgl.eglChooseConfig(mEglDisplay, attrib_list, <span class="keyword">null</span>, <span class="number">1</span>,</span><br><span class="line">                num_config)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"eglChooseConfig failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> numConfigs = num_config[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (numConfigs &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"No configs match configSpec"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 从系统中获取对应属性的配置</span></span><br><span class="line">        EGLConfig[] configs = <span class="keyword">new</span> EGLConfig[numConfigs];</span><br><span class="line">        <span class="keyword">if</span> (!mEgl.eglChooseConfig(mEglDisplay, attrib_list, configs, numConfigs,</span><br><span class="line">                num_config)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"eglChooseConfig#2 failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        EGLConfig eglConfig = chooseConfig(mEgl, mEglDisplay, configs);</span><br><span class="line">        <span class="keyword">if</span> (eglConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">            eglConfig = configs[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6. 创建EglContext</span></span><br><span class="line">        <span class="keyword">int</span>[] contextAttr = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;</span><br><span class="line">                EGL14.EGL_CONTEXT_CLIENT_VERSION, <span class="number">2</span>,</span><br><span class="line">                EGL10.EGL_NONE</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (eglContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mEglContext =  mEgl.eglCreateContext(mEglDisplay, eglConfig, EGL10.EGL_NO_CONTEXT, contextAttr);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mEglContext = mEgl.eglCreateContext(mEglDisplay, eglConfig, eglContext, contextAttr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//7. 创建渲染的Surface</span></span><br><span class="line">        mEglSurface = mEgl.eglCreateWindowSurface(mEglDisplay, eglConfig, surface, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//8. 绑定EglContext和Surface到显示设备中</span></span><br><span class="line">        <span class="keyword">if</span> (!mEgl.eglMakeCurrent(mEglDisplay, mEglSurface, mEglSurface, mEglContext)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"eglMakeCurrent fail"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//9. 刷新数据，显示渲染场景</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">swapBuffers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mEgl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> mEgl.eglSwapBuffers(mEglDisplay, mEglSurface);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"egl is null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destoryEgl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mEgl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mEglSurface != <span class="keyword">null</span> &amp;&amp; mEglSurface != EGL10.EGL_NO_SURFACE) &#123;</span><br><span class="line">                mEgl.eglMakeCurrent(mEglDisplay, EGL10.EGL_NO_SURFACE,</span><br><span class="line">                        EGL10.EGL_NO_SURFACE,</span><br><span class="line">                        EGL10.EGL_NO_CONTEXT);</span><br><span class="line"></span><br><span class="line">                mEgl.eglDestroySurface(mEglDisplay, mEglSurface);</span><br><span class="line">                mEglSurface = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mEglContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mEgl.eglDestroyContext(mEglDisplay, mEglContext);</span><br><span class="line">                mEglContext = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mEglDisplay != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mEgl.eglTerminate(mEglDisplay);</span><br><span class="line">                mEglDisplay = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mEgl = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EGLContext <span class="title">getEglContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mEglContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mRedSize = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mGreenSize = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mBlueSize = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mAlphaSize = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mDepthSize = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mStencilSize = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mRenderType = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> EGLConfig <span class="title">chooseConfig</span><span class="params">(EGL10 egl, EGLDisplay display,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   EGLConfig[] configs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (EGLConfig config : configs) &#123;</span><br><span class="line">            <span class="keyword">int</span> d = findConfigAttrib(egl, display, config,</span><br><span class="line">                    EGL10.EGL_DEPTH_SIZE, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">int</span> s = findConfigAttrib(egl, display, config,</span><br><span class="line">                    EGL10.EGL_STENCIL_SIZE, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> ((d &gt;= mDepthSize) &amp;&amp; (s &gt;= mStencilSize)) &#123;</span><br><span class="line">                <span class="keyword">int</span> r = findConfigAttrib(egl, display, config,</span><br><span class="line">                        EGL10.EGL_RED_SIZE, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">int</span> g = findConfigAttrib(egl, display, config,</span><br><span class="line">                        EGL10.EGL_GREEN_SIZE, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">int</span> b = findConfigAttrib(egl, display, config,</span><br><span class="line">                        EGL10.EGL_BLUE_SIZE, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">int</span> a = findConfigAttrib(egl, display, config,</span><br><span class="line">                        EGL10.EGL_ALPHA_SIZE, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> ((r == mRedSize) &amp;&amp; (g == mGreenSize)</span><br><span class="line">                        &amp;&amp; (b == mBlueSize) &amp;&amp; (a == mAlphaSize)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> config;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">findConfigAttrib</span><span class="params">(EGL10 egl, EGLDisplay display,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 EGLConfig config, <span class="keyword">int</span> attribute, <span class="keyword">int</span> defaultValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] value = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (egl.eglGetConfigAttrib(display, config, attribute, value)) &#123;</span><br><span class="line">            <span class="keyword">return</span> value[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> defaultValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/ffmpeg音视频合成.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/ffmpeg音视频合成.html" itemprop="url">ffmpeg音视频合成</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-27T17:59:40+08:00">
                2018-07-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ffmpeg/" itemprop="url" rel="index">
                    <span itemprop="name">ffmpeg</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/ffmpeg音视频合成.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/ffmpeg音视频合成.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,371字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  8分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>原理 : 主要是拿到视频文件得视频流，然后拿到音频文件的音频流，根据时间戳一帧一帧的封装成一个新的视频文件</strong></p>
<p>效果：音频文件和视频文件合成一个文件，合成的文件时间就是两个文件中短的时间。<br>源代码如下:具体看注释</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"libavcodec/avcodec.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"libavformat/avformat.h"</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  LOG_TAG    <span class="meta-string">"JNI_TAG"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  LOGD(...)  __android_log_print(ANDROID_LOG_ERROR, LOG_TAG, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_zzw_ffmpegdemo_FFmpegHelper_megre(JNIEnv *env, jobject instance, jstring musicPath_,</span><br><span class="line">                                           jstring videoPath_,jstring outPath_) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    AVOutputFormat *ofmt = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//Input AVFormatContext and Output AVFormatContext</span></span><br><span class="line">    AVFormatContext *ifmt_ctx_v = <span class="literal">NULL</span>, *ifmt_ctx_a = <span class="literal">NULL</span>,*ofmt_ctx = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> ret, i;</span><br><span class="line">    <span class="keyword">int</span> videoindex_v=<span class="number">-1</span>,videoindex_out=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> audioindex_a=<span class="number">-1</span>,audioindex_out=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> frame_index=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int64_t</span> cur_pts_v=<span class="number">0</span>,cur_pts_a=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *musicPath = env-&gt;GetStringUTFChars(musicPath_, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *videoPath = env-&gt;GetStringUTFChars(videoPath_, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *outPath = env-&gt;GetStringUTFChars(outPath_, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    av_register_all();</span><br><span class="line">    <span class="comment">//--------------------------------input init start---------------------------------------------</span></span><br><span class="line">    <span class="keyword">if</span> ((ret = avformat_open_input(&amp;ifmt_ctx_v, videoPath, <span class="number">0</span>, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;<span class="comment">//打开输入的视频文件</span></span><br><span class="line">        LOGD( <span class="string">"Could not open input video file."</span>);</span><br><span class="line">        <span class="keyword">goto</span> end;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">if</span> ((ret = avformat_find_stream_info(ifmt_ctx_v, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;<span class="comment">//获取视频文件信息</span></span><br><span class="line">        LOGD( <span class="string">"Failed to retrieve input video stream information"</span>);</span><br><span class="line">        <span class="keyword">goto</span> end;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((ret = avformat_open_input(&amp;ifmt_ctx_a, musicPath, <span class="number">0</span>, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;<span class="comment">//打开输入的音频文件</span></span><br><span class="line">        LOGD( <span class="string">"Could not open input audio file."</span>);</span><br><span class="line">        <span class="keyword">goto</span> end;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((ret = avformat_find_stream_info(ifmt_ctx_a, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;<span class="comment">//获取音频文件信息</span></span><br><span class="line">        LOGD( <span class="string">"Failed to retrieve input audio stream information"</span>);</span><br><span class="line">        <span class="keyword">goto</span> end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    LOGD("===========Input Information==========\n");</span></span><br><span class="line"><span class="comment">//    av_dump_format(ifmt_ctx_v, 0, videoPath, 0);</span></span><br><span class="line"><span class="comment">//    av_dump_format(ifmt_ctx_a, 0, musicPath, 0);</span></span><br><span class="line"><span class="comment">//    LOGD("======================================\n");</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//--------------------------------input init end---------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//--------------------------------out init start---------------------------------------------</span></span><br><span class="line">    <span class="comment">//初始化输出码流的AVFormatContext</span></span><br><span class="line">    avformat_alloc_output_context2(&amp;ofmt_ctx,<span class="literal">NULL</span>,<span class="literal">NULL</span>, outPath);</span><br><span class="line">    <span class="keyword">if</span>(!ofmt_ctx)&#123;</span><br><span class="line">        LOGD( <span class="string">"Could not create output context\n"</span>);</span><br><span class="line">        ret = AVERROR_UNKNOWN;</span><br><span class="line">        <span class="keyword">goto</span> end;</span><br><span class="line">    &#125;</span><br><span class="line">    ofmt = ofmt_ctx-&gt;oformat;</span><br><span class="line">    <span class="comment">//--------------------------------out init end-----------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//--------------------------------相关值获取-----------------------------------------------</span></span><br><span class="line">    <span class="comment">//从输入video的AVStream中获取一个video输出的out_stream</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ifmt_ctx_v-&gt;nb_streams; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ifmt_ctx_v-&gt;streams[i]-&gt;codecpar-&gt;codec_type==AVMEDIA_TYPE_VIDEO)&#123;</span><br><span class="line">            AVStream* in_stream = ifmt_ctx_v-&gt;streams[i];</span><br><span class="line">            AVCodec *dec = avcodec_find_decoder(in_stream-&gt;codecpar-&gt;codec_id);</span><br><span class="line">            <span class="keyword">if</span>(!dec)&#123;</span><br><span class="line">                LOGD( <span class="string">"Could not find decoder\n"</span>);</span><br><span class="line">                ret = AVERROR_UNKNOWN;</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">            &#125;</span><br><span class="line">            AVStream* out_stream = avformat_new_stream(ofmt_ctx,dec);</span><br><span class="line">            videoindex_v =i;</span><br><span class="line">            <span class="keyword">if</span>(!out_stream)&#123;</span><br><span class="line">                LOGD( <span class="string">"Failed allocating output stream\n"</span>);</span><br><span class="line">                ret = AVERROR_UNKNOWN;</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">            &#125;</span><br><span class="line">            videoindex_out=out_stream-&gt;index;</span><br><span class="line"></span><br><span class="line">            AVCodecContext* avCodecContext = avcodec_alloc_context3(dec);</span><br><span class="line">            <span class="keyword">if</span> ((ret =avcodec_parameters_to_context(avCodecContext, in_stream-&gt;codecpar)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                avcodec_free_context(&amp;avCodecContext);</span><br><span class="line">                avCodecContext = <span class="literal">NULL</span>;</span><br><span class="line">                LOGD(<span class="string">"can not fill decodecctx"</span>);</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">            &#125;</span><br><span class="line">            avCodecContext-&gt;codec_tag = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (ofmt_ctx-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER) &#123;</span><br><span class="line">                avCodecContext-&gt;flags |= CODEC_FLAG_GLOBAL_HEADER;</span><br><span class="line">            &#125;</span><br><span class="line">            ret = avcodec_parameters_from_context(out_stream-&gt;codecpar, avCodecContext);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Failed to copy context input to output stream codec context\n"</span>);</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从输入audio的AVStream中获取一个audio输出的out_stream</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ifmt_ctx_a-&gt;nb_streams; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ifmt_ctx_a-&gt;streams[i]-&gt;codecpar-&gt;codec_type==AVMEDIA_TYPE_AUDIO)&#123;</span><br><span class="line">            AVStream* in_stream = ifmt_ctx_a-&gt;streams[i];</span><br><span class="line">            AVCodec *dec = avcodec_find_decoder(in_stream-&gt;codecpar-&gt;codec_id);</span><br><span class="line">            <span class="keyword">if</span>(!dec)&#123;</span><br><span class="line">                LOGD( <span class="string">"Could not find decoder\n"</span>);</span><br><span class="line">                ret = AVERROR_UNKNOWN;</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">            &#125;</span><br><span class="line">            AVStream* out_stream = avformat_new_stream(ofmt_ctx,dec);</span><br><span class="line">            audioindex_a =i;</span><br><span class="line">            <span class="keyword">if</span>(!out_stream)&#123;</span><br><span class="line">                LOGD( <span class="string">"Failed allocating output stream\n"</span>);</span><br><span class="line">                ret = AVERROR_UNKNOWN;</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">            &#125;</span><br><span class="line">            audioindex_out=out_stream-&gt;index;</span><br><span class="line"></span><br><span class="line">            AVCodecContext* avCodecContext = avcodec_alloc_context3(dec);</span><br><span class="line">            <span class="keyword">if</span> ((ret =avcodec_parameters_to_context(avCodecContext, in_stream-&gt;codecpar)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                avcodec_free_context(&amp;avCodecContext);</span><br><span class="line">                avCodecContext = <span class="literal">NULL</span>;</span><br><span class="line">                LOGD(<span class="string">"can not fill decodecctx"</span>);</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">            &#125;</span><br><span class="line">            avCodecContext-&gt;codec_tag = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (ofmt_ctx-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER) &#123;</span><br><span class="line">                avCodecContext-&gt;flags |= CODEC_FLAG_GLOBAL_HEADER;</span><br><span class="line">            &#125;</span><br><span class="line">            ret = avcodec_parameters_from_context(out_stream-&gt;codecpar, avCodecContext);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Failed to copy context input to output stream codec context\n"</span>);</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    LOGD("==========Output Information==========\n");</span></span><br><span class="line"><span class="comment">//    av_dump_format(ofmt_ctx, 0, outPath, 1);</span></span><br><span class="line"><span class="comment">//    LOGD("======================================\n");</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//    -------------------------------合成文件-------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open output file</span></span><br><span class="line">    <span class="keyword">if</span> (!(ofmt-&gt;flags &amp; AVFMT_NOFILE)) &#123;</span><br><span class="line">        ret = avio_open(&amp;ofmt_ctx-&gt;pb, outPath, AVIO_FLAG_WRITE);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOGD(<span class="string">"Could not open output file %s "</span>, outPath);</span><br><span class="line">            <span class="keyword">goto</span> end;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write file header</span></span><br><span class="line">    ret = avformat_write_header(ofmt_ctx, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"Error occurred when opening output file\n"</span>);</span><br><span class="line">        <span class="keyword">goto</span> end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        AVFormatContext *ifmt_ctx;</span><br><span class="line">        <span class="keyword">int</span> stream_index=<span class="number">0</span>;</span><br><span class="line">        AVStream *in_stream, *out_stream;</span><br><span class="line">        AVPacket *pkt = av_packet_alloc();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Get an AVPacket .   av_compare_ts是比较时间戳用的。通过该函数可以决定该写入视频还是音频。</span></span><br><span class="line">        <span class="comment">//video 在 audio之前</span></span><br><span class="line">        <span class="keyword">if</span>(av_compare_ts(cur_pts_v,</span><br><span class="line">                         ifmt_ctx_v-&gt;streams[videoindex_v]-&gt;time_base,</span><br><span class="line">                         cur_pts_a,</span><br><span class="line">                         ifmt_ctx_a-&gt;streams[audioindex_a]-&gt;time_base) &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            ifmt_ctx=ifmt_ctx_v;</span><br><span class="line">            stream_index=videoindex_out;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            ifmt_ctx=ifmt_ctx_a;</span><br><span class="line">            stream_index=audioindex_out;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果video在audio之后</span></span><br><span class="line">        <span class="keyword">if</span>(av_compare_ts(cur_pts_v,</span><br><span class="line">                         ifmt_ctx_v-&gt;streams[videoindex_v]-&gt;time_base,</span><br><span class="line">                         cur_pts_a,</span><br><span class="line">                         ifmt_ctx_a-&gt;streams[audioindex_a]-&gt;time_base) &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            ifmt_ctx=ifmt_ctx_v;</span><br><span class="line">            stream_index=videoindex_out;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(av_read_frame(ifmt_ctx, pkt) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">do</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(pkt-&gt;stream_index==videoindex_v)&#123;</span><br><span class="line">                        in_stream  = ifmt_ctx-&gt;streams[pkt-&gt;stream_index];</span><br><span class="line">                        out_stream = ofmt_ctx-&gt;streams[stream_index];</span><br><span class="line">                        <span class="comment">//FIX：No PTS (Example: Raw H.264) H.264裸流没有PTS，因此必须手动写入PTS</span></span><br><span class="line">                        <span class="comment">//Simple Write PTS</span></span><br><span class="line">                        <span class="keyword">if</span>(pkt-&gt;pts==AV_NOPTS_VALUE)&#123;</span><br><span class="line">                            <span class="comment">//Write PTS</span></span><br><span class="line">                            AVRational time_base1=in_stream-&gt;time_base;</span><br><span class="line">                            <span class="comment">//Duration between 2 frames (us)</span></span><br><span class="line">                            <span class="keyword">int64_t</span> calc_duration=(<span class="keyword">double</span>)AV_TIME_BASE/av_q2d(in_stream-&gt;r_frame_rate);</span><br><span class="line">                            <span class="comment">//Parameters</span></span><br><span class="line">                            pkt-&gt;pts=(<span class="keyword">double</span>)(frame_index*calc_duration)/(<span class="keyword">double</span>)(av_q2d(time_base1)*AV_TIME_BASE);</span><br><span class="line">                            pkt-&gt;dts=pkt-&gt;pts;</span><br><span class="line">                            pkt-&gt;duration=(<span class="keyword">double</span>)calc_duration/(<span class="keyword">double</span>)(av_q2d(time_base1)*AV_TIME_BASE);</span><br><span class="line">                            frame_index++;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        cur_pts_v=pkt-&gt;pts;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">while</span>(av_read_frame(ifmt_ctx, pkt) &gt;= <span class="number">0</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                av_packet_free(&amp;pkt);</span><br><span class="line">                av_free(pkt);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            ifmt_ctx=ifmt_ctx_a;</span><br><span class="line">            stream_index=audioindex_out;</span><br><span class="line">            <span class="keyword">if</span>(av_read_frame(ifmt_ctx, pkt) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">do</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(pkt-&gt;stream_index==audioindex_a)&#123;</span><br><span class="line">                        in_stream  = ifmt_ctx-&gt;streams[pkt-&gt;stream_index];</span><br><span class="line">                        out_stream = ofmt_ctx-&gt;streams[stream_index];</span><br><span class="line">                        <span class="comment">//FIX：No PTS</span></span><br><span class="line">                        <span class="comment">//Simple Write PTS</span></span><br><span class="line">                        <span class="keyword">if</span>(pkt-&gt;pts==AV_NOPTS_VALUE)&#123;</span><br><span class="line">                            <span class="comment">//Write PTS</span></span><br><span class="line">                            AVRational time_base1=in_stream-&gt;time_base;</span><br><span class="line">                            <span class="comment">//Duration between 2 frames (us)</span></span><br><span class="line">                            <span class="keyword">int64_t</span> calc_duration=(<span class="keyword">double</span>)AV_TIME_BASE/av_q2d(in_stream-&gt;r_frame_rate);</span><br><span class="line">                            <span class="comment">//Parameters</span></span><br><span class="line">                            pkt-&gt;pts=(<span class="keyword">double</span>)(frame_index*calc_duration)/(<span class="keyword">double</span>)(av_q2d(time_base1)*AV_TIME_BASE);</span><br><span class="line">                            pkt-&gt;dts=pkt-&gt;pts;</span><br><span class="line">                            pkt-&gt;duration=(<span class="keyword">double</span>)calc_duration/(<span class="keyword">double</span>)(av_q2d(time_base1)*AV_TIME_BASE);</span><br><span class="line">                            frame_index++;</span><br><span class="line">                        &#125;</span><br><span class="line">                        cur_pts_a=pkt-&gt;pts;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">while</span>(av_read_frame(ifmt_ctx, pkt) &gt;= <span class="number">0</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                av_packet_free(&amp;pkt);</span><br><span class="line">                av_free(pkt);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Convert PTS/DTS</span></span><br><span class="line">        pkt-&gt;pts = av_rescale_q_rnd(pkt-&gt;pts, in_stream-&gt;time_base, out_stream-&gt;time_base, (AVRounding)(AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX));</span><br><span class="line">        pkt-&gt;dts = av_rescale_q_rnd(pkt-&gt;dts, in_stream-&gt;time_base, out_stream-&gt;time_base, (AVRounding)(AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX));</span><br><span class="line">        pkt-&gt;duration = av_rescale_q(pkt-&gt;duration, in_stream-&gt;time_base, out_stream-&gt;time_base);</span><br><span class="line">        pkt-&gt;pos = <span class="number">-1</span>;</span><br><span class="line">        pkt-&gt;stream_index=stream_index;</span><br><span class="line"></span><br><span class="line">        LOGD(<span class="string">"Write 1 Packet. size:%5d\tpts:%lld\n"</span>,pkt-&gt;size,pkt-&gt;pts);</span><br><span class="line">        <span class="comment">//Write AVPacket 音频或视频裸流</span></span><br><span class="line">        <span class="keyword">if</span> (av_interleaved_write_frame(ofmt_ctx, pkt) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOGD( <span class="string">"Error muxing packet\n"</span>);</span><br><span class="line">            av_packet_free(&amp;pkt);</span><br><span class="line">            av_free(pkt);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        av_packet_free(&amp;pkt);</span><br><span class="line">        av_free(pkt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Write file trailer</span></span><br><span class="line">    av_write_trailer(ofmt_ctx);</span><br><span class="line"></span><br><span class="line">end:</span><br><span class="line">    avformat_close_input(&amp;ifmt_ctx_v);</span><br><span class="line">    avformat_close_input(&amp;ifmt_ctx_a);</span><br><span class="line">    <span class="comment">/* close output */</span></span><br><span class="line">    <span class="keyword">if</span> (ofmt_ctx &amp;&amp; !(ofmt-&gt;flags &amp; AVFMT_NOFILE))</span><br><span class="line">        avio_close(ofmt_ctx-&gt;pb);</span><br><span class="line">    avformat_free_context(ofmt_ctx);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(musicPath_, musicPath);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(videoPath_, videoPath);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(outPath_, outPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/ffmpeg添加水印和滤镜效果.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/ffmpeg添加水印和滤镜效果.html" itemprop="url">ffmpeg添加水印和滤镜效果</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-27T11:12:37+08:00">
                2018-07-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ffmpeg/" itemprop="url" rel="index">
                    <span itemprop="name">ffmpeg</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/ffmpeg添加水印和滤镜效果.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/ffmpeg添加水印和滤镜效果.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,271字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>主要用到的api</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">avfilter_register_all()：注册所有AVFilter。</span><br><span class="line">avfilter_graph_alloc()：为FilterGraph分配内存。</span><br><span class="line">avfilter_graph_create_filter()：创建并向FilterGraph中添加一个Filter。</span><br><span class="line">avfilter_graph_parse_ptr()：将一串通过字符串描述的Graph添加到FilterGraph中。</span><br><span class="line">avfilter_graph_config()：检查FilterGraph的配置。</span><br><span class="line">av_buffersrc_add_frame()：向FilterGraph中加入一个AVFrame。</span><br><span class="line">av_buffersink_get_frame()：从FilterGraph中取出一个AVFrame。</span><br></pre></td></tr></table></figure>
<p>源代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/native_window.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/native_window_jni.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"libavcodec/avcodec.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"libavformat/avformat.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"libswscale/swscale.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"libavutil/imgutils.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//-----AVfilter-----</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavfilter/avfiltergraph.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavfilter/buffersrc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavfilter/buffersink.h&gt;</span></span></span><br><span class="line"><span class="comment">//-----AVfilter-----</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  LOG_TAG    <span class="meta-string">"JNI_TAG"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  LOGD(...)  __android_log_print(ANDROID_LOG_ERROR, LOG_TAG, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *filters_descr = <span class="string">"lutyuv='u=128:v=128'"</span>;</span><br><span class="line"><span class="comment">//const char *filters_descr = "hflip";</span></span><br><span class="line"><span class="comment">//const char *filters_descr = "hue='h=60:s=-3'";</span></span><br><span class="line"><span class="comment">//const char *filters_descr = "crop=2/3*in_w:2/3*in_h";</span></span><br><span class="line"><span class="comment">//const char *filters_descr = "drawbox=x=200:y=200:w=300:h=300:color=pink@0.5";</span></span><br><span class="line"><span class="comment">//const char *filters_descr = "movie=/storage/emulated/0/shuiyin.png[wm];[in][wm]overlay=5:5[out]";</span></span><br><span class="line"><span class="comment">//const char *filters_descr="drawgrid=width=100:height=100:thickness=4:color=pink@0.9";</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCodecContext</span><span class="params">(AVCodecParameters *codecpar, AVCodecContext **avCodecContext)</span> </span>&#123;</span><br><span class="line">    AVCodec *dec = avcodec_find_decoder(codecpar-&gt;codec_id);</span><br><span class="line">    <span class="keyword">if</span> (!dec) &#123;</span><br><span class="line">        LOGD(<span class="string">"can not find decoder"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *avCodecContext = avcodec_alloc_context3(dec);</span><br><span class="line">    <span class="keyword">if</span> (!*avCodecContext) &#123;</span><br><span class="line">        LOGD(<span class="string">"can not alloc new decodecctx"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (avcodec_parameters_to_context(*avCodecContext, codecpar) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        avcodec_free_context(avCodecContext);</span><br><span class="line">        *avCodecContext = <span class="literal">NULL</span>;</span><br><span class="line">        LOGD(<span class="string">"can not fill decodecctx"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (avcodec_open2(*avCodecContext, dec, <span class="number">0</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"cant not open audio strames"</span>);</span><br><span class="line">        avcodec_free_context(avCodecContext);</span><br><span class="line">        *avCodecContext = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_zzw_ffmpegdemo_FFmpegHelper_play(JNIEnv *env, jobject instance, jstring url_,</span><br><span class="line">                                          jobject surface) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *url = env-&gt;GetStringUTFChars(url_, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    AVFormatContext *pFormatCtx = <span class="literal">NULL</span>;</span><br><span class="line">    AVCodecContext *pCodecCtx = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    AVFilterContext *buffersink_ctx = <span class="literal">NULL</span>;</span><br><span class="line">    AVFilterContext *buffersrc_ctx = <span class="literal">NULL</span>;</span><br><span class="line">    AVFilterGraph *filter_graph = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-----------------------------AVCodecContext init start----------------------------</span></span><br><span class="line">    av_register_all();</span><br><span class="line">    avfilter_register_all();<span class="comment">//</span></span><br><span class="line">    pFormatCtx = avformat_alloc_context();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open video file</span></span><br><span class="line">    <span class="keyword">if</span> (avformat_open_input(&amp;pFormatCtx, url, <span class="literal">NULL</span>, <span class="literal">NULL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        LOGD(<span class="string">"Couldn't open url:%s\n"</span>, url);</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">// Couldn't open file</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Retrieve stream information</span></span><br><span class="line">    <span class="keyword">if</span> (avformat_find_stream_info(pFormatCtx, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"Couldn't find stream information."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the first video stream</span></span><br><span class="line">    <span class="keyword">int</span> videoStream = <span class="number">-1</span>, i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pFormatCtx-&gt;nb_streams; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pFormatCtx-&gt;streams[i]-&gt;codecpar-&gt;codec_type == AVMEDIA_TYPE_VIDEO</span><br><span class="line">            &amp;&amp; videoStream &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            videoStream = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (videoStream == <span class="number">-1</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"Didn't find a video stream."</span>);</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">// Didn't find a video stream</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getCodecContext(pFormatCtx-&gt;streams[videoStream]-&gt;codecpar, &amp;pCodecCtx) != <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"Didn't get CodecContext."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//-----------------------------AVCodecContext init end-------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//------------------------------filter init start------------------------------------</span></span><br><span class="line">    <span class="keyword">char</span> args[<span class="number">512</span>];</span><br><span class="line">    AVFilter *buffersrc = avfilter_get_by_name(<span class="string">"buffer"</span>);</span><br><span class="line">    AVFilter *buffersink = avfilter_get_by_name(<span class="string">"buffersink"</span>);<span class="comment">//新版的ffmpeg库必须为buffersink</span></span><br><span class="line">    AVFilterInOut *outputs = avfilter_inout_alloc();</span><br><span class="line">    AVFilterInOut *inputs = avfilter_inout_alloc();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> AVPixelFormat pix_fmts[] = &#123;AV_PIX_FMT_YUV420P, AV_PIX_FMT_NONE&#125;;</span><br><span class="line"></span><br><span class="line">    filter_graph = avfilter_graph_alloc();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* buffer video source: the decoded frames from the decoder will be inserted here. */</span></span><br><span class="line">    <span class="built_in">snprintf</span>(args, <span class="keyword">sizeof</span>(args),</span><br><span class="line">             <span class="string">"video_size=%dx%d:pix_fmt=%d:time_base=%d/%d:pixel_aspect=%d/%d"</span>,</span><br><span class="line">             pCodecCtx-&gt;width, pCodecCtx-&gt;height, pCodecCtx-&gt;pix_fmt,</span><br><span class="line">             pFormatCtx-&gt;streams[videoStream]-&gt;time_base.num,</span><br><span class="line">             pFormatCtx-&gt;streams[videoStream]-&gt;time_base.den,</span><br><span class="line">             pCodecCtx-&gt;sample_aspect_ratio.num, pCodecCtx-&gt;sample_aspect_ratio.den);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (avfilter_graph_create_filter(&amp;buffersrc_ctx, buffersrc, <span class="string">"in"</span>,</span><br><span class="line">                                     args, <span class="literal">NULL</span>, filter_graph) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"Cannot create buffer source\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    AVBufferSinkParams *buffersink_params = av_buffersink_params_alloc();</span><br><span class="line">    buffersink_params-&gt;pixel_fmts = pix_fmts;</span><br><span class="line">    <span class="keyword">if</span> (avfilter_graph_create_filter(&amp;buffersink_ctx, buffersink, <span class="string">"out"</span>,</span><br><span class="line">                                     <span class="literal">NULL</span>, buffersink_params, filter_graph) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"Cannot create buffer sink\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    av_free(buffersink_params);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Endpoints for the filter graph. */</span></span><br><span class="line">    outputs-&gt;name = av_strdup(<span class="string">"in"</span>);</span><br><span class="line">    outputs-&gt;filter_ctx = buffersrc_ctx;</span><br><span class="line">    outputs-&gt;pad_idx = <span class="number">0</span>;</span><br><span class="line">    outputs-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    inputs-&gt;name = av_strdup(<span class="string">"out"</span>);</span><br><span class="line">    inputs-&gt;filter_ctx = buffersink_ctx;</span><br><span class="line">    inputs-&gt;pad_idx = <span class="number">0</span>;</span><br><span class="line">    inputs-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((avfilter_graph_parse_ptr(filter_graph, filters_descr,</span><br><span class="line">                                  &amp;inputs, &amp;outputs, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"Cannot avfilter_graph_parse_ptr\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((avfilter_graph_config(filter_graph, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"Cannot avfilter_graph_config\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//------------------------------filter init end------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//------------------------------window init start-----------------------------------</span></span><br><span class="line">    <span class="comment">// 获取native window</span></span><br><span class="line">    ANativeWindow *nativeWindow = ANativeWindow_fromSurface(env, surface);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取视频宽高</span></span><br><span class="line">    <span class="keyword">int</span> videoWidth = pCodecCtx-&gt;width;</span><br><span class="line">    <span class="keyword">int</span> videoHeight = pCodecCtx-&gt;height;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置native window的buffer大小,可自动拉伸</span></span><br><span class="line">    ANativeWindow_setBuffersGeometry(nativeWindow, videoWidth, videoHeight,</span><br><span class="line">                                     WINDOW_FORMAT_RGBA_8888);</span><br><span class="line">    ANativeWindow_Buffer windowBuffer;</span><br><span class="line">    <span class="comment">//------------------------------window init end-----------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//------------------------------get data-----------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于渲染</span></span><br><span class="line">    AVFrame *pFrameRGBA = av_frame_alloc();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine required buffer size and allocate buffer</span></span><br><span class="line">    <span class="comment">// buffer中数据就是用于渲染的,且格式为RGBA</span></span><br><span class="line">    <span class="keyword">int</span> numBytes = av_image_get_buffer_size(AV_PIX_FMT_RGBA, pCodecCtx-&gt;width, pCodecCtx-&gt;height,</span><br><span class="line">                                            <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">uint8_t</span> *buffer = (<span class="keyword">uint8_t</span> *) av_malloc(numBytes * <span class="keyword">sizeof</span>(<span class="keyword">uint8_t</span>));</span><br><span class="line">    av_image_fill_arrays(pFrameRGBA-&gt;data, pFrameRGBA-&gt;linesize, buffer, AV_PIX_FMT_RGBA,</span><br><span class="line">                         pCodecCtx-&gt;width, pCodecCtx-&gt;height, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由于解码出来的帧格式不是RGBA的,在渲染之前需要进行格式转换</span></span><br><span class="line">    SwsContext *sws_ctx = sws_getContext(pCodecCtx-&gt;width,</span><br><span class="line">                                         pCodecCtx-&gt;height,</span><br><span class="line">                                         pCodecCtx-&gt;pix_fmt,</span><br><span class="line">                                         pCodecCtx-&gt;width,</span><br><span class="line">                                         pCodecCtx-&gt;height,</span><br><span class="line">                                         AV_PIX_FMT_RGBA,</span><br><span class="line">                                         SWS_BILINEAR,</span><br><span class="line">                                         <span class="literal">NULL</span>,</span><br><span class="line">                                         <span class="literal">NULL</span>,</span><br><span class="line">                                         <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    AVPacket *packet = av_packet_alloc();</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (av_read_frame(pFormatCtx, packet) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Is this a packet from the video stream?</span></span><br><span class="line">        <span class="keyword">if</span> (packet-&gt;stream_index == videoStream) &#123;</span><br><span class="line">            <span class="comment">// Decode video frame</span></span><br><span class="line">            <span class="keyword">if</span> (avcodec_send_packet(pCodecCtx, packet) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            AVFrame *pFrame = av_frame_alloc();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (avcodec_receive_frame(pCodecCtx, pFrame) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// lock native window buffer</span></span><br><span class="line">                ANativeWindow_lock(nativeWindow, &amp;windowBuffer, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//for AVfilter start</span></span><br><span class="line">                pFrame-&gt;pts = av_frame_get_best_effort_timestamp(pFrame);</span><br><span class="line">                <span class="comment">//* push the decoded frame into the filtergraph</span></span><br><span class="line">                <span class="keyword">if</span> (av_buffersrc_add_frame(buffersrc_ctx, pFrame) == <span class="number">0</span>) &#123;</span><br><span class="line">                    av_buffersink_get_frame(buffersink_ctx, pFrame);</span><br><span class="line">                &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                    LOGD(<span class="string">"Could not av_buffersrc_add_frame"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 格式转换</span></span><br><span class="line">                sws_scale(sws_ctx, (<span class="keyword">uint8_t</span> <span class="keyword">const</span> *<span class="keyword">const</span> *) pFrame-&gt;data,</span><br><span class="line">                          pFrame-&gt;linesize, <span class="number">0</span>, pCodecCtx-&gt;height,</span><br><span class="line">                          pFrameRGBA-&gt;data, pFrameRGBA-&gt;linesize);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取stride</span></span><br><span class="line">                <span class="keyword">uint8_t</span> *dst = (<span class="keyword">uint8_t</span> *) windowBuffer.bits;</span><br><span class="line">                <span class="keyword">int</span> dstStride = windowBuffer.stride * <span class="number">4</span>;</span><br><span class="line">                <span class="keyword">uint8_t</span> *src = (pFrameRGBA-&gt;data[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">int</span> srcStride = pFrameRGBA-&gt;linesize[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 由于window的stride和帧的stride不同,因此需要逐行复制</span></span><br><span class="line">                <span class="keyword">int</span> h;</span><br><span class="line">                <span class="keyword">for</span> (h = <span class="number">0</span>; h &lt; videoHeight; h++) &#123;</span><br><span class="line">                    <span class="built_in">memcpy</span>(dst + h * dstStride, src + h * srcStride, srcStride);</span><br><span class="line">                &#125;</span><br><span class="line">                ANativeWindow_unlockAndPost(nativeWindow);</span><br><span class="line"></span><br><span class="line">                count++;</span><br><span class="line">                LOGD(<span class="string">"解码渲染%d帧"</span>, count);</span><br><span class="line">            &#125;</span><br><span class="line">            av_frame_free(&amp;pFrame);</span><br><span class="line">            av_free(pFrame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ANativeWindow_release(nativeWindow);</span><br><span class="line">    av_packet_free(&amp;packet);</span><br><span class="line">    sws_freeContext(sws_ctx);</span><br><span class="line"></span><br><span class="line">    avfilter_inout_free(&amp;outputs);</span><br><span class="line">    av_free(outputs);</span><br><span class="line">    avfilter_inout_free(&amp;inputs);</span><br><span class="line">    av_free(inputs);</span><br><span class="line"></span><br><span class="line">    av_free(buffer);</span><br><span class="line">    av_frame_free(&amp;pFrameRGBA);</span><br><span class="line">    av_free(pFrameRGBA);</span><br><span class="line"></span><br><span class="line">    avfilter_graph_free(&amp;filter_graph); <span class="comment">//for avfilter</span></span><br><span class="line">    <span class="comment">// Close the codecs</span></span><br><span class="line">    avcodec_close(pCodecCtx);</span><br><span class="line">    avcodec_free_context(&amp;pCodecCtx);</span><br><span class="line">    pCodecCtx = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Close the video file</span></span><br><span class="line">    avformat_close_input(&amp;pFormatCtx);</span><br><span class="line">    avformat_free_context(pFormatCtx);</span><br><span class="line">    pFormatCtx = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    env-&gt;ReleaseStringUTFChars(url_, url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更多的特效使用： <a href="http://www.ffmpeg.org/ffmpeg-filters.html" target="_blank" rel="noopener">http://www.ffmpeg.org/ffmpeg-filters.html</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android OpenGLES渲染MediaCodec解码数据.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android OpenGLES渲染MediaCodec解码数据.html" itemprop="url">Android OpenGLES渲染MediaCodec解码数据</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-16T11:32:31+08:00">
                2018-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android OpenGLES渲染MediaCodec解码数据.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android OpenGLES渲染MediaCodec解码数据.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  764字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>1、OpenGL生成纹理<br>2、纹理绑定到SurfaceTexture上<br>3、用SurfaceTexture做参数创建Surface<br>4、MediaCodec解码的视频就往Surface发送，就显示出画面了</p>
</blockquote>
<ul>
<li>Shader编写</li>
</ul>
<p>vertex_shader.glsl<br><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">attribute</span> <span class="type">vec4</span> av_Position;</span><br><span class="line"><span class="keyword">attribute</span> <span class="type">vec2</span> af_Position;</span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec2</span> v_texPosition;</span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    v_texPosition = af_Position;</span><br><span class="line">    <span class="built_in">gl_Position</span> = av_Position;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>fragment_mediacodec.glsl</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#extension GL_OES_EGL_image_external : require</span></span><br><span class="line"><span class="keyword">precision</span> <span class="keyword">mediump</span> <span class="type">float</span>;</span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec2</span> v_texPosition;</span><br><span class="line"><span class="comment">//samplerExternalOES渲染视频</span></span><br><span class="line"><span class="keyword">uniform</span> samplerExternalOES sTexture;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    <span class="built_in">gl_FragColor</span>=<span class="built_in">texture2D</span>(sTexture, v_texPosition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VideoRender.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.SurfaceTexture;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES11Ext;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLSurfaceView;</span><br><span class="line"><span class="keyword">import</span> android.view.Surface;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteOrder;</span><br><span class="line"><span class="keyword">import</span> java.nio.FloatBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.egl.EGLConfig;</span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.opengles.GL10;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoRender</span> <span class="keyword">implements</span> <span class="title">GLSurfaceView</span>.<span class="title">Renderer</span>, <span class="title">SurfaceTexture</span>.<span class="title">OnFrameAvailableListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span>[] vertexData = &#123;</span><br><span class="line">            -<span class="number">1f</span>, -<span class="number">1f</span>,</span><br><span class="line">            <span class="number">1f</span>, -<span class="number">1f</span>,</span><br><span class="line">            -<span class="number">1f</span>, <span class="number">1f</span>,</span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span></span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span>[] textureData = &#123;</span><br><span class="line">            <span class="number">0f</span>, <span class="number">1f</span>,</span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>,</span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>,</span><br><span class="line">            <span class="number">1f</span>, <span class="number">0f</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer vertexBuffer;</span><br><span class="line">    <span class="keyword">private</span> FloatBuffer textureBuffer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//mediacodec</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> program_mediacodec;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> avPosition_mediacodec;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> afPosition_mediacodec;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> samplerOES_mediacodec;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> textureId_mediacodec;</span><br><span class="line">    <span class="keyword">private</span> SurfaceTexture surfaceTexture;</span><br><span class="line">    <span class="keyword">private</span> Surface surface;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OnSurfaceCreateListener onSurfaceCreateListener;</span><br><span class="line">    <span class="keyword">private</span> OnRenderListener onRenderListener;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VideoRender</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        vertexBuffer = ByteBuffer.allocateDirect(vertexData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(vertexData);</span><br><span class="line">        vertexBuffer.position(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        textureBuffer = ByteBuffer.allocateDirect(textureData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(textureData);</span><br><span class="line">        textureBuffer.position(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnSurfaceCreateListener</span><span class="params">(OnSurfaceCreateListener onSurfaceCreateListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.onSurfaceCreateListener = onSurfaceCreateListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnRenderListener</span><span class="params">(OnRenderListener onRenderListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.onRenderListener = onRenderListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">(GL10 gl, EGLConfig config)</span> </span>&#123;</span><br><span class="line">        initRenderMediacodec();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(GL10 gl, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        GLES20.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">(GL10 gl)</span> </span>&#123;</span><br><span class="line">        GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT);</span><br><span class="line">        GLES20.glClearColor(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">        renderMediacodec();</span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFrameAvailable</span><span class="params">(SurfaceTexture surfaceTexture)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (onRenderListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">////将onFrameAvailable函数回掉到GLSurfaceView调用requestRender()触发onDrawFrame()</span></span><br><span class="line">            onRenderListener.onRender();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initRenderMediacodec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String vertexSource = ShaderUtil.readRawTxt(context, R.raw.vertex_shader);</span><br><span class="line">        String fragmentSource = ShaderUtil.readRawTxt(context, R.raw.fragment_mediacodec);</span><br><span class="line">        program_mediacodec = ShaderUtil.createProgram(vertexSource, fragmentSource);</span><br><span class="line"></span><br><span class="line">        avPosition_mediacodec = GLES20.glGetAttribLocation(program_mediacodec, <span class="string">"av_Position"</span>);</span><br><span class="line">        afPosition_mediacodec = GLES20.glGetAttribLocation(program_mediacodec, <span class="string">"af_Position"</span>);</span><br><span class="line">        samplerOES_mediacodec = GLES20.glGetUniformLocation(program_mediacodec, <span class="string">"sTexture"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] textureids = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        GLES20.glGenTextures(<span class="number">1</span>, textureids, <span class="number">0</span>);</span><br><span class="line">        textureId_mediacodec = textureids[<span class="number">0</span>];</span><br><span class="line">            </span><br><span class="line">        GLES20.glTexParameteri(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_REPEAT);</span><br><span class="line">        GLES20.glTexParameteri(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_REPEAT);</span><br><span class="line">        GLES20.glTexParameteri(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">        GLES20.glTexParameteri(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</span><br><span class="line"></span><br><span class="line">        surfaceTexture = <span class="keyword">new</span> SurfaceTexture(textureId_mediacodec);</span><br><span class="line">        surface = <span class="keyword">new</span> Surface(surfaceTexture);</span><br><span class="line">        surfaceTexture.setOnFrameAvailableListener(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (onSurfaceCreateListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//将Surface回掉出去给MediaCodec绑定渲染</span></span><br><span class="line">            onSurfaceCreateListener.onSurfaceCreate(surface);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">renderMediacodec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        surfaceTexture.updateTexImage();</span><br><span class="line">        GLES20.glUseProgram(program_mediacodec);</span><br><span class="line"></span><br><span class="line">        GLES20.glEnableVertexAttribArray(avPosition_mediacodec);</span><br><span class="line">        GLES20.glVertexAttribPointer(avPosition_mediacodec, <span class="number">2</span>, GLES20.GL_FLOAT, <span class="keyword">false</span>, <span class="number">8</span>, vertexBuffer);</span><br><span class="line"></span><br><span class="line">        GLES20.glEnableVertexAttribArray(afPosition_mediacodec);</span><br><span class="line">        GLES20.glVertexAttribPointer(afPosition_mediacodec, <span class="number">2</span>, GLES20.GL_FLOAT, <span class="keyword">false</span>, <span class="number">8</span>, textureBuffer);</span><br><span class="line"></span><br><span class="line">        GLES20.glActiveTexture(GLES20.GL_TEXTURE0);</span><br><span class="line">        GLES20.glBindTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, textureId_mediacodec);</span><br><span class="line">        GLES20.glUniform1i(samplerOES_mediacodec, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnSurfaceCreateListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSurfaceCreate</span><span class="params">(Surface surface)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnRenderListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onRender</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>VideoGLSurfaceView.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLSurfaceView;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoGLSurfaceView</span> <span class="keyword">extends</span> <span class="title">GLSurfaceView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> VideoRender render;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VideoGLSurfaceView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VideoGLSurfaceView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        setEGLContextClientVersion(<span class="number">2</span>);</span><br><span class="line">        render = <span class="keyword">new</span> VideoRender(context);</span><br><span class="line">        setRenderer(render);</span><br><span class="line">        setRenderMode(GLSurfaceView.RENDERMODE_WHEN_DIRTY);</span><br><span class="line"></span><br><span class="line">        render.setOnRenderListener(<span class="keyword">new</span> VideoRender.OnRenderListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                requestRender();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> VideoRender <span class="title">getWlRender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> render;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android OpenGLES绘制yuv420纹理.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android OpenGLES绘制yuv420纹理.html" itemprop="url">Android OpenGLES绘制yuv420纹理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-16T11:30:16+08:00">
                2018-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android OpenGLES绘制yuv420纹理.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android OpenGLES绘制yuv420纹理.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,738字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  10分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>把shader代码写入raw里面</li>
</ol>
<p>vertex_shader.glsl<br><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">attribute</span> <span class="type">vec4</span> av_Position;<span class="comment">//顶点位置</span></span><br><span class="line"><span class="keyword">attribute</span> <span class="type">vec2</span> af_Position;<span class="comment">//纹理位置</span></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec2</span> v_texPo;<span class="comment">//纹理位置  与fragment_shader交互</span></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    v_texPo = af_Position;</span><br><span class="line">    <span class="built_in">gl_Position</span> = av_Position;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>fragment_shader.glsl</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">precision</span> <span class="keyword">mediump</span> <span class="type">float</span>;<span class="comment">//精度 为float</span></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec2</span> v_texPo;<span class="comment">//纹理位置  接收于vertex_shader</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> sampler_y;<span class="comment">//纹理y</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> sampler_u;<span class="comment">//纹理u</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> sampler_v;<span class="comment">//纹理v</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    <span class="comment">//yuv420-&gt;rgb</span></span><br><span class="line">    <span class="type">float</span> y,u,v;</span><br><span class="line">    y = <span class="built_in">texture2D</span>(sampler_y,v_texPo).r;</span><br><span class="line">    u = <span class="built_in">texture2D</span>(sampler_u,v_texPo).r- <span class="number">0.5</span>;</span><br><span class="line">    v = <span class="built_in">texture2D</span>(sampler_v,v_texPo).r- <span class="number">0.5</span>;</span><br><span class="line">    <span class="type">vec3</span> rgb;</span><br><span class="line">    rgb.r = y + <span class="number">1.403</span> * v;</span><br><span class="line">    rgb.g = y - <span class="number">0.344</span> * u - <span class="number">0.714</span> * v;</span><br><span class="line">    rgb.b = y + <span class="number">1.770</span> * u;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">gl_FragColor</span>=<span class="type">vec4</span>(rgb,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为<code>OpenGLES</code>需要用<code>rgb</code>来加载显示，这里就需要将<code>yuv</code>转<code>rgb</code>，这里放在<code>OpenGL</code>里面转换，<code>OpenGL</code>里面使用<code>GPU</code>,提高性能。</p>
<ol start="2">
<li>数据写入</li>
</ol>
<p>YUV420Texture.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteOrder;</span><br><span class="line"><span class="keyword">import</span> java.nio.FloatBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YUV420Texture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//顶点坐标</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> vertexData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            -<span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            -<span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//纹理坐标</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> textureData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每一次取点的时候取几个点</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COORDS_PER_VERTEX = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexCount = vertexData.length / COORDS_PER_VERTEX;</span><br><span class="line">    <span class="comment">//每一次取的总的点 大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexStride = COORDS_PER_VERTEX * <span class="number">4</span>; <span class="comment">// 4 bytes per vertex</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//位置</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer vertexBuffer;</span><br><span class="line">    <span class="comment">//纹理</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer textureBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> program;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//顶点位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> avPosition;</span><br><span class="line">    <span class="comment">//纹理位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> afPosition;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//shader  yuv变量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> sampler_y;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> sampler_u;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> sampler_v;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] textureId_yuv;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//YUV数据</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> width_yuv;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> height_yuv;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer y;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer u;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer v;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">YUV420Texture</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line"></span><br><span class="line">        vertexBuffer = ByteBuffer.allocateDirect(vertexData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(vertexData);</span><br><span class="line">        vertexBuffer.position(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        textureBuffer = ByteBuffer.allocateDirect(textureData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(textureData);</span><br><span class="line">        textureBuffer.position(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initYUV</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String vertexSource = ShaderUtil.readRawTxt(context, R.raw.vertex_shader);</span><br><span class="line">        String fragmentSource = ShaderUtil.readRawTxt(context, R.raw.fragment_shader);</span><br><span class="line">        program = ShaderUtil.createProgram(vertexSource, fragmentSource);</span><br><span class="line">        <span class="keyword">if</span> (program &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//获取顶点坐标字段</span></span><br><span class="line">            avPosition = GLES20.glGetAttribLocation(program, <span class="string">"av_Position"</span>);</span><br><span class="line">            <span class="comment">//获取纹理坐标字段</span></span><br><span class="line">            afPosition = GLES20.glGetAttribLocation(program, <span class="string">"af_Position"</span>);</span><br><span class="line">            <span class="comment">//获取yuv字段</span></span><br><span class="line">            sampler_y = GLES20.glGetUniformLocation(program, <span class="string">"sampler_y"</span>);</span><br><span class="line">            sampler_u = GLES20.glGetUniformLocation(program, <span class="string">"sampler_u"</span>);</span><br><span class="line">            sampler_v = GLES20.glGetUniformLocation(program, <span class="string">"sampler_v"</span>);</span><br><span class="line"></span><br><span class="line">            textureId_yuv = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line">            <span class="comment">//创建3个纹理</span></span><br><span class="line">            GLES20.glGenTextures(<span class="number">3</span>, textureId_yuv, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//绑定纹理</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> id : textureId_yuv) &#123;</span><br><span class="line">                GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, id);</span><br><span class="line">                <span class="comment">//环绕（超出纹理坐标范围）  （s==x t==y GL_REPEAT 重复）</span></span><br><span class="line">                GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_REPEAT);</span><br><span class="line">                GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_REPEAT);</span><br><span class="line">                <span class="comment">//过滤（纹理像素映射到坐标点）  （缩小、放大：GL_LINEAR线性）</span></span><br><span class="line">                GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">                GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setYUVData</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">byte</span>[] y, <span class="keyword">byte</span>[] u, <span class="keyword">byte</span>[] v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.width_yuv = width;</span><br><span class="line">        <span class="keyword">this</span>.height_yuv = height;</span><br><span class="line">        <span class="keyword">this</span>.y = ByteBuffer.wrap(y);</span><br><span class="line">        <span class="keyword">this</span>.u = ByteBuffer.wrap(u);</span><br><span class="line">        <span class="keyword">this</span>.v = ByteBuffer.wrap(v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (width_yuv &gt; <span class="number">0</span> &amp;&amp; height_yuv &gt; <span class="number">0</span> &amp;&amp; y != <span class="keyword">null</span> &amp;&amp; u != <span class="keyword">null</span> &amp;&amp; v != <span class="keyword">null</span>) &#123;</span><br><span class="line">            GLES20.glUseProgram(program);</span><br><span class="line">            GLES20.glEnableVertexAttribArray(avPosition);</span><br><span class="line">            GLES20.glVertexAttribPointer(avPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, vertexBuffer);</span><br><span class="line"></span><br><span class="line">            GLES20.glEnableVertexAttribArray(afPosition);</span><br><span class="line">            GLES20.glVertexAttribPointer(afPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, textureBuffer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//激活纹理0来绑定y数据</span></span><br><span class="line">            GLES20.glActiveTexture(GLES20.GL_TEXTURE0);</span><br><span class="line">            GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureId_yuv[<span class="number">0</span>]);</span><br><span class="line">            <span class="comment">//glTexImage2D (int target,</span></span><br><span class="line">            <span class="comment">//                int level,</span></span><br><span class="line">            <span class="comment">//                int internalformat,</span></span><br><span class="line">            <span class="comment">//                int width,</span></span><br><span class="line">            <span class="comment">//                int height,</span></span><br><span class="line">            <span class="comment">//                int border,</span></span><br><span class="line">            <span class="comment">//                int format,</span></span><br><span class="line">            <span class="comment">//                int type,</span></span><br><span class="line">            <span class="comment">//                Buffer pixels)</span></span><br><span class="line">            GLES20.glTexImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, GLES20.GL_LUMINANCE, width_yuv, height_yuv, <span class="number">0</span>, GLES20.GL_LUMINANCE, GLES20.GL_UNSIGNED_BYTE, y);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//激活纹理1来绑定u数据</span></span><br><span class="line">            GLES20.glActiveTexture(GLES20.GL_TEXTURE1);</span><br><span class="line">            GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureId_yuv[<span class="number">1</span>]);</span><br><span class="line">            GLES20.glTexImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, GLES20.GL_LUMINANCE, width_yuv / <span class="number">2</span>, height_yuv / <span class="number">2</span>, <span class="number">0</span>, GLES20.GL_LUMINANCE, GLES20.GL_UNSIGNED_BYTE, u);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//激活纹理2来绑定u数据</span></span><br><span class="line">            GLES20.glActiveTexture(GLES20.GL_TEXTURE2);</span><br><span class="line">            GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureId_yuv[<span class="number">2</span>]);</span><br><span class="line">            GLES20.glTexImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, GLES20.GL_LUMINANCE, width_yuv / <span class="number">2</span>, height_yuv / <span class="number">2</span>, <span class="number">0</span>, GLES20.GL_LUMINANCE, GLES20.GL_UNSIGNED_BYTE, v);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//给fragment_shader里面yuv变量设置值   0 1 2 标识纹理x</span></span><br><span class="line">            GLES20.glUniform1i(sampler_y, <span class="number">0</span>);</span><br><span class="line">            GLES20.glUniform1i(sampler_u, <span class="number">1</span>);</span><br><span class="line">            GLES20.glUniform1i(sampler_v, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//绘制</span></span><br><span class="line">            GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="number">0</span>, vertexCount);</span><br><span class="line"></span><br><span class="line">            y.clear();</span><br><span class="line">            u.clear();</span><br><span class="line">            v.clear();</span><br><span class="line">            y = <span class="keyword">null</span>;</span><br><span class="line">            u = <span class="keyword">null</span>;</span><br><span class="line">            v = <span class="keyword">null</span>;</span><br><span class="line">            GLES20.glDisableVertexAttribArray(afPosition);</span><br><span class="line">            GLES20.glDisableVertexAttribArray(avPosition);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ShaderUtil.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShaderUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ShaderUtil"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readRawTxt</span><span class="params">(Context context, <span class="keyword">int</span> rawId)</span> </span>&#123;</span><br><span class="line">        InputStream inputStream = context.getResources().openRawResource(rawId);</span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream));</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sb.append(line).append(<span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            reader.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">loadShader</span><span class="params">(<span class="keyword">int</span> shaderType, String source)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// create a vertex shader type (GLES20.GL_VERTEX_SHADER)</span></span><br><span class="line">        <span class="comment">// or a fragment shader type (GLES20.GL_FRAGMENT_SHADER)</span></span><br><span class="line">        <span class="keyword">int</span> shader = GLES20.glCreateShader(shaderType);</span><br><span class="line">        <span class="keyword">if</span> (shader != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//添加代码到shader</span></span><br><span class="line">            GLES20.glShaderSource(shader, source);</span><br><span class="line">            <span class="comment">//编译shader</span></span><br><span class="line">            GLES20.glCompileShader(shader);</span><br><span class="line">            <span class="keyword">int</span>[] compile = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//检测是否编译成功</span></span><br><span class="line">            GLES20.glGetShaderiv(shader, GLES20.GL_COMPILE_STATUS, compile, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (compile[<span class="number">0</span>] != GLES20.GL_TRUE) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"shader compile error"</span>);</span><br><span class="line">                GLES20.glDeleteShader(shader);</span><br><span class="line">                shader = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> shader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">createProgram</span><span class="params">(String vertexSource, String fragmentSource)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取vertex shader</span></span><br><span class="line">        <span class="keyword">int</span> vertexShader = loadShader(GLES20.GL_VERTEX_SHADER, vertexSource);</span><br><span class="line">        <span class="keyword">if</span> (vertexShader == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取fragment shader</span></span><br><span class="line">        <span class="keyword">int</span> fragmentShader = loadShader(GLES20.GL_FRAGMENT_SHADER, fragmentSource);</span><br><span class="line">        <span class="keyword">if</span> (fragmentShader == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建一个空的渲染程序</span></span><br><span class="line">        <span class="keyword">int</span> program = GLES20.glCreateProgram();</span><br><span class="line">        <span class="keyword">if</span> (program != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//添加vertexShader到渲染程序</span></span><br><span class="line">            GLES20.glAttachShader(program, vertexShader);</span><br><span class="line">            <span class="comment">//添加fragmentShader到渲染程序</span></span><br><span class="line">            GLES20.glAttachShader(program, fragmentShader);</span><br><span class="line">            <span class="comment">//关联为可执行渲染程序</span></span><br><span class="line">            GLES20.glLinkProgram(program);</span><br><span class="line">            <span class="keyword">int</span>[] linsStatus = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//检测是否关联成功</span></span><br><span class="line">            GLES20.glGetProgramiv(program, GLES20.GL_LINK_STATUS, linsStatus, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (linsStatus[<span class="number">0</span>] != GLES20.GL_TRUE) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"link program error"</span>);</span><br><span class="line">                GLES20.glDeleteProgram(program);</span><br><span class="line">                program = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> program;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="3">
<li>Render书写<br>MyRender.java</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLSurfaceView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.egl.EGLConfig;</span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.opengles.GL10;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRender</span> <span class="keyword">implements</span> <span class="title">GLSurfaceView</span>.<span class="title">Renderer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> YUV420Texture yuv420Texture;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRender</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">(GL10 gl, EGLConfig config)</span> </span>&#123;</span><br><span class="line">        yuv420Texture = <span class="keyword">new</span> YUV420Texture(context);</span><br><span class="line">        yuv420Texture.initYUV();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(GL10 gl, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//宽高</span></span><br><span class="line">        GLES20.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">(GL10 gl)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//清空颜色</span></span><br><span class="line">        GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT);</span><br><span class="line">        <span class="comment">//设置背景颜色</span></span><br><span class="line"><span class="comment">//        GLES20.glClearColor(1.0f, 1.0f, 1.0f, 1.0f);</span></span><br><span class="line"></span><br><span class="line">        yuv420Texture.draw();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setYuvData</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">byte</span>[] y, <span class="keyword">byte</span>[] u, <span class="keyword">byte</span>[] v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (yuv420Texture != <span class="keyword">null</span>) &#123;</span><br><span class="line">            yuv420Texture.setYUVData(width, height, y, u, v);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>GLSurfaceView引用Renderer</li>
</ol>
<p>MyGLSurfaceView.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLSurfaceView;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyGLSurfaceView</span> <span class="keyword">extends</span> <span class="title">GLSurfaceView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MyRender myRender;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyGLSurfaceView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyGLSurfaceView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        setEGLContextClientVersion(<span class="number">2</span>);</span><br><span class="line">        myRender = <span class="keyword">new</span> MyRender(context);</span><br><span class="line">        setRenderer(myRender);</span><br><span class="line">        <span class="comment">//mode=GLSurfaceView.RENDERMODE_WHEN_DIRTY之后  调用requestRender()触发Render的onDrawFrame函数</span></span><br><span class="line">        <span class="comment">//mode=GLSurfaceView.RENDERMODE_CONTINUOUSLY之后  自动调用onDrawFrame  60fps左右</span></span><br><span class="line">        setRenderMode(GLSurfaceView.RENDERMODE_WHEN_DIRTY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setYUVData</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">byte</span>[] y, <span class="keyword">byte</span>[] u, <span class="keyword">byte</span>[] v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (myRender != <span class="keyword">null</span>) &#123;</span><br><span class="line">            myRender.setYuvData(width, height, y, u, v);</span><br><span class="line">            requestRender();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android OpenGLES 绘制图片纹理.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android OpenGLES 绘制图片纹理.html" itemprop="url">Android OpenGLES 绘制图片纹理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-16T11:28:39+08:00">
                2018-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android OpenGLES 绘制图片纹理.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android OpenGLES 绘制图片纹理.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,298字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>把shader代码写入raw里面</li>
</ol>
<p>vertex_shader.glsl</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">attribute</span> <span class="type">vec4</span> av_Position;<span class="comment">//顶点位置</span></span><br><span class="line"><span class="keyword">attribute</span> <span class="type">vec2</span> af_Position;<span class="comment">//纹理位置</span></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec2</span> v_texPo;<span class="comment">//纹理位置  与fragment_shader交互</span></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    v_texPo = af_Position;</span><br><span class="line">    <span class="built_in">gl_Position</span> = av_Position;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fragment_shader.glsl</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">precision</span> <span class="keyword">mediump</span> <span class="type">float</span>;<span class="comment">//精度 为float</span></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec2</span> v_texPo;<span class="comment">//纹理位置  接收于vertex_shader</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> sTexture;<span class="comment">//纹理</span></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    <span class="built_in">gl_FragColor</span>=<span class="built_in">texture2D</span>(sTexture, v_texPo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>写入数据,注意纹理映射</li>
</ol>
<p><img src="https://note.youdao.com/yws/api/personal/file/E981675919204437B0301ACF58361451?method=download&amp;shareKey=39883c82241f7dbad61d9f77979fd87c" alt="纹理坐标系"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteOrder;</span><br><span class="line"><span class="keyword">import</span> java.nio.FloatBuffer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//纹理  根据坐标系映射</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitmapTexture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//顶点坐标</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> vertexData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            -<span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            -<span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//纹理坐标  对应顶点坐标  与之映射</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> textureData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每一次取点的时候取几个点</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COORDS_PER_VERTEX = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexCount = vertexData.length / COORDS_PER_VERTEX;</span><br><span class="line">    <span class="comment">//每一次取的总的点 大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexStride = COORDS_PER_VERTEX * <span class="number">4</span>; <span class="comment">// 4 bytes per vertex</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//位置</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer vertexBuffer;</span><br><span class="line">    <span class="comment">//纹理</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer textureBuffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> program;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> avPosition;</span><br><span class="line">    <span class="comment">//纹理位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> afPosition;</span><br><span class="line">    <span class="comment">//纹理id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> textureId;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BitmapTexture</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line"></span><br><span class="line">        vertexBuffer = ByteBuffer.allocateDirect(vertexData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(vertexData);</span><br><span class="line">        vertexBuffer.position(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        textureBuffer = ByteBuffer.allocateDirect(textureData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(textureData);</span><br><span class="line">        textureBuffer.position(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String vertexSource = ShaderUtil.readRawTxt(context, R.raw.vertex_shader);</span><br><span class="line">        String fragmentSource = ShaderUtil.readRawTxt(context, R.raw.fragment_shader);</span><br><span class="line">        program = ShaderUtil.createProgram(vertexSource, fragmentSource);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (program &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//获取顶点坐标字段</span></span><br><span class="line">            avPosition = GLES20.glGetAttribLocation(program, <span class="string">"av_Position"</span>);</span><br><span class="line">            <span class="comment">//获取纹理坐标字段</span></span><br><span class="line">            afPosition = GLES20.glGetAttribLocation(program, <span class="string">"af_Position"</span>);</span><br><span class="line">            <span class="keyword">int</span>[] textureIds = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//创建纹理</span></span><br><span class="line">            GLES20.glGenTextures(<span class="number">1</span>, textureIds, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (textureIds[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            textureId = textureIds[<span class="number">0</span>];</span><br><span class="line">            <span class="comment">//绑定纹理</span></span><br><span class="line">            GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureId);</span><br><span class="line">            <span class="comment">//环绕（超出纹理坐标范围）  （s==x t==y GL_REPEAT 重复）</span></span><br><span class="line">            GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_REPEAT);</span><br><span class="line">            GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_REPEAT);</span><br><span class="line">            <span class="comment">//过滤（纹理像素映射到坐标点）  （缩小、放大：GL_LINEAR线性）</span></span><br><span class="line">            GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">            GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</span><br><span class="line"></span><br><span class="line">            Bitmap bitmap = BitmapFactory.decodeResource(context.getResources(), R.mipmap.bg);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//设置纹理为2d图片</span></span><br><span class="line">            GLUtils.texImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, bitmap, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用程序</span></span><br><span class="line">        GLES20.glUseProgram(program);</span><br><span class="line">        GLES20.glEnableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glEnableVertexAttribArray(afPosition);</span><br><span class="line">        <span class="comment">//设置顶点位置值</span></span><br><span class="line">        GLES20.glVertexAttribPointer(avPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, vertexBuffer);</span><br><span class="line">        <span class="comment">//设置纹理位置值</span></span><br><span class="line">        GLES20.glVertexAttribPointer(afPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, textureBuffer);</span><br><span class="line">        <span class="comment">//绘制 GLES20.GL_TRIANGLE_STRIP:复用坐标</span></span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="number">0</span>, vertexCount);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(afPosition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ShaderUtil.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShaderUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ShaderUtil"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readRawTxt</span><span class="params">(Context context, <span class="keyword">int</span> rawId)</span> </span>&#123;</span><br><span class="line">        InputStream inputStream = context.getResources().openRawResource(rawId);</span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream));</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sb.append(line).append(<span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            reader.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">loadShader</span><span class="params">(<span class="keyword">int</span> shaderType, String source)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// create a vertex shader type (GLES20.GL_VERTEX_SHADER)</span></span><br><span class="line">        <span class="comment">// or a fragment shader type (GLES20.GL_FRAGMENT_SHADER)</span></span><br><span class="line">        <span class="keyword">int</span> shader = GLES20.glCreateShader(shaderType);</span><br><span class="line">        <span class="keyword">if</span> (shader != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//添加代码到shader</span></span><br><span class="line">            GLES20.glShaderSource(shader, source);</span><br><span class="line">            <span class="comment">//编译shader</span></span><br><span class="line">            GLES20.glCompileShader(shader);</span><br><span class="line">            <span class="keyword">int</span>[] compile = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//检测是否编译成功</span></span><br><span class="line">            GLES20.glGetShaderiv(shader, GLES20.GL_COMPILE_STATUS, compile, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (compile[<span class="number">0</span>] != GLES20.GL_TRUE) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"shader compile error"</span>);</span><br><span class="line">                GLES20.glDeleteShader(shader);</span><br><span class="line">                shader = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> shader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">createProgram</span><span class="params">(String vertexSource, String fragmentSource)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取vertex shader</span></span><br><span class="line">        <span class="keyword">int</span> vertexShader = loadShader(GLES20.GL_VERTEX_SHADER, vertexSource);</span><br><span class="line">        <span class="keyword">if</span> (vertexShader == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取fragment shader</span></span><br><span class="line">        <span class="keyword">int</span> fragmentShader = loadShader(GLES20.GL_FRAGMENT_SHADER, fragmentSource);</span><br><span class="line">        <span class="keyword">if</span> (fragmentShader == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建一个空的渲染程序</span></span><br><span class="line">        <span class="keyword">int</span> program = GLES20.glCreateProgram();</span><br><span class="line">        <span class="keyword">if</span> (program != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//添加vertexShader到渲染程序</span></span><br><span class="line">            GLES20.glAttachShader(program, vertexShader);</span><br><span class="line">            <span class="comment">//添加fragmentShader到渲染程序</span></span><br><span class="line">            GLES20.glAttachShader(program, fragmentShader);</span><br><span class="line">            <span class="comment">//关联为可执行渲染程序</span></span><br><span class="line">            GLES20.glLinkProgram(program);</span><br><span class="line">            <span class="keyword">int</span>[] linsStatus = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//检测是否关联成功</span></span><br><span class="line">            GLES20.glGetProgramiv(program, GLES20.GL_LINK_STATUS, linsStatus, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (linsStatus[<span class="number">0</span>] != GLES20.GL_TRUE) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"link program error"</span>);</span><br><span class="line">                GLES20.glDeleteProgram(program);</span><br><span class="line">                program = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> program;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="3">
<li><p>Render书写<br>MyRender.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLSurfaceView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.egl.EGLConfig;</span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.opengles.GL10;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRender</span> <span class="keyword">implements</span> <span class="title">GLSurfaceView</span>.<span class="title">Renderer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BitmapTexture bitmapTexture;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRender</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">(GL10 gl, EGLConfig config)</span> </span>&#123;</span><br><span class="line">        bitmapTexture = <span class="keyword">new</span> BitmapTexture(context);</span><br><span class="line">        bitmapTexture.onSurfaceCreated();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(GL10 gl, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//宽高</span></span><br><span class="line">        GLES20.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">(GL10 gl)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//清空颜色</span></span><br><span class="line">        GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT);</span><br><span class="line">        <span class="comment">//设置背景颜色</span></span><br><span class="line"><span class="comment">//        GLES20.glClearColor(1.0f, 1.0f, 1.0f, 1.0f);</span></span><br><span class="line"></span><br><span class="line">        bitmapTexture.draw();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>GLSurfaceView引用Renderer  </p>
</li>
</ol>
<p>MyGLSurfaceView.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLSurfaceView;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyGLSurfaceView</span> <span class="keyword">extends</span> <span class="title">GLSurfaceView</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyGLSurfaceView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyGLSurfaceView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        setEGLContextClientVersion(<span class="number">2</span>);</span><br><span class="line">        setRenderer(<span class="keyword">new</span> MyRender(context));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android OpenGLES 绘制三角形 ，四边形.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android OpenGLES 绘制三角形 ，四边形.html" itemprop="url">Android OpenGLES 绘制三角形 ，四边形</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-16T11:26:25+08:00">
                2018-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android OpenGLES 绘制三角形 ，四边形.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android OpenGLES 绘制三角形 ，四边形.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,176字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>验证是否支持OpenGLES2.0</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//检查设备是否支持OpenGL ES 2.0</span></span><br><span class="line"><span class="keyword">final</span> ActivityManager activityManager = (ActivityManager) getSystemService(ACTIVITY_SERVICE);</span><br><span class="line"><span class="keyword">final</span> ConfigurationInfo configurationInfo = activityManager.getDeviceConfigurationInfo();</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> supportES2 = configurationInfo.reqGlEsVersion &gt;= <span class="number">0x00020000</span>;</span><br></pre></td></tr></table></figure>
<p>确保可用，在manifest里面添加验证<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:glEsVersion</span>=<span class="string">"0x00020000"</span> <span class="attr">android:required</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>定义<code>vertex_shader.glsl</code>和<code>fragment_shader.glsl</code>到<code>res/raw</code>里面</li>
</ol>
<p>vertex_shader.glsl<br><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">attribute</span> <span class="type">vec4</span> vPosition;</span><br><span class="line"><span class="type">void</span> main()&#123;</span><br><span class="line">    <span class="built_in">gl_Position</span> = vPosition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>fragment_shader.glsl<br><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">precision</span> <span class="keyword">mediump</span> <span class="type">float</span>;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec4</span> vColor;</span><br><span class="line"><span class="type">void</span> main()&#123;</span><br><span class="line">    <span class="built_in">gl_FragColor</span> = vColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://blog.csdn.net/lb377463323/article/details/65939279" target="_blank" rel="noopener">OpenGL ES Shader的三种变量类型uniform，attribute和varying</a></p>
<ol start="3">
<li>定义形状</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteOrder;</span><br><span class="line"><span class="keyword">import</span> java.nio.FloatBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Triangle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//坐标本地内存地址</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer vertexBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每一次取点的时候取几个点</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COORDS_PER_VERTEX = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绘制坐标</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> triangleCoords[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            <span class="number">0.0f</span>, <span class="number">0.622008459f</span>, <span class="number">0.0f</span>, <span class="comment">// top</span></span><br><span class="line">            -<span class="number">0.5f</span>, -<span class="number">0.311004243f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">0.5f</span>, -<span class="number">0.311004243f</span>, <span class="number">0.0f</span>  <span class="comment">// bottom right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set color with red, green, blue and alpha (opacity) values</span></span><br><span class="line">    <span class="keyword">float</span> color[] = &#123;<span class="number">0.63671875f</span>, <span class="number">0.76953125f</span>, <span class="number">0.22265625f</span>, <span class="number">1.0f</span>&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mProgram;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mPositionHandle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mColorHandle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexCount = triangleCoords.length / COORDS_PER_VERTEX;</span><br><span class="line">    <span class="comment">//每一次取的总的点 大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexStride = COORDS_PER_VERTEX * <span class="number">4</span>; <span class="comment">// 4 bytes per vertex</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Triangle</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//为坐标分配本地内存地址</span></span><br><span class="line">        vertexBuffer = ByteBuffer</span><br><span class="line">                .allocateDirect(triangleCoords.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(triangleCoords);</span><br><span class="line">        vertexBuffer.position(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据shader代码和fragment代码 获取到一个渲染程序</span></span><br><span class="line">        mProgram = ShaderUtil.createProgram(ShaderUtil.readRawTxt(context, R.raw.vertex_shader),</span><br><span class="line">                ShaderUtil.readRawTxt(context, R.raw.fragment_shader));</span><br><span class="line">        <span class="keyword">if</span> (mProgram &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//获取vertex shader的属性vPosition 的地址</span></span><br><span class="line">            mPositionHandle = GLES20.glGetAttribLocation(mProgram, <span class="string">"vPosition"</span>);</span><br><span class="line">            <span class="comment">//获取fragment shader的属性vColor 的地址</span></span><br><span class="line">            mColorHandle = GLES20.glGetUniformLocation(mProgram, <span class="string">"vColor"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用渲染程序</span></span><br><span class="line">        GLES20.glUseProgram(mProgram);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使顶点属性数组有效</span></span><br><span class="line">        GLES20.glEnableVertexAttribArray(mPositionHandle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为顶点属性赋值</span></span><br><span class="line">        GLES20.glVertexAttribPointer(mPositionHandle, COORDS_PER_VERTEX,</span><br><span class="line">                GLES20.GL_FLOAT, <span class="keyword">false</span>,</span><br><span class="line">                vertexStride, vertexBuffer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置颜色</span></span><br><span class="line">        GLES20.glUniform4fv(mColorHandle, <span class="number">1</span>, color, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绘制图形</span></span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLES, <span class="number">0</span>, vertexCount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 禁用顶点数组</span></span><br><span class="line">        GLES20.glDisableVertexAttribArray(mPositionHandle);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/DFA4297C905E49D78CDC8D4CF9A2D90B?method=download&amp;shareKey=3d8872856ba25a9174e0ba8314012eed" alt="顶点坐标系"></p>
<p>ShaderUtil.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShaderUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ShaderUtil"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readRawTxt</span><span class="params">(Context context, <span class="keyword">int</span> rawId)</span> </span>&#123;</span><br><span class="line">        InputStream inputStream = context.getResources().openRawResource(rawId);</span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream));</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sb.append(line).append(<span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            reader.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">loadShader</span><span class="params">(<span class="keyword">int</span> shaderType, String source)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// create a vertex shader type (GLES20.GL_VERTEX_SHADER)</span></span><br><span class="line">        <span class="comment">// or a fragment shader type (GLES20.GL_FRAGMENT_SHADER)</span></span><br><span class="line">        <span class="keyword">int</span> shader = GLES20.glCreateShader(shaderType);</span><br><span class="line">        <span class="keyword">if</span> (shader != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//添加代码到shader</span></span><br><span class="line">            GLES20.glShaderSource(shader, source);</span><br><span class="line">            <span class="comment">//编译shader</span></span><br><span class="line">            GLES20.glCompileShader(shader);</span><br><span class="line">            <span class="keyword">int</span>[] compile = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//检测是否编译成功</span></span><br><span class="line">            GLES20.glGetShaderiv(shader, GLES20.GL_COMPILE_STATUS, compile, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (compile[<span class="number">0</span>] != GLES20.GL_TRUE) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"shader compile error"</span>);</span><br><span class="line">                GLES20.glDeleteShader(shader);</span><br><span class="line">                shader = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> shader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">createProgram</span><span class="params">(String vertexSource, String fragmentSource)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取vertex shader</span></span><br><span class="line">        <span class="keyword">int</span> vertexShader = loadShader(GLES20.GL_VERTEX_SHADER, vertexSource);</span><br><span class="line">        <span class="keyword">if</span> (vertexShader == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取fragment shader</span></span><br><span class="line">        <span class="keyword">int</span> fragmentShader = loadShader(GLES20.GL_FRAGMENT_SHADER, fragmentSource);</span><br><span class="line">        <span class="keyword">if</span> (fragmentShader == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建一个空的渲染程序</span></span><br><span class="line">        <span class="keyword">int</span> program = GLES20.glCreateProgram();</span><br><span class="line">        <span class="keyword">if</span> (program != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//添加vertexShader到渲染程序</span></span><br><span class="line">            GLES20.glAttachShader(program, vertexShader);</span><br><span class="line">            <span class="comment">//添加fragmentShader到渲染程序</span></span><br><span class="line">            GLES20.glAttachShader(program, fragmentShader);</span><br><span class="line">            <span class="comment">//关联为可执行渲染程序</span></span><br><span class="line">            GLES20.glLinkProgram(program);</span><br><span class="line">            <span class="keyword">int</span>[] linsStatus = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//检测是否关联成功</span></span><br><span class="line">            GLES20.glGetProgramiv(program, GLES20.GL_LINK_STATUS, linsStatus, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (linsStatus[<span class="number">0</span>] != GLES20.GL_TRUE) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"link program error"</span>);</span><br><span class="line">                GLES20.glDeleteProgram(program);</span><br><span class="line">                program = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> program;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>定义shader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLSurfaceView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.egl.EGLConfig;</span><br><span class="line"><span class="keyword">import</span> javax.microedition.khronos.opengles.GL10;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRender</span> <span class="keyword">implements</span> <span class="title">GLSurfaceView</span>.<span class="title">Renderer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Triangle triangle;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRender</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">(GL10 gl, EGLConfig config)</span> </span>&#123;</span><br><span class="line">        triangle = <span class="keyword">new</span> Triangle(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(GL10 gl, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//宽高</span></span><br><span class="line">        GLES20.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">(GL10 gl)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//清空颜色</span></span><br><span class="line">        GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置背景颜色</span></span><br><span class="line"><span class="comment">//        GLES20.glClearColor(1.0f, 1.0f, 1.0f, 1.0f);</span></span><br><span class="line">        triangle.draw();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置<code>shader</code>到<code>GLSurfaceView</code></p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLSurfaceView;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyGLSurfaceView</span> <span class="keyword">extends</span> <span class="title">GLSurfaceView</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyGLSurfaceView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyGLSurfaceView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        setEGLContextClientVersion(<span class="number">2</span>);</span><br><span class="line">        setRenderer(<span class="keyword">new</span> MyRender(context));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述三角形已经绘制成功。</p>
<ol start="6">
<li>绘制四边形<br>绘制四边形的方式是由两个三角形形成一个四边形，所以顶点位置一定要注意。<br>调用<code>GLES20.glDrawArrays</code>的时候设置<code>flog</code>可以设置为<code>GLES20.GL_TRIANGLE_STRIP</code>和<code>GLES20.GL_TRIANGLES</code>,前者复用坐标，后者分别取几个坐标。<br><img src="https://note.youdao.com/yws/api/personal/file/CB51EF8423D94014A1B0D6C069EB0CC7?method=download&amp;shareKey=243a9461024bd64509f16bbcb29da918" alt="绘制四边形"></li>
</ol>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/MediaCodec硬编码pcm2aac.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/MediaCodec硬编码pcm2aac.html" itemprop="url">MediaCodec硬编码pcm2aac</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-16T11:25:00+08:00">
                2018-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MediaCodec/" itemprop="url" rel="index">
                    <span itemprop="name">MediaCodec</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/MediaCodec硬编码pcm2aac.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/MediaCodec硬编码pcm2aac.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  786字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>MediaCodec</code>是<code>Android（api&gt;=16）</code>提供的一个多媒体硬解编码库，能实现音视频的编解码。</p>
<p>工作原理：其内部有2个队列，一个是输入队列，一个是输出队列。输入队列负责存储编<br>解码前的原始数据存储，并输送给<code>MediaCodec</code>处理；输出队列负责存储编解码后<br>的新数据，可以直接处理或保存到文件中。</p>
<p><code>AAC</code> 的头部信息介绍 ：<a href="https://blog.csdn.net/jay100500/article/details/52955232" target="_blank" rel="noopener">https://blog.csdn.net/jay100500/article/details/52955232</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//mediacodec</span></span><br><span class="line">   <span class="keyword">private</span> MediaFormat encoderFormat = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">private</span> MediaCodec encoder = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">private</span> FileOutputStream outputStream = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">private</span> MediaCodec.BufferInfo info = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> perpcmsize = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">byte</span>[] outByteBuffer = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> aacsamplerate = <span class="number">4</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">double</span> recordTime = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> audioSamplerate = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initMediacodec</span><span class="params">(<span class="keyword">int</span> samperate, File outfile)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           aacsamplerate = getADTSsamplerate(samperate);</span><br><span class="line">           <span class="comment">//立体声</span></span><br><span class="line">           encoderFormat = MediaFormat.createAudioFormat(MediaFormat.MIMETYPE_AUDIO_AAC, samperate, <span class="number">2</span>);</span><br><span class="line">           <span class="comment">//96kbps fm音质</span></span><br><span class="line">           encoderFormat.setInteger(MediaFormat.KEY_BIT_RATE, <span class="number">96000</span>);</span><br><span class="line">           encoderFormat.setInteger(MediaFormat.KEY_AAC_PROFILE, MediaCodecInfo.CodecProfileLevel.AACObjectLC);</span><br><span class="line">           encoderFormat.setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, <span class="number">4096</span>);</span><br><span class="line">           encoder = MediaCodec.createEncoderByType(MediaFormat.MIMETYPE_AUDIO_AAC);</span><br><span class="line">           info = <span class="keyword">new</span> MediaCodec.BufferInfo();</span><br><span class="line">           <span class="keyword">if</span>(encoder == <span class="keyword">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               MyLog.d(<span class="string">"craete encoder wrong"</span>);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           recordTime = <span class="number">0</span>;</span><br><span class="line">           encoder.configure(encoderFormat, <span class="keyword">null</span>, <span class="keyword">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);</span><br><span class="line">           outputStream = <span class="keyword">new</span> FileOutputStream(outfile);</span><br><span class="line">           encoder.start();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">encodecPcmToAAc</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">byte</span>[] buffer)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(buffer != <span class="keyword">null</span> &amp;&amp; encoder != <span class="keyword">null</span>)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">//录音时间  size/ 采样率*声道数 * bits/8</span></span><br><span class="line">           recordTime += size * <span class="number">1.0</span> / (audioSamplerate * <span class="number">2</span> * (<span class="number">16</span> / <span class="number">8</span>));</span><br><span class="line">           MyLog.d(<span class="string">"recordTime = "</span> + recordTime);</span><br><span class="line">           <span class="comment">//回掉</span></span><br><span class="line">           <span class="keyword">if</span>(wlOnRecordTimeListener != <span class="keyword">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               wlOnRecordTimeListener.onRecordTime((<span class="keyword">int</span>) recordTime);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">int</span> inputBufferindex = encoder.dequeueInputBuffer(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">if</span>(inputBufferindex &gt;= <span class="number">0</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               ByteBuffer byteBuffer = encoder.getInputBuffers()[inputBufferindex];</span><br><span class="line">               byteBuffer.clear();</span><br><span class="line">               byteBuffer.put(buffer);</span><br><span class="line">               encoder.queueInputBuffer(inputBufferindex, <span class="number">0</span>, size, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">int</span> index = encoder.dequeueOutputBuffer(info, <span class="number">0</span>);</span><br><span class="line">           <span class="keyword">while</span>(index &gt;= <span class="number">0</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   perpcmsize = info.size + <span class="number">7</span>;</span><br><span class="line">                   outByteBuffer = <span class="keyword">new</span> <span class="keyword">byte</span>[perpcmsize];</span><br><span class="line"></span><br><span class="line">                   ByteBuffer byteBuffer = encoder.getOutputBuffers()[index];</span><br><span class="line">                   byteBuffer.position(info.offset);</span><br><span class="line">                   byteBuffer.limit(info.offset + info.size);</span><br><span class="line"></span><br><span class="line">                   addADtsHeader(outByteBuffer, perpcmsize, aacsamplerate);</span><br><span class="line"></span><br><span class="line">                   byteBuffer.get(outByteBuffer, <span class="number">7</span>, info.size);</span><br><span class="line">                   byteBuffer.position(info.offset);</span><br><span class="line">                   outputStream.write(outByteBuffer, <span class="number">0</span>, perpcmsize);</span><br><span class="line"></span><br><span class="line">                   encoder.releaseOutputBuffer(index, <span class="keyword">false</span>);</span><br><span class="line">                   index = encoder.dequeueOutputBuffer(info, <span class="number">0</span>);</span><br><span class="line">                   outByteBuffer = <span class="keyword">null</span>;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addADtsHeader</span><span class="params">(<span class="keyword">byte</span>[] packet, <span class="keyword">int</span> packetLen, <span class="keyword">int</span> samplerate)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> profile = <span class="number">2</span>; <span class="comment">// AAC LC</span></span><br><span class="line">       <span class="keyword">int</span> freqIdx = samplerate; <span class="comment">// samplerate</span></span><br><span class="line">       <span class="keyword">int</span> chanCfg = <span class="number">2</span>; <span class="comment">// CPE</span></span><br><span class="line"></span><br><span class="line">       packet[<span class="number">0</span>] = (<span class="keyword">byte</span>) <span class="number">0xFF</span>; <span class="comment">// 0xFFF(12bit) 这里只取了8位，所以还差4位放到下一个里面</span></span><br><span class="line">       packet[<span class="number">1</span>] = (<span class="keyword">byte</span>) <span class="number">0xF9</span>; <span class="comment">// 第一个t位放F</span></span><br><span class="line">       packet[<span class="number">2</span>] = (<span class="keyword">byte</span>) (((profile - <span class="number">1</span>) &lt;&lt; <span class="number">6</span>) + (freqIdx &lt;&lt; <span class="number">2</span>) + (chanCfg &gt;&gt; <span class="number">2</span>));</span><br><span class="line">       packet[<span class="number">3</span>] = (<span class="keyword">byte</span>) (((chanCfg &amp; <span class="number">3</span>) &lt;&lt; <span class="number">6</span>) + (packetLen &gt;&gt; <span class="number">11</span>));</span><br><span class="line">       packet[<span class="number">4</span>] = (<span class="keyword">byte</span>) ((packetLen &amp; <span class="number">0x7FF</span>) &gt;&gt; <span class="number">3</span>);</span><br><span class="line">       packet[<span class="number">5</span>] = (<span class="keyword">byte</span>) (((packetLen &amp; <span class="number">7</span>) &lt;&lt; <span class="number">5</span>) + <span class="number">0x1F</span>);</span><br><span class="line">       packet[<span class="number">6</span>] = (<span class="keyword">byte</span>) <span class="number">0xFC</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getADTSsamplerate</span><span class="params">(<span class="keyword">int</span> samplerate)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> rate = <span class="number">4</span>;</span><br><span class="line">       <span class="keyword">switch</span> (samplerate)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">96000</span>:</span><br><span class="line">               rate = <span class="number">0</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">88200</span>:</span><br><span class="line">               rate = <span class="number">1</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">64000</span>:</span><br><span class="line">               rate = <span class="number">2</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">48000</span>:</span><br><span class="line">               rate = <span class="number">3</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">44100</span>:</span><br><span class="line">               rate = <span class="number">4</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">32000</span>:</span><br><span class="line">               rate = <span class="number">5</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">24000</span>:</span><br><span class="line">               rate = <span class="number">6</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">22050</span>:</span><br><span class="line">               rate = <span class="number">7</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">16000</span>:</span><br><span class="line">               rate = <span class="number">8</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">12000</span>:</span><br><span class="line">               rate = <span class="number">9</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">11025</span>:</span><br><span class="line">               rate = <span class="number">10</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">8000</span>:</span><br><span class="line">               rate = <span class="number">11</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">7350</span>:</span><br><span class="line">               rate = <span class="number">12</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> rate;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">releaseMedicacodec</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(encoder == <span class="keyword">null</span>)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           recordTime = <span class="number">0</span>;</span><br><span class="line">           outputStream.close();</span><br><span class="line">           outputStream = <span class="keyword">null</span>;</span><br><span class="line">           encoder.stop();</span><br><span class="line">           encoder.release();</span><br><span class="line">           encoder = <span class="keyword">null</span>;</span><br><span class="line">           encoderFormat = <span class="keyword">null</span>;</span><br><span class="line">           info = <span class="keyword">null</span>;</span><br><span class="line">           initmediacodec = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">           MyLog.d(<span class="string">"录制完成..."</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span>(outputStream != <span class="keyword">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   outputStream.close();</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               outputStream = <span class="keyword">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/MediaCodec解码FFmpeg AvPacket.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/MediaCodec解码FFmpeg AvPacket.html" itemprop="url">mediacodec解码ffmpeg AvPacket</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-16T11:22:49+08:00">
                2018-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MediaCodec/" itemprop="url" rel="index">
                    <span itemprop="name">MediaCodec</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/MediaCodec解码FFmpeg AvPacket.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/MediaCodec解码FFmpeg AvPacket.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  600字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="初始化MediaCodec"><a href="#初始化MediaCodec" class="headerlink" title="初始化MediaCodec"></a>初始化<code>MediaCodec</code></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> MediaFormat mediaFormat;</span><br><span class="line"><span class="keyword">private</span> MediaCodec mediaCodec;</span><br><span class="line"><span class="keyword">private</span> MediaCodec.BufferInfo info;</span><br><span class="line"><span class="keyword">private</span> Surface surface;<span class="comment">//这个是OpenGL渲染的Surface</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化MediaCodec</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> codecName</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> width</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> height</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> csd_0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> csd_1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initMediaCodec</span><span class="params">(String codecName, <span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">byte</span>[] csd_0, <span class="keyword">byte</span>[] csd_1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (surface != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String mime = VideoSupportUtil.findVideoCodecName(codecName);</span><br><span class="line">                mediaFormat = MediaFormat.createVideoFormat(mime, width, height);</span><br><span class="line">                mediaFormat.setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, width * height);</span><br><span class="line">                mediaFormat.setByteBuffer(<span class="string">"csd-0"</span>, ByteBuffer.wrap(csd_0));</span><br><span class="line">                mediaFormat.setByteBuffer(<span class="string">"csd-1"</span>, ByteBuffer.wrap(csd_1));</span><br><span class="line">                MyLog.d(mediaFormat.toString());</span><br><span class="line">                mediaCodec = MediaCodec.createDecoderByType(mime);</span><br><span class="line">                info = <span class="keyword">new</span> MediaCodec.BufferInfo();</span><br><span class="line">                <span class="keyword">if</span>(mediaCodec == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    MyLog.d(<span class="string">"craete mediaCodec wrong"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mediaCodec.configure(mediaFormat, surface, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">                mediaCodec.start();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/25720FC115104CFD87D5C7BE3BEF7DD1?method=download&amp;shareKey=73989030eb6590a62c2b12c4607b7a88" alt=""></p>
<p>VideoSupportUtil.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.media.MediaCodecList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoSupportUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; codecMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        codecMap.put(<span class="string">"h264"</span>, <span class="string">"video/avc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">findVideoCodecName</span><span class="params">(String ffcodename)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(codecMap.containsKey(ffcodename))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> codecMap.get(ffcodename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSupportCodec</span><span class="params">(String ffcodecname)</span></span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> supportvideo = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> count = MediaCodecList.getCodecCount();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)&#123;</span><br><span class="line">            String[] tyeps = MediaCodecList.getCodecInfoAt(i).getSupportedTypes();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; tyeps.length; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(tyeps[j].equals(findVideoCodecName(ffcodecname)))&#123;</span><br><span class="line">                    supportvideo = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(supportvideo)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> supportvideo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>c++层:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* codecName = ((<span class="keyword">const</span> AVCodec*)avCodecContext-&gt;codec)-&gt;name;</span><br><span class="line">onCallInitMediacodec(</span><br><span class="line">                codecName,</span><br><span class="line">                avCodecContext-&gt;width,</span><br><span class="line">                avCodecContext-&gt;height,</span><br><span class="line">                avCodecContext-&gt;extradata_size,</span><br><span class="line">                avCodecContext-&gt;extradata_size,</span><br><span class="line">                avCodecContext-&gt;extradata,</span><br><span class="line">                avCodecContext-&gt;extradata</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取jmid_initmediacodec</span></span><br><span class="line">jclass  jlz = jniEnv-&gt;GetObjectClass(jobj);</span><br><span class="line">jmethodID jmid_initmediacodec = env-&gt;GetMethodID(jlz, <span class="string">"initMediaCodec"</span>, <span class="string">"(Ljava/lang/String;II[B[B)V"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//在子线程</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onCallInitMediacodec</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* mime, <span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> csd0_size, <span class="keyword">int</span> csd1_size, <span class="keyword">uint8_t</span> *csd_0, <span class="keyword">uint8_t</span> *csd_1)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    JNIEnv *jniEnv;</span><br><span class="line">    <span class="keyword">if</span>(javaVM-&gt;AttachCurrentThread(&amp;jniEnv, <span class="number">0</span>) != JNI_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(LOG_DEBUG)</span><br><span class="line">        &#123;</span><br><span class="line">            LOGE(<span class="string">"call onCallComplete worng"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    jstring type = jniEnv-&gt;NewStringUTF(mime);</span><br><span class="line">    jbyteArray csd0 = jniEnv-&gt;NewByteArray(csd0_size);</span><br><span class="line">    jniEnv-&gt;SetByteArrayRegion(csd0, <span class="number">0</span>, csd0_size, <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> jbyte *&gt;(csd_0));</span><br><span class="line">    jbyteArray csd1 = jniEnv-&gt;NewByteArray(csd1_size);</span><br><span class="line">    jniEnv-&gt;SetByteArrayRegion(csd1, <span class="number">0</span>, csd1_size, <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> jbyte *&gt;(csd_1));</span><br><span class="line"></span><br><span class="line">    jniEnv-&gt;CallVoidMethod(jobj, jmid_initmediacodec, type, width, height, csd0, csd1);</span><br><span class="line"></span><br><span class="line">    jniEnv-&gt;DeleteLocalRef(csd0);</span><br><span class="line">    jniEnv-&gt;DeleteLocalRef(csd1);</span><br><span class="line">    jniEnv-&gt;DeleteLocalRef(type);</span><br><span class="line">    javaVM-&gt;DetachCurrentThread();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="解码AvPacket数据"><a href="#解码AvPacket数据" class="headerlink" title="解码AvPacket数据"></a>解码<code>AvPacket</code>数据</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decodeAVPacket</span><span class="params">(<span class="keyword">int</span> datasize, <span class="keyword">byte</span>[] data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (surface != <span class="keyword">null</span> &amp;&amp; datasize &gt; <span class="number">0</span> &amp;&amp; data != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> intputBufferIndex = mediaCodec.dequeueInputBuffer(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (intputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            ByteBuffer byteBuffer = mediaCodec.getOutputBuffers()[intputBufferIndex];</span><br><span class="line">            byteBuffer.clear();</span><br><span class="line">            byteBuffer.put(data);</span><br><span class="line">            mediaCodec.queueInputBuffer(intputBufferIndex, <span class="number">0</span>, datasize, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这里拿到outputBufferIndex然后就可以获取到数据,这里会通过surface达到渲染</span></span><br><span class="line">        <span class="keyword">int</span> outputBufferIndex = mediaCodec.dequeueOutputBuffer(info, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            mediaCodec.releaseOutputBuffer(outputBufferIndex, <span class="keyword">true</span>);</span><br><span class="line">            outputBufferIndex = mediaCodec.dequeueOutputBuffer(info, <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>c++层回调<code>decodeAVPacket</code><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">datasize = avPacket-&gt;size;</span><br><span class="line">data = avPacket-&gt;data;<span class="comment">//jni这里需要把uint8_t转为jbyteArray，类似初始化那</span></span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/MediaCodec判断是否可以采用硬解码.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/MediaCodec判断是否可以采用硬解码.html" itemprop="url">MediaCodec判断是否可以采用硬解码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-16T11:21:00+08:00">
                2018-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MediaCodec/" itemprop="url" rel="index">
                    <span itemprop="name">MediaCodec</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/MediaCodec判断是否可以采用硬解码.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/MediaCodec判断是否可以采用硬解码.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  444字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.media.MediaCodecList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoSupportUitl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; codecMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        codecMap.put(<span class="string">"h264"</span>, <span class="string">"video/avc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">findVideoCodecName</span><span class="params">(String ffcodename)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(codecMap.containsKey(ffcodename))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> codecMap.get(ffcodename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSupportCodec</span><span class="params">(String ffcodecname)</span></span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> supportvideo = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> count = MediaCodecList.getCodecCount();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            String[] tyeps = MediaCodecList.getCodecInfoAt(i).getSupportedTypes();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; tyeps.length; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(tyeps[j].equals(findVideoCodecName(ffcodecname)))</span><br><span class="line">                &#123;</span><br><span class="line">                    supportvideo = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(supportvideo)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> supportvideo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体的类型对应关系可以查看相关文档，这里在<code>Android</code>源码<code>MediaCodec.createDecoderByType()</code>里面有一些相关的对应支持类型。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Instantiate the preferred decoder supporting input data of the given mime type.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * The following is a partial list of defined mime types and their semantics:</span></span><br><span class="line"><span class="comment">    * &lt;ul&gt;</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"video/x-vnd.on2.vp8" - VP8 video (i.e. video in .webm)</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"video/x-vnd.on2.vp9" - VP9 video (i.e. video in .webm)</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"video/avc" - H.264/AVC video</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"video/hevc" - H.265/HEVC video</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"video/mp4v-es" - MPEG4 video</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"video/3gpp" - H.263 video</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"audio/3gpp" - AMR narrowband audio</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"audio/amr-wb" - AMR wideband audio</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"audio/mpeg" - MPEG1/2 audio layer III</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"audio/mp4a-latm" - AAC audio (note, this is raw AAC packets, not packaged in LATM!)</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"audio/vorbis" - vorbis audio</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"audio/g711-alaw" - G.711 alaw audio</span></span><br><span class="line"><span class="comment">    * &lt;li&gt;"audio/g711-mlaw" - G.711 ulaw audio</span></span><br><span class="line"><span class="comment">    * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;strong&gt;Note:&lt;/strong&gt; It is preferred to use &#123;<span class="doctag">@link</span> MediaCodecList#findDecoderForFormat&#125;</span></span><br><span class="line"><span class="comment">    * and &#123;<span class="doctag">@link</span> #createByCodecName&#125; to ensure that the resulting codec can handle a</span></span><br><span class="line"><span class="comment">    * given format.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> type The mime type of the input data.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> IOException if the codec cannot be created.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> IllegalArgumentException if type is not a valid mime type.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> NullPointerException if type is null.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@NonNull</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MediaCodec <span class="title">createDecoderByType</span><span class="params">(@NonNull String type)</span></span></span><br><span class="line"><span class="function">           <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> MediaCodec(type, <span class="keyword">true</span> <span class="comment">/* nameIsType */</span>, <span class="keyword">false</span> <span class="comment">/* encoder */</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>在<code>ffmpeg</code>里面<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((<span class="keyword">const</span> AVCodec*)(avCodecContext-&gt;codec))-&gt;name;</span><br></pre></td></tr></table></figure></p>
<p>即可拿到<code>name</code>，然后<code>jni</code>交互调用即可。</p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/header.jpg"
                alt="曾大稳丶" />
            
              <p class="site-author-name" itemprop="name">曾大稳丶</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">79</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">曾大稳丶</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>







        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: '5mOx5QUSJWyNMHeGUeqhG6uH-gzGzoHsz',
        appKey: '1gJRAgpCvNnFBWXPBRwEPmAM',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>