<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<!--添加头部进度条-->
<!-- <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 2px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style> -->
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="曾大稳丶">
<meta property="og:url" content="http://www.zengzhaowen.cn/page/7/index.html">
<meta property="og:site_name" content="曾大稳丶">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="曾大稳丶">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.zengzhaowen.cn/page/7/"/>





  <title>曾大稳丶</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ccc0cac4d5d9e6f8efec9c129ada134d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">曾大稳丶</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android LayoutInflater.inflate()源码流程分析.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android LayoutInflater.inflate()源码流程分析.html" itemprop="url">Android LayoutInflater.inflate()源码流程分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-16T09:52:57+08:00">
                2018-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android LayoutInflater.inflate()源码流程分析.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android LayoutInflater.inflate()源码流程分析.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,488字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  14分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　我们在根据<code>layout</code>文件得到<code>View</code>的时候都会使用<code>LayoutInflater.from(mContext).inflate().</code>下面我们来分析这个获取View流程。<br>　　我们知道<code>inflate</code>有如下函数:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inflate(<span class="meta">@LayoutRes</span> <span class="keyword">int</span> resource, <span class="meta">@Nullable</span> ViewGroup root);</span><br><span class="line">inflate(<span class="meta">@LayoutRes</span> <span class="keyword">int</span> resource, <span class="meta">@Nullable</span> ViewGroup root, <span class="keyword">boolean</span> attachToRoot);</span><br><span class="line">inflate(XmlPullParser parser, <span class="meta">@Nullable</span> ViewGroup root, <span class="keyword">boolean</span> attachToRoot);</span><br></pre></td></tr></table></figure></p>
<p>其实点进去查看可以知道，其实都到了这个方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inflate(XmlPullParser parser, <span class="meta">@Nullable</span> ViewGroup root, <span class="keyword">boolean</span> attachToRoot);</span><br></pre></td></tr></table></figure></p>
<p>源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Inflate a new view hierarchy from the specified XML node. Throws</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> InflateException&#125; if there is an error.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * &lt;em&gt;&lt;strong&gt;Important&lt;/strong&gt;&lt;/em&gt;   For performance</span></span><br><span class="line"><span class="comment">    * reasons, view inflation relies heavily on pre-processing of XML files</span></span><br><span class="line"><span class="comment">    * that is done at build time. Therefore, it is not currently possible to</span></span><br><span class="line"><span class="comment">    * use LayoutInflater with an XmlPullParser over a plain XML file at runtime.</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> parser XML dom node containing the description of the view</span></span><br><span class="line"><span class="comment">    *        hierarchy.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> root Optional view to be the parent of the generated hierarchy (if</span></span><br><span class="line"><span class="comment">    *        &lt;em&gt;attachToRoot&lt;/em&gt; is true), or else simply an object that</span></span><br><span class="line"><span class="comment">    *        provides a set of LayoutParams values for root of the returned</span></span><br><span class="line"><span class="comment">    *        hierarchy (if &lt;em&gt;attachToRoot&lt;/em&gt; is false.)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> attachToRoot Whether the inflated hierarchy should be attached to</span></span><br><span class="line"><span class="comment">    *        the root parameter? If false, root is only used to create the</span></span><br><span class="line"><span class="comment">    *        correct subclass of LayoutParams for the root view in the XML.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> The root View of the inflated hierarchy. If root was supplied and</span></span><br><span class="line"><span class="comment">    *         attachToRoot is true, this is root; otherwise it is the root of</span></span><br><span class="line"><span class="comment">    *         the inflated XML file.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(XmlPullParser parser, @Nullable ViewGroup root, <span class="keyword">boolean</span> attachToRoot)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">synchronized</span> (mConstructorArgs) &#123;</span><br><span class="line">           Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"inflate"</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> Context inflaterContext = mContext;</span><br><span class="line">           <span class="keyword">final</span> AttributeSet attrs = Xml.asAttributeSet(parser);</span><br><span class="line">           Context lastContext = (Context) mConstructorArgs[<span class="number">0</span>];</span><br><span class="line">           mConstructorArgs[<span class="number">0</span>] = inflaterContext;</span><br><span class="line">           View result = root;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">// Look for the root node.</span></span><br><span class="line">               <span class="keyword">int</span> type;</span><br><span class="line">               <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG &amp;&amp;</span><br><span class="line">                       type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                   <span class="comment">// Empty</span></span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(parser.getPositionDescription()</span><br><span class="line">                           + <span class="string">": No start tag found!"</span>);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">final</span> String name = parser.getName();</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                   System.out.println(<span class="string">"**************************"</span>);</span><br><span class="line">                   System.out.println(<span class="string">"Creating root view: "</span></span><br><span class="line">                           + name);</span><br><span class="line">                   System.out.println(<span class="string">"**************************"</span>);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (TAG_MERGE.equals(name)) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;merge /&gt; can be used only with a valid "</span></span><br><span class="line">                               + <span class="string">"ViewGroup root and attachToRoot=true"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   rInflate(parser, root, inflaterContext, attrs, <span class="keyword">false</span>);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// Temp is the root view that was found in the xml</span></span><br><span class="line">                   <span class="keyword">final</span> View temp = createViewFromTag(root, name, inflaterContext, attrs);</span><br><span class="line"></span><br><span class="line">                   ViewGroup.LayoutParams params = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (root != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                           System.out.println(<span class="string">"Creating params from root: "</span> +</span><br><span class="line">                                   root);</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="comment">// Create layout params that match root, if supplied</span></span><br><span class="line">                       params = root.generateLayoutParams(attrs);</span><br><span class="line">                       <span class="keyword">if</span> (!attachToRoot) &#123;</span><br><span class="line">                           <span class="comment">// Set the layout params for temp if we are not</span></span><br><span class="line">                           <span class="comment">// attaching. (If we are, we use addView, below)</span></span><br><span class="line">                           temp.setLayoutParams(params);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                       System.out.println(<span class="string">"-----&gt; start inflating children"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// Inflate all children under temp against its context.</span></span><br><span class="line">                   rInflateChildren(parser, temp, attrs, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                       System.out.println(<span class="string">"-----&gt; done inflating children"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// We are supposed to attach all the views we found (int temp)</span></span><br><span class="line">                   <span class="comment">// to root. Do that now.</span></span><br><span class="line">                   <span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; attachToRoot) &#123;</span><br><span class="line">                       root.addView(temp, params);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// Decide whether to return the root that was passed in or the</span></span><br><span class="line">                   <span class="comment">// top view found in xml.</span></span><br><span class="line">                   <span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</span><br><span class="line">                       result = temp;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">               <span class="keyword">final</span> InflateException ie = <span class="keyword">new</span> InflateException(e.getMessage(), e);</span><br><span class="line">               ie.setStackTrace(EMPTY_STACK_TRACE);</span><br><span class="line">               <span class="keyword">throw</span> ie;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               <span class="keyword">final</span> InflateException ie = <span class="keyword">new</span> InflateException(parser.getPositionDescription()</span><br><span class="line">                       + <span class="string">": "</span> + e.getMessage(), e);</span><br><span class="line">               ie.setStackTrace(EMPTY_STACK_TRACE);</span><br><span class="line">               <span class="keyword">throw</span> ie;</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               <span class="comment">// Don't retain static reference on context.</span></span><br><span class="line">               mConstructorArgs[<span class="number">0</span>] = lastContext;</span><br><span class="line">               mConstructorArgs[<span class="number">1</span>] = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">               Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> result;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>其实就是通过<code>XmlPullParser</code>来解析<code>layout.xml</code>布局<br>在这里通过判断，如果是<code>merge</code>标签就会执行如下方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Recursive method used to descend down the xml hierarchy and instantiate</span></span><br><span class="line"><span class="comment">    * views, instantiate their children, and then call onFinishInflate().</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * &lt;strong&gt;Note:&lt;/strong&gt; Default visibility so the BridgeInflater can</span></span><br><span class="line"><span class="comment">    * override it.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">rInflate</span><span class="params">(XmlPullParser parser, View parent, Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">           AttributeSet attrs, <span class="keyword">boolean</span> finishInflate)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> depth = parser.getDepth();</span><br><span class="line">       <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">while</span> (((type = parser.next()) != XmlPullParser.END_TAG ||</span><br><span class="line">               parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> String name = parser.getName();</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">if</span> (TAG_REQUEST_FOCUS.equals(name)) &#123;</span><br><span class="line">               parseRequestFocus(parser, parent);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_TAG.equals(name)) &#123;</span><br><span class="line">               parseViewTag(parser, parent, attrs);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_INCLUDE.equals(name)) &#123;</span><br><span class="line">               <span class="keyword">if</span> (parser.getDepth() == <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;include /&gt; cannot be the root element"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               parseInclude(parser, context, parent, attrs);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_MERGE.equals(name)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;merge /&gt; must be the root element"</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">final</span> View view = createViewFromTag(parent, name, context, attrs);</span><br><span class="line">               <span class="keyword">final</span> ViewGroup viewGroup = (ViewGroup) parent;</span><br><span class="line">               <span class="keyword">final</span> ViewGroup.LayoutParams params = viewGroup.generateLayoutParams(attrs);</span><br><span class="line">               rInflateChildren(parser, view, attrs, <span class="keyword">true</span>);</span><br><span class="line">               viewGroup.addView(view, params);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (finishInflate) &#123;</span><br><span class="line">           parent.onFinishInflate();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>我这主要讲根据<code>layout.xml</code>获取里面的<code>View</code>流程，这些不同的标签不同的解析方式,在这不进行细讲，有趣的可以自行查看源码。在这我们重点看<code>createViewFromTag</code>函数，因为在如果layout开始标签不是<code>merge</code>的话也会调用这个函数创建<code>View</code>,可以发现最终进入：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a view from a tag name using the supplied attribute set.</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &lt;strong&gt;Note:&lt;/strong&gt; Default visibility so the BridgeInflater can</span></span><br><span class="line"><span class="comment">   * override it.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> parent the parent view, used to inflate layout params</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> name the name of the XML tag used to define the view</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> context the inflation context for the view, typically the</span></span><br><span class="line"><span class="comment">   *                &#123;<span class="doctag">@code</span> parent&#125; or base layout inflater context</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> attrs the attribute set for the XML tag used to define the view</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ignoreThemeAttr &#123;<span class="doctag">@code</span> true&#125; to ignore the &#123;<span class="doctag">@code</span> android:theme&#125;</span></span><br><span class="line"><span class="comment">   *                        attribute (if set) for the view being inflated,</span></span><br><span class="line"><span class="comment">   *                        &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">View <span class="title">createViewFromTag</span><span class="params">(View parent, String name, Context context, AttributeSet attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> ignoreThemeAttr)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (name.equals(<span class="string">"view"</span>)) &#123;</span><br><span class="line">          name = attrs.getAttributeValue(<span class="keyword">null</span>, <span class="string">"class"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Apply a theme wrapper, if allowed and one is specified.</span></span><br><span class="line">      <span class="keyword">if</span> (!ignoreThemeAttr) &#123;</span><br><span class="line">          <span class="keyword">final</span> TypedArray ta = context.obtainStyledAttributes(attrs, ATTRS_THEME);</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> themeResId = ta.getResourceId(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> (themeResId != <span class="number">0</span>) &#123;</span><br><span class="line">              context = <span class="keyword">new</span> ContextThemeWrapper(context, themeResId);</span><br><span class="line">          &#125;</span><br><span class="line">          ta.recycle();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (name.equals(TAG_1995)) &#123;</span><br><span class="line">          <span class="comment">// Let's party like it's 1995!</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> BlinkLayout(context, attrs);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          View view;</span><br><span class="line">          <span class="keyword">if</span> (mFactory2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">              view = mFactory2.onCreateView(parent, name, context, attrs);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">              view = mFactory.onCreateView(name, context, attrs);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              view = <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (view == <span class="keyword">null</span> &amp;&amp; mPrivateFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">              view = mPrivateFactory.onCreateView(parent, name, context, attrs);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">final</span> Object lastContext = mConstructorArgs[<span class="number">0</span>];</span><br><span class="line">              mConstructorArgs[<span class="number">0</span>] = context;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (-<span class="number">1</span> == name.indexOf(<span class="string">'.'</span>)) &#123;</span><br><span class="line">                      view = onCreateView(parent, name, attrs);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      view = createView(name, <span class="keyword">null</span>, attrs);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                  mConstructorArgs[<span class="number">0</span>] = lastContext;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> view;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InflateException e) &#123;</span><br><span class="line">          <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">          <span class="keyword">final</span> InflateException ie = <span class="keyword">new</span> InflateException(attrs.getPositionDescription()</span><br><span class="line">                  + <span class="string">": Error inflating class "</span> + name, e);</span><br><span class="line">          ie.setStackTrace(EMPTY_STACK_TRACE);</span><br><span class="line">          <span class="keyword">throw</span> ie;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="keyword">final</span> InflateException ie = <span class="keyword">new</span> InflateException(attrs.getPositionDescription()</span><br><span class="line">                  + <span class="string">": Error inflating class "</span> + name, e);</span><br><span class="line">          ie.setStackTrace(EMPTY_STACK_TRACE);</span><br><span class="line">          <span class="keyword">throw</span> ie;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过这段函数可以知道到<code>View</code>是在这里创建的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">View view;</span><br><span class="line"><span class="keyword">if</span> (mFactory2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">    view = mFactory2.onCreateView(parent, name, context, attrs);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">    view = mFactory.onCreateView(name, context, attrs);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    view = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (view == <span class="keyword">null</span> &amp;&amp; mPrivateFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">    view = mPrivateFactory.onCreateView(parent, name, context, attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> Object lastContext = mConstructorArgs[<span class="number">0</span>];</span><br><span class="line">    mConstructorArgs[<span class="number">0</span>] = context;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (-<span class="number">1</span> == name.indexOf(<span class="string">'.'</span>)) &#123;</span><br><span class="line">            view = onCreateView(parent, name, attrs);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            view = createView(name, <span class="keyword">null</span>, attrs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mConstructorArgs[<span class="number">0</span>] = lastContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> view;</span><br></pre></td></tr></table></figure></p>
<p>可以发现<code>View</code>创建经过了实际是由<code>mFactory2</code>–&gt;<code>Factory</code>–&gt;<code>mPrivateFactory</code>的判断才进入到了<code>onCreateView</code>方法，在这里我们就可以知道，<strong>如果我们要拦截<code>View</code>的创建，我们就可以给<code>LayoutInflater</code>设置一个我们自定义的一个<code>Factory</code>即可，并且创建<code>View</code>的规则我们在自己的<code>Factory</code>类中实现即可</strong>。具体的实现方式<a href="http://www.jianshu.com/p/2ee4a7f98d69" target="_blank" rel="noopener">点此查看</a>,我们继续看<code>onCreateView(parent, name, attrs);</code><br>如果是<code>-1 == name.indexOf(&#39;.&#39;)</code>的，即不是自定义的<code>View</code>将会执行:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createView(name, <span class="string">"android.view."</span>, attrs);</span><br></pre></td></tr></table></figure></p>
<p>是自定义的则是:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view = createView(name, <span class="keyword">null</span>, attrs);</span><br></pre></td></tr></table></figure></p>
<p><code>createView(String name, String prefix, AttributeSet attrs)</code>函数如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Low-level function for instantiating a view by name. This attempts to</span></span><br><span class="line"><span class="comment">     * instantiate a view class of the given &lt;var&gt;name&lt;/var&gt; found in this</span></span><br><span class="line"><span class="comment">     * LayoutInflater's ClassLoader.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * There are two things that can happen in an error case: either the</span></span><br><span class="line"><span class="comment">     * exception describing the error will be thrown, or a null will be</span></span><br><span class="line"><span class="comment">     * returned. You must deal with both possibilities -- the former will happen</span></span><br><span class="line"><span class="comment">     * the first time createView() is called for a class of a particular name,</span></span><br><span class="line"><span class="comment">     * the latter every time there-after for that class name.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name The full name of the class to be instantiated.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> attrs The XML attributes supplied for this instance.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> View The newly instantiated view, or null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> View <span class="title">createView</span><span class="params">(String name, String prefix, AttributeSet attrs)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ClassNotFoundException, InflateException </span>&#123;</span><br><span class="line">        Constructor&lt;? extends View&gt; constructor = sConstructorMap.get(name);</span><br><span class="line">        <span class="keyword">if</span> (constructor != <span class="keyword">null</span> &amp;&amp; !verifyClassLoader(constructor)) &#123;</span><br><span class="line">            constructor = <span class="keyword">null</span>;</span><br><span class="line">            sConstructorMap.remove(name);</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;? extends View&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_VIEW, name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Class not found in the cache, see if it's real, and try to add it</span></span><br><span class="line">                clazz = mContext.getClassLoader().loadClass(</span><br><span class="line">                        prefix != <span class="keyword">null</span> ? (prefix + name) : name).asSubclass(View.class);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (mFilter != <span class="keyword">null</span> &amp;&amp; clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> allowed = mFilter.onLoadClass(clazz);</span><br><span class="line">                    <span class="keyword">if</span> (!allowed) &#123;</span><br><span class="line">                        failNotAllowed(name, prefix, attrs);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                constructor = clazz.getConstructor(mConstructorSignature);</span><br><span class="line">                constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                sConstructorMap.put(name, constructor);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// If we have a filter, apply it to cached constructor</span></span><br><span class="line">                <span class="keyword">if</span> (mFilter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Have we seen this name before?</span></span><br><span class="line">                    Boolean allowedState = mFilterMap.get(name);</span><br><span class="line">                    <span class="keyword">if</span> (allowedState == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// New class -- remember whether it is allowed</span></span><br><span class="line">                        clazz = mContext.getClassLoader().loadClass(</span><br><span class="line">                                prefix != <span class="keyword">null</span> ? (prefix + name) : name).asSubclass(View.class);</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">boolean</span> allowed = clazz != <span class="keyword">null</span> &amp;&amp; mFilter.onLoadClass(clazz);</span><br><span class="line">                        mFilterMap.put(name, allowed);</span><br><span class="line">                        <span class="keyword">if</span> (!allowed) &#123;</span><br><span class="line">                            failNotAllowed(name, prefix, attrs);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (allowedState.equals(Boolean.FALSE)) &#123;</span><br><span class="line">                        failNotAllowed(name, prefix, attrs);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Object[] args = mConstructorArgs;</span><br><span class="line">            args[<span class="number">1</span>] = attrs;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> View view = constructor.newInstance(args);</span><br><span class="line">            <span class="keyword">if</span> (view <span class="keyword">instanceof</span> ViewStub) &#123;</span><br><span class="line">                <span class="comment">// Use the same context when inflating ViewStub later.</span></span><br><span class="line">                <span class="keyword">final</span> ViewStub viewStub = (ViewStub) view;</span><br><span class="line">                viewStub.setLayoutInflater(cloneInContext((Context) args[<span class="number">0</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> view;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            <span class="keyword">final</span> InflateException ie = <span class="keyword">new</span> InflateException(attrs.getPositionDescription()</span><br><span class="line">                    + <span class="string">": Error inflating class "</span> + (prefix != <span class="keyword">null</span> ? (prefix + name) : name), e);</span><br><span class="line">            ie.setStackTrace(EMPTY_STACK_TRACE);</span><br><span class="line">            <span class="keyword">throw</span> ie;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">            <span class="comment">// If loaded class is not a View subclass</span></span><br><span class="line">            <span class="keyword">final</span> InflateException ie = <span class="keyword">new</span> InflateException(attrs.getPositionDescription()</span><br><span class="line">                    + <span class="string">": Class is not a View "</span> + (prefix != <span class="keyword">null</span> ? (prefix + name) : name), e);</span><br><span class="line">            ie.setStackTrace(EMPTY_STACK_TRACE);</span><br><span class="line">            <span class="keyword">throw</span> ie;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// If loadClass fails, we should propagate the exception.</span></span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">final</span> InflateException ie = <span class="keyword">new</span> InflateException(</span><br><span class="line">                    attrs.getPositionDescription() + <span class="string">": Error inflating class "</span></span><br><span class="line">                            + (clazz == <span class="keyword">null</span> ? <span class="string">"&lt;unknown&gt;"</span> : clazz.getName()), e);</span><br><span class="line">            ie.setStackTrace(EMPTY_STACK_TRACE);</span><br><span class="line">            <span class="keyword">throw</span> ie;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以知道其实就是通过反射来进行<code>View</code>的创建,先在<code>constructor</code>缓存集合<code>sConstructorMap</code>里面查找对应的<code>View</code>的<code>constructor</code>进行初始化，如果没有就通过反射拿到<code>constructor</code>，然后缓存到<code>sConstructorMap</code>里面，创建<code>View</code>的时候是通过<code>prefix</code>拼接的,如果<code>xml</code>里面是<code>TextView</code>则拼接出来则是<code>android.view.TextView</code>,所以上面不是自定的<code>View</code>的话，执行的是<code>createView(name, &quot;android.view.&quot;, attrs);</code>，如果是自定义的话就不用拼接了。可以发现通过代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> constructor = clazz.getConstructor(mConstructorSignature);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] mConstructorSignature = <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">            Context.class, AttributeSet.class&#125;;</span><br></pre></td></tr></table></figure></p>
<p>得知，最终创建<code>View</code>的构造方法是带有<code>Context</code>和<code>AttributeSet</code>参数的方法，这也就解析了我们在自定义一些View的时候，如果不重写这个带有这两个参数的方法的话将会崩溃的现象。</p>
<p>LayoutInflater.inflate()源码流程分析就到这里了。因为在这里读的是流程，所有很多细节的东西还是希望大家自己去源码中看看。</p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android View的Touch事件分发.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android View的Touch事件分发.html" itemprop="url">Android View的Touch事件分发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-15T14:52:57+08:00">
                2018-03-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android View的Touch事件分发.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android View的Touch事件分发.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,094字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>事件分发的重要性我就不多说了，我们先从简到难。<br>先看<code>View</code>的<code>Touch</code>事件分发,我自定义一个<code>View</code>，重写<code>OnTouchEvent</code>函数，然后分别设置<code>OnTouchListener</code>和<code>OnClick</code>：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-52e9d12919a387eb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="自定义重写OnTouchEvent"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-98a3b13b5c3cfe5e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="布局"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-0a75392509562120.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="设置onTouchListener和onClick"></p>
<p>  <code>ACTION_DOWN = 0   ACTION_UP=1   ACTION_MOVE=2</code><br>我们我们按下这个<code>View</code>点击一下:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-eee71d2006a570bc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="点击"></p>
<p>可以发现执行的顺序是:<br><code>OnTouchListener.DOWN -&gt; OnTouchEvent.DOWN -&gt; OnTouchListener.MOVE -&gt; OnTouchEvent.MOVE -&gt; OnTouchListener.UP-&gt; OnTouchEvent.UP-&gt; OnClickListener</code><br>从这我们就可以猜想执行的优先级为<br><code>OnTouchListener &gt; onTouchEvent &gt; onClick</code><br>接下来我们验证这个猜想，<br>我们把<code>OnTouchListener</code>的<code>onTouch</code>返回值改为<code>true</code><br><img src="http://upload-images.jianshu.io/upload_images/4658633-177e97ecb39ed7eb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="OnTouchListener的onTouch返回值改为true"><br>我在点击一下，这里大胆猜想一下<code>onTouchEvent</code>和<code>onClick</code>不会执行了，看看执行的顺序</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-ace8ff80770cfd7b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="OnTouchListener的onTouch返回值改为true之后的执行顺序"><br>这时候执行的顺序如下:<br><code>OnTouchListener.DOWN -&gt;OnTouchListener.MOVE-&gt; OnTouchListener.UP</code><br>这里验证了我的猜想，可以得到如下结论</p>
<blockquote>
<p><code>View</code>的<code>Touch</code>事件分发，<code>OnToucherListener</code>如果返回<code>true</code>的话，就说明把事件从<code>OnToucherListener</code>这里拦截了，后续的<code>onTouchEvent</code>和<code>onClick</code>就收不到事件了。</p>
</blockquote>
<p>接下来我们把<code>OnTouchListener</code>的<code>onTouch</code>返回值改为<code>false</code>,让它不拦截事件，把<code>onTouchEvent</code>返回值改为<code>true</code><br><img src="http://upload-images.jianshu.io/upload_images/4658633-ab66ae1b787f2a03.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="onTouchEvent返回值改为true"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-8ff229e93b5067be.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="OnTouchListener的onTouch返回值改为false"><br>我们点击一下,猜想是<code>OnTouchListener</code>和<code>onTouchEvent</code>能够接收到事件，<code>onClick</code>将不会触发</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-9d8ad909f625e7a8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>和我们想的一致，这时候执行顺序变为:<br><code>OnTouchListener.DOWN -&gt;OnTouchEvent.DOWN-&gt; OnTouchListener.MOVE -&gt; OnTouchEvent.MOVE-&gt;OnTouchListener.UP -&gt;OnTouchEvent.UP</code><br>这里我们就可能得到结论</p>
<blockquote>
<p><code>View</code>的<code>Touch</code>事件分发，如果<code>OnToucherListener</code>返回<code>false</code>，<code>onTouchEvent</code>返回<code>true</code>，就说明把事件从<code>onTouchEvent</code>这里拦截了，<code>onClick</code>就不会触发。</p>
</blockquote>
<p>通过上面两个结论我们验证了我们的优先级猜想</p>
<blockquote>
<p><code>View</code>的<code>Touch</code>事件分发，执行的优先级为<code>OnTouchListener &gt; onTouchEvent &gt; onClick</code>，如果前两个任意一个地方返回<code>true</code>，那么后续将不会收到事件。</p>
</blockquote>
<p>接下来我们从源码的角度分析,首先我们需要知道，你点击或者或者触摸任何一个<code>View</code> 都会调用  <code>dispatchTouchEvent()</code>函数，我们就从这里开始分析源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Pass the touch screen motion event down to the target view, or this</span></span><br><span class="line"><span class="comment">    * view if it is the target.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> event The motion event to be dispatched.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> True if the event was handled by the view, false otherwise.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// If the event should be handled by accessibility focus first.</span></span><br><span class="line">       <span class="keyword">if</span> (event.isTargetAccessibilityFocus()) &#123;</span><br><span class="line">           <span class="comment">// We don't have focus or no virtual descendant has it, do not handle the event.</span></span><br><span class="line">           <span class="keyword">if</span> (!isAccessibilityFocusedViewOrHost()) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// We have focus and got the event, then use normal event dispatch.</span></span><br><span class="line">           event.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">           mInputEventConsistencyVerifier.onTouchEvent(event, <span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = event.getActionMasked();</span><br><span class="line">       <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">           <span class="comment">// Defensive cleanup for new gesture</span></span><br><span class="line">           stopNestedScroll();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</span><br><span class="line">           <span class="keyword">if</span> ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</span><br><span class="line">               result = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">           ListenerInfo li = mListenerInfo;</span><br><span class="line">           <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></span><br><span class="line">                   &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">                   &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</span><br><span class="line">               result = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">               result = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!result &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">           mInputEventConsistencyVerifier.onUnhandledEvent(event, <span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Clean up after nested scrolls if this is the end of a gesture;</span></span><br><span class="line">       <span class="comment">// also cancel it if we tried an ACTION_DOWN but we didn't want the rest</span></span><br><span class="line">       <span class="comment">// of the gesture.</span></span><br><span class="line">       <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_UP ||</span><br><span class="line">               actionMasked == MotionEvent.ACTION_CANCEL ||</span><br><span class="line">               (actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) &#123;</span><br><span class="line">           stopNestedScroll();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>我们先要知道<code>ListenerInfo</code>这个是做什么的？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ListenerInfo</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Listener used to dispatch focus change events.</span></span><br><span class="line"><span class="comment">         * This field should be made private, so it is hidden from the SDK.</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">protected</span> OnFocusChangeListener mOnFocusChangeListener;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Listeners for layout change events.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> ArrayList&lt;OnLayoutChangeListener&gt; mOnLayoutChangeListeners;</span><br><span class="line">        <span class="keyword">protected</span> OnScrollChangeListener mOnScrollChangeListener;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Listeners for attach events.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> CopyOnWriteArrayList&lt;OnAttachStateChangeListener&gt; mOnAttachStateChangeListeners;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Listener used to dispatch click events.</span></span><br><span class="line"><span class="comment">         * This field should be made private, so it is hidden from the SDK.</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> OnClickListener mOnClickListener;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Listener used to dispatch long click events.</span></span><br><span class="line"><span class="comment">         * This field should be made private, so it is hidden from the SDK.</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">protected</span> OnLongClickListener mOnLongClickListener;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Listener used to dispatch context click events. This field should be made private, so it</span></span><br><span class="line"><span class="comment">         * is hidden from the SDK.</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">protected</span> OnContextClickListener mOnContextClickListener;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Listener used to build the context menu.</span></span><br><span class="line"><span class="comment">         * This field should be made private, so it is hidden from the SDK.</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">protected</span> OnCreateContextMenuListener mOnCreateContextMenuListener;</span><br><span class="line">        <span class="keyword">private</span> OnKeyListener mOnKeyListener;</span><br><span class="line">        <span class="keyword">private</span> OnTouchListener mOnTouchListener;</span><br><span class="line">        <span class="keyword">private</span> OnHoverListener mOnHoverListener;</span><br><span class="line">        <span class="keyword">private</span> OnGenericMotionListener mOnGenericMotionListener;</span><br><span class="line">        <span class="keyword">private</span> OnDragListener mOnDragListener;</span><br><span class="line">        <span class="keyword">private</span> OnSystemUiVisibilityChangeListener mOnSystemUiVisibilityChangeListener;</span><br><span class="line">        OnApplyWindowInsetsListener mOnApplyWindowInsetsListener;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这是一个<code>view</code>所有事件的集合类。接下来进入这段代码,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ListenerInfo li = mListenerInfo;</span><br><span class="line"><span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></span><br><span class="line">        &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">        &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</span><br><span class="line">    result = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">    result = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从这段代码我们就可以知道如果<code>mOnTouchListener !=null</code>并且当前<code>view</code>的是<code>enable=true</code>就会执行<code>li.mOnTouchListener.onTouch(this, event)</code>,执行<code>li.mOnTouchListener.onTouch(this, event)</code>返回的<code>false</code>的话就会执行<code>onTouchEvent(event)</code>。<br>从这我们就可以知道<code>OnTouchListener</code>的优先级大于<code>onTouchEvent</code>。接着我们点击<code>onTouchEvent</code>进入<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">          <span class="comment">//......代码太长  省略</span></span><br><span class="line">           <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">               <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">                   <span class="keyword">boolean</span> prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != <span class="number">0</span>;</span><br><span class="line">                   <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span> || prepressed) &#123;</span><br><span class="line">                       <span class="comment">// take focus if we don't have it already and we should in</span></span><br><span class="line">                       <span class="comment">// touch mode.</span></span><br><span class="line">                       <span class="keyword">boolean</span> focusTaken = <span class="keyword">false</span>;</span><br><span class="line">                       <span class="keyword">if</span> (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123;</span><br><span class="line">                           focusTaken = requestFocus();</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       <span class="keyword">if</span> (prepressed) &#123;</span><br><span class="line">                           <span class="comment">// The button is being released before we actually</span></span><br><span class="line">                           <span class="comment">// showed it as pressed.  Make it show the pressed</span></span><br><span class="line">                           <span class="comment">// state now (before scheduling the click) to ensure</span></span><br><span class="line">                           <span class="comment">// the user sees it.</span></span><br><span class="line">                           setPressed(<span class="keyword">true</span>, x, y);</span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                       <span class="keyword">if</span> (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123;</span><br><span class="line">                           <span class="comment">// This is a tap, so remove the longpress check</span></span><br><span class="line">                           removeLongPressCallback();</span><br><span class="line"></span><br><span class="line">                           <span class="comment">// Only perform take click actions if we were in the pressed state</span></span><br><span class="line">                           <span class="keyword">if</span> (!focusTaken) &#123;</span><br><span class="line">                               <span class="comment">// Use a Runnable and post this rather than calling</span></span><br><span class="line">                               <span class="comment">// performClick directly. This lets other visual state</span></span><br><span class="line">                               <span class="comment">// of the view update before click actions start.</span></span><br><span class="line">                               <span class="keyword">if</span> (mPerformClick == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                   mPerformClick = <span class="keyword">new</span> PerformClick();</span><br><span class="line">                               &#125;</span><br><span class="line">                               <span class="keyword">if</span> (!post(mPerformClick)) &#123;</span><br><span class="line">                                   performClick();</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       <span class="keyword">if</span> (mUnsetPressedState == <span class="keyword">null</span>) &#123;</span><br><span class="line">                           mUnsetPressedState = <span class="keyword">new</span> UnsetPressedState();</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       <span class="keyword">if</span> (prepressed) &#123;</span><br><span class="line">                           postDelayed(mUnsetPressedState,</span><br><span class="line">                                   ViewConfiguration.getPressedStateDuration());</span><br><span class="line">                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!post(mUnsetPressedState)) &#123;</span><br><span class="line">                           <span class="comment">// If the post failed, unpress right now</span></span><br><span class="line">                           mUnsetPressedState.run();</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       removeTapCallback();</span><br><span class="line">                   &#125;</span><br><span class="line">                   mIgnoreNextUpEvent = <span class="keyword">false</span>;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                   mHasPerformedLongPress = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (performButtonActionOnTouchDown(event)) &#123;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// Walk up the hierarchy to determine if we're inside a scrolling container.</span></span><br><span class="line">                   <span class="keyword">boolean</span> isInScrollingContainer = isInScrollingContainer();</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// For views inside a scrolling container, delay the pressed feedback for</span></span><br><span class="line">                   <span class="comment">// a short period in case this is a scroll.</span></span><br><span class="line">                   <span class="keyword">if</span> (isInScrollingContainer) &#123;</span><br><span class="line">                       mPrivateFlags |= PFLAG_PREPRESSED;</span><br><span class="line">                       <span class="keyword">if</span> (mPendingCheckForTap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                           mPendingCheckForTap = <span class="keyword">new</span> CheckForTap();</span><br><span class="line">                       &#125;</span><br><span class="line">                       mPendingCheckForTap.x = event.getX();</span><br><span class="line">                       mPendingCheckForTap.y = event.getY();</span><br><span class="line">                       postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">// Not inside a scrolling container, so show the feedback right away</span></span><br><span class="line">                       setPressed(<span class="keyword">true</span>, x, y);</span><br><span class="line">                       checkForLongClick(<span class="number">0</span>, x, y);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">                   setPressed(<span class="keyword">false</span>);</span><br><span class="line">                   removeTapCallback();</span><br><span class="line">                   removeLongPressCallback();</span><br><span class="line">                   mInContextButtonPress = <span class="keyword">false</span>;</span><br><span class="line">                   mHasPerformedLongPress = <span class="keyword">false</span>;</span><br><span class="line">                   mIgnoreNextUpEvent = <span class="keyword">false</span>;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                   drawableHotspotChanged(x, y);</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// Be lenient about moving outside of buttons</span></span><br><span class="line">                   <span class="keyword">if</span> (!pointInView(x, y, mTouchSlop)) &#123;</span><br><span class="line">                       <span class="comment">// Outside button</span></span><br><span class="line">                       removeTapCallback();</span><br><span class="line">                       <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</span><br><span class="line">                           <span class="comment">// Remove any future long press/tap checks</span></span><br><span class="line">                           removeLongPressCallback();</span><br><span class="line"></span><br><span class="line">                           setPressed(<span class="keyword">false</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; </span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，我们在<code>MotionEvent.ACTION_UP</code>事件里面，经过一系列的判断，然后进入到了<code>performClick()</code>这个函数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Call this view's OnClickListener, if it is defined.  Performs all normal</span></span><br><span class="line"><span class="comment">    * actions associated with clicking: reporting accessibility event, playing</span></span><br><span class="line"><span class="comment">    * a sound, etc.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> True there was an assigned OnClickListener that was called, false</span></span><br><span class="line"><span class="comment">    *         otherwise is returned.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> result;</span><br><span class="line">       <span class="keyword">final</span> ListenerInfo li = mListenerInfo;</span><br><span class="line">       <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnClickListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">           playSoundEffect(SoundEffectConstants.CLICK);</span><br><span class="line">           li.mOnClickListener.onClick(<span class="keyword">this</span>);</span><br><span class="line">           result = <span class="keyword">true</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           result = <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数很明显的就知道是执行<code>onClick</code>,从这就可以得到如下结论</p>
<blockquote>
<p><code>onClick</code>事件是在<code>onTouchEvent</code>的<code>MotionEvent.ACTION_UP</code>事件通过<code>performClick()-&gt;li.mOnClickListener.onClick(this)</code>触发的。</p>
</blockquote>
<p>到这里我们就验证了我们刚才的优先级的结论。当然在<code>onTouchEvent(MotionEvent event</code>源码中，我们在<code>MotionEvent.ACTION_DOWN</code>里面可以看到长按事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">         <span class="comment">//...</span></span><br><span class="line">         checkForLongClick(<span class="number">0</span>, x, y);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检测长按事件</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkForLongClick</span><span class="params">(<span class="keyword">int</span> delayOffset, <span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((mViewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) &#123;</span><br><span class="line">            mHasPerformedLongPress = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPendingCheckForLongPress == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPendingCheckForLongPress = <span class="keyword">new</span> CheckForLongPress();</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingCheckForLongPress.setAnchor(x, y);</span><br><span class="line">            mPendingCheckForLongPress.rememberWindowAttachCount();</span><br><span class="line">            postDelayed(mPendingCheckForLongPress,</span><br><span class="line">                    ViewConfiguration.getLongPressTimeout() - delayOffset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckForLongPress</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mOriginalWindowAttachCount;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> mX;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> mY;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (isPressed() &amp;&amp; (mParent != <span class="keyword">null</span>)</span><br><span class="line">                    &amp;&amp; mOriginalWindowAttachCount == mWindowAttachCount) &#123;</span><br><span class="line">              <span class="comment">//触发长按事件</span></span><br><span class="line">                <span class="keyword">if</span> (performLongClick(mX, mY)) &#123;</span><br><span class="line">                    mHasPerformedLongPress = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAnchor</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</span><br><span class="line">            mX = x;</span><br><span class="line">            mY = y;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rememberWindowAttachCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mOriginalWindowAttachCount = mWindowAttachCount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performLongClick</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</span><br><span class="line">        mLongClickX = x;</span><br><span class="line">        mLongClickY = y;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> handled = performLongClick();</span><br><span class="line">        mLongClickX = Float.NaN;</span><br><span class="line">        mLongClickY = Float.NaN;</span><br><span class="line">        <span class="keyword">return</span> handled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performLongClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> performLongClickInternal(mLongClickX, mLongClickY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">performLongClickInternal</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</span><br><span class="line">        sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_LONG_CLICKED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">final</span> ListenerInfo li = mListenerInfo;</span><br><span class="line">        <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLongClickListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            handled = li.mOnLongClickListener.onLongClick(View.<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!handled) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isAnchored = !Float.isNaN(x) &amp;&amp; !Float.isNaN(y);</span><br><span class="line">            handled = isAnchored ? showContextMenu(x, y) : showContextMenu();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (handled) &#123;</span><br><span class="line">            performHapticFeedback(HapticFeedbackConstants.LONG_PRESS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> handled;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>从这段代码我们又可以得到如下结论</p>
<blockquote>
<p><code>View</code>的<code>OnLongClickListener</code>是在<code>onTouchEvent</code>的<code>MotionEvent.ACTION_DOWN</code>事件通过<code>checkForLongClick()
-&gt;performLongClick(mX, mY)-&gt;performLongClick()
-&gt;performLongClickInternal(mLongClickX, mLongClickY)
-&gt;li.mOnLongClickListener.onLongClick(View.this)</code>的执行顺序触发的。</p>
</blockquote>
<p>这样<code>View</code>的<code>OnTouch</code>事件分发机制就分析得差不多，具体的判断细节等还是需要自己查看源码。</p>
<p>参考链接：<br><a href="http://www.jianshu.com/p/98d1895c409d" target="_blank" rel="noopener">http://www.jianshu.com/p/98d1895c409d</a><br><a href="http://www.jianshu.com/p/e99b5e8bd67b" target="_blank" rel="noopener">http://www.jianshu.com/p/e99b5e8bd67b</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android ViewGroup事件分发.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android ViewGroup事件分发.html" itemprop="url">Android ViewGroup事件分发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-15T09:52:57+08:00">
                2018-03-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android ViewGroup事件分发.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android ViewGroup事件分发.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,115字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  10分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上篇文章已经分析了<code>Android</code>的<code>Touch</code>事件分发。如果没看的建议先看一下。<a href="http://www.jianshu.com/p/a13f5e57b633" target="_blank" rel="noopener">Android View的Touch事件分发</a>。<br>接下来我们开始写几种场景，得出一个初步的执行顺序，然后我们按照这个顺序开始分析。</p>
<hr>
<p>首先我们自定义一个<code>ViewGroup</code>和一个<code>View</code>，然后重写相关事件进行打印:</p>
<p><strong>场景一</strong>:正常返回<code>super</code>，<code>TouchView</code>设置<code>click</code>和<code>onTouchListener</code>事件(<code>onTouch</code>返回<code>false</code>)<br><img src="http://upload-images.jianshu.io/upload_images/4658633-6ba4302be1cd6923.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="TouchViewGroup.png"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-790de5a6763b6940.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="TouchView.png"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-bbe29ff7207ed0cc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="布局.png"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-2003202ecb791716.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="TouchView设置事件.png"></p>
<p>这时候我们点击一下<code>TouchView</code>，触发事件:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-64c6505b9b5443c8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="点击一下.png"></p>
<p>可以看到触发的<code>DOWN  MOVE  UP</code>事件顺序都为:<br><code>ViewGroup.dispatchTouchEvent -&gt; ViewGroup.onInterceptTouchEvent -&gt; View.dispatchTouchEvent -&gt; View.onTouch -&gt; View.onTouchEven</code><br>只是在<code>UP</code>事件的时候最后多了一个<code>click</code>事件。</p>
<hr>
<p><strong>场景二</strong>：在<code>场景一</code>的基础上取消<code>TouchView</code>的<code>onClick</code>事件</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-ea84af196be09344.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-dcc19825bbf844e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="TouchView取消click事件.png"></p>
<p>这时候发现除了，执行的顺序变为了：<br><code>ViewGroup.dispatchTouchEvent -&gt; ViewGroup.onInterceptTouchEvent -&gt; View.dispatchTouchEvent -&gt; View.onTouch -&gt; View.onTouchEven-&gt;ViewGroup.onTouchEven</code><br>并且只有<code>DOWN</code>事件，其他事件就没有了。</p>
<hr>
<p><strong>场景三</strong>:在<code>场景二</code>的基础上<code>TouchViewGroup</code>的<code>onInterceptTouchEvent</code>里面返回<code>true</code></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-5bdd8e6463bda4ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-0ef574854c6127f9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>这个时候就只有<code>DOWN</code>事件，并且顺序为:<br><code>ViewGroup.dispatchTouchEvent -&gt; ViewGroup.onInterceptTouchEvent -&gt; ViewGroup.onTouchEvent</code></p>
<hr>
<p>接下来我们通过源码来分析:<br>首先从<code>ViewGroup</code>的<code>dispatchTouchEvent</code>入手<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">           <span class="comment">//...</span></span><br><span class="line">   		<span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</span><br><span class="line">   		<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   		<span class="comment">//1.取消之前的手势</span></span><br><span class="line">           <span class="comment">// Handle an initial down.</span></span><br><span class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">                <span class="comment">// Throw away all previous state when starting a new touch gesture.</span></span><br><span class="line">                <span class="comment">// The framework may have dropped the up or cancel event for the previous gesture</span></span><br><span class="line">                <span class="comment">// due to an app switch, ANR, or some other state change.</span></span><br><span class="line">                cancelAndClearTouchTargets(ev);</span><br><span class="line">                resetTouchState();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//2.判断是否拦截</span></span><br><span class="line">        <span class="comment">// Check for interception.</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</span><br><span class="line">           <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                   || mFirstTouchTarget != <span class="keyword">null</span>) &#123; <span class="comment">//DOWN</span></span><br><span class="line">           	<span class="comment">//父类是否拦截  getParent().requestDisallowInterceptTouchEvent();来改变值</span></span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</span><br><span class="line">               <span class="keyword">if</span> (!disallowIntercept) &#123;</span><br><span class="line">                   intercepted = onInterceptTouchEvent(ev);</span><br><span class="line">                   ev.setAction(action); <span class="comment">// restore action in case it was changed</span></span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   intercepted = <span class="keyword">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// There are no touch targets and this action is not an initial down</span></span><br><span class="line">               <span class="comment">// so this view group continues to intercept touches.</span></span><br><span class="line">               intercepted = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">    		 <span class="comment">//....</span></span><br><span class="line">		<span class="comment">//3.0   如果是不取消不拦截为down，并且dispatchTransformedTouchEvent返回为true的时候会为 mFirstTouchTarget赋值</span></span><br><span class="line">			<span class="comment">// Check for cancelation.</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> canceled = resetCancelNextUpFlag(<span class="keyword">this</span>)</span><br><span class="line">                   || actionMasked == MotionEvent.ACTION_CANCEL;</span><br><span class="line">           <span class="comment">// Update list of touch targets for pointer down, if needed.</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != <span class="number">0</span>;</span><br><span class="line">           TouchTarget newTouchTarget = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">boolean</span> alreadyDispatchedToNewTouchTarget = <span class="keyword">false</span>;</span><br><span class="line">           <span class="comment">//3.1 如果不取消并且不拦截的情况下，</span></span><br><span class="line">           <span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</span><br><span class="line">           	 <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                       || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</span><br><span class="line">                       || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;<span class="comment">// 3.2 DOWN的时候</span></span><br><span class="line">           	 	<span class="comment">//...</span></span><br><span class="line">				<span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123; </span><br><span class="line">					<span class="comment">//...</span></span><br><span class="line">					<span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">                       <span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;<span class="comment">//3.3 反序for循环，为了先拿到上层的view</span></span><br><span class="line">                       	<span class="comment">//...</span></span><br><span class="line">                       	<span class="comment">//3.4 拿到child</span></span><br><span class="line">							<span class="keyword">final</span> View child = getAndVerifyPreorderedView(preorderedList, children, childIndex);</span><br><span class="line">							<span class="comment">//...</span></span><br><span class="line">							<span class="comment">//3.5 根据child给newTouchTarget赋值   DOWN的时候因为 mFirstTouchTarget==null  所以进不去  返回的是null</span></span><br><span class="line">							newTouchTarget = getTouchTarget(child);</span><br><span class="line">                       &#125;</span><br><span class="line">                      <span class="comment">//...</span></span><br><span class="line">                       <span class="comment">//3.6. 执行操作 是执行自己的dispatchTouchEvent还是child的dispatchTouchEvent</span></span><br><span class="line">                       <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</span><br><span class="line"></span><br><span class="line">                       	<span class="comment">//...</span></span><br><span class="line">                       	<span class="comment">//3.7 子View如果返回true添加一个newTouchTarget  并且为mFirstTouchTarget赋值</span></span><br><span class="line">                       	 newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class="line">                       	 <span class="comment">//....</span></span><br><span class="line">                         &#125;</span><br><span class="line">           		&#125;	</span><br><span class="line">           	&#125;</span><br><span class="line">           &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">			<span class="comment">// Dispatch to touch targets.</span></span><br><span class="line">           <span class="keyword">if</span> (mFirstTouchTarget == <span class="keyword">null</span>) &#123;<span class="comment">//执行自身的dispatchTouchEvent</span></span><br><span class="line">               <span class="comment">// No touch targets so treat this as an ordinary view.</span></span><br><span class="line">               handled = dispatchTransformedTouchEvent(ev, canceled, <span class="keyword">null</span>,</span><br><span class="line">                       TouchTarget.ALL_POINTER_IDS);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;<span class="comment">// mFirstTouchTarget已经赋值</span></span><br><span class="line">               <span class="comment">// Dispatch to touch targets, excluding the new touch target if we already</span></span><br><span class="line">               <span class="comment">// dispatched to it.  Cancel touch targets if necessary.</span></span><br><span class="line">               TouchTarget predecessor = <span class="keyword">null</span>;</span><br><span class="line">               TouchTarget target = mFirstTouchTarget;</span><br><span class="line">               <span class="keyword">while</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">final</span> TouchTarget next = target.next;</span><br><span class="line">                   <span class="keyword">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;<span class="comment">//执行完3.7操作的</span></span><br><span class="line">                       handled = <span class="keyword">true</span>;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="keyword">final</span> <span class="keyword">boolean</span> cancelChild = resetCancelNextUpFlag(target.child)</span><br><span class="line">                               || intercepted;</span><br><span class="line">                       <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</span><br><span class="line">                               target.child, target.pointerIdBits)) &#123;</span><br><span class="line">                           handled = <span class="keyword">true</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">if</span> (cancelChild) &#123;</span><br><span class="line">                           <span class="keyword">if</span> (predecessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                               mFirstTouchTarget = next;</span><br><span class="line">                           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                               predecessor.next = next;</span><br><span class="line">                           &#125;</span><br><span class="line">                           target.recycle();</span><br><span class="line">                           target = next;</span><br><span class="line">                           <span class="keyword">continue</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                   predecessor = target;</span><br><span class="line">                   target = next;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> handled;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cancels and clears all touch targets.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAndClearTouchTargets</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> syntheticEvent = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">                event = MotionEvent.obtain(now, now,</span><br><span class="line">                        MotionEvent.ACTION_CANCEL, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0</span>);</span><br><span class="line">                event.setSource(InputDevice.SOURCE_TOUCHSCREEN);</span><br><span class="line">                syntheticEvent = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (TouchTarget target = mFirstTouchTarget; target != <span class="keyword">null</span>; target = target.next) &#123;</span><br><span class="line">                resetCancelNextUpFlag(target.child);</span><br><span class="line">                dispatchTransformedTouchEvent(event, <span class="keyword">true</span>, target.child, target.pointerIdBits);</span><br><span class="line">            &#125;</span><br><span class="line">            clearTouchTargets();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (syntheticEvent) &#123;</span><br><span class="line">                event.recycle();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清楚所有的TouchTarget</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Clears all touch targets.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearTouchTargets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TouchTarget target = mFirstTouchTarget;</span><br><span class="line">        <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                TouchTarget next = target.next;</span><br><span class="line">                target.recycle();</span><br><span class="line">                target = next;</span><br><span class="line">            &#125; <span class="keyword">while</span> (target != <span class="keyword">null</span>);</span><br><span class="line">            mFirstTouchTarget = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//根据childVie得到TouchTarget</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the touch target for specified child view.</span></span><br><span class="line"><span class="comment">     * Returns null if not found.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> TouchTarget <span class="title">getTouchTarget</span><span class="params">(@NonNull View child)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// DOWN的时候因为 mFirstTouchTarget==null  所以进不去  返回的是null</span></span><br><span class="line">        <span class="keyword">for</span> (TouchTarget target = mFirstTouchTarget; target != <span class="keyword">null</span>; target = target.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (target.child == child) &#123;</span><br><span class="line">                <span class="keyword">return</span> target;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transforms a motion event into the coordinate space of a particular child view,</span></span><br><span class="line"><span class="comment">     * filters out irrelevant pointer ids, and overrides its action if necessary.</span></span><br><span class="line"><span class="comment">     * If child is null, assumes the MotionEvent will be sent to this ViewGroup instead.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dispatchTransformedTouchEvent</span><span class="params">(MotionEvent event, <span class="keyword">boolean</span> cancel,</span></span></span><br><span class="line"><span class="function"><span class="params">            View child, <span class="keyword">int</span> desiredPointerIdBits)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//伪代码</span></span><br><span class="line">       	 <span class="keyword">final</span> <span class="keyword">boolean</span> handled;</span><br><span class="line">            <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;<span class="comment">//执行View.dispatchTouchEvent  也就是自己的dispatchTouchEvent</span></span><br><span class="line">                handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">//执行child的dispatchTouchEvent</span></span><br><span class="line">                handled = child.dispatchTouchEvent(event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> handled;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//添加TouchTarget 并且给mFirstTouchTarget赋值</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds a touch target for specified child to the beginning of the list.</span></span><br><span class="line"><span class="comment">     * Assumes the target child is not already present.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> TouchTarget <span class="title">addTouchTarget</span><span class="params">(@NonNull View child, <span class="keyword">int</span> pointerIdBits)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> TouchTarget target = TouchTarget.obtain(child, pointerIdBits);</span><br><span class="line">        target.next = mFirstTouchTarget;</span><br><span class="line">        mFirstTouchTarget = target;</span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>当<code>DOWN</code>的时候，从注释和方法名可以看出，会调用<code>cancelAndClearTouchTargets</code>,然后在调用<code>clearTouchTargets</code>使<code>mFirstTouchTarget = null</code>用来废弃上一次的触摸手势。</li>
<li>接着判断父类需不需要拦截，先通过<code>(mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0</code>来判断，在这里可以通过<code>getParent().requestDisallowInterceptTouchEvent(boolean disallowIntercept)</code>来改变值，如果上面为判断为<code>false</code>再通过<code>onInterceptTouchEvent</code>的返回值来确定,这个函数默认情况下返回<code>false</code>。</li>
<li>检测是否为取消事件，如果不是取消、不拦截并且为 <code>DOWN</code>事件的时候，就会对<code>childView</code>一个反序的<code>for</code>循环来遍历，并且执行<code>dispatchTransformedTouchEvent</code>操作，这个操作用来执行<code>dispatchTouchEvent</code>,如果<code>childView</code>是<code>null</code>的话将执行<code>View.dispatchTouchEvent</code>,也就是自己的<code>dispatchTouchEvent</code>,反之执行<code>childView</code>的<code>dispatchTouchEvent</code>，如果执行<code>dispatchTransformedTouchEvent</code>返回的值是<code>true</code>那么将会调用<code>addTouchTarget()</code>为这个<code>childView</code>生成一个<code>TouchTarget</code>并且执行<code>mFirstTouchTarget = target</code>将之赋值于<code>mFirstTouchTarget</code> ，然后跳出<code>for</code>循环遍历，<strong>这个<code>mFirstTouchTarget</code>是用于判断后续的事件<code>move up</code>等事件是否进行拦截触发函数</strong>。</li>
<li>判断操作，首先判断<code>mFirstTouchTarget</code>是否为<code>null</code>,如果是<code>DOWN</code>事件，不拦截不取消并且<code>dispatchTransformedTouchEvent</code>返回了<code>true</code>，那么将会不进入这个判断，如果不是，那么将会在这执行自身的<code>dispatchTouchEvent</code>函数并且将返回值赋于<code>handled</code>返回。进入<code>else</code>语句，在里面将其<code>mFirstTouchTarget</code>进行<code>next</code>遍历,里面的<code>if</code>语句则是<code>DOWN</code>事件下的<code>dispatchTransformedTouchEvent</code>返回<code>true</code>的情况，直接将其赋值，然后返回，里面的<code>else</code>语句则是，调用<code>dispatchTransformedTouchEvent</code>,然后将其返回值返回。</li>
</ol>
<p>到这里，ViewGroups事件分发源码的流程就分析了，我们根据这个来说说上面的场景。</p>
<p><strong>场景一</strong>：我们在<code>TouchViewGroup</code>的<code>dispatchTouchEvent</code>正常返回<code>super</code>,<code>DOWN</code>事件先触发<code>TouchViewGroup</code>的<code>dispatchTouchEvent</code>，然后就执行<code>onInterceptTouchEvent</code>是否拦截，<code>onInterceptTouchEvent</code>返回的是<code>super</code>，也就是<code>false</code>,所以就会通过<code>dispatchTransformedTouchEvent</code>来执行<code>TouchView</code>的<code>dispatchTouchEvent</code>，后面就是<code>View</code>的<code>Touch</code>事件分发了，<code>View</code>流程将会按照<code>dispatchTouchEvent-&gt;onTouchListener - &gt; onTouchEvent</code>的顺序执行，因为设置了点击事件，所以在这里就返回了<code>true</code>,这个时候就会通过<code>addTouchTarget()</code>给<code>mFirstTouchTarget</code>赋值，下面就直接返回了<code>true</code>。然后在<code>MOVE</code>和<code>UP</code>事件的时候，也是首先执行<code>dispatchTouchEvent</code>，调用<code>super</code>然后调用<code>onInterceptTouchEvent</code>询问是否拦截，还是<code>false</code>,但是这里因为不是<code>DOWN</code>事件，所以就不会进入判断对其<code>childView</code>反遍历，因为在<code>DOWN</code>的时候<code>mFirstTouchTarget</code>赋值了，所以这时候进入第4步的<code>else</code>语句里面，这时候就对其遍历执行<code>dispatchTransformedTouchEvent</code>，也就是<code>dispatchTouchEvent</code>，然后将其返回。</p>
<p><strong>场景2</strong>:我们取消了点击事件，那么在<code>DOWN</code>的时候就不会给<code>mFirstTouchTarget</code>赋值，这个时候将会进入第4步的<code>if</code>判断里面，直接调用<code>dispatchTransformedTouchEvent</code>,所以事件就不会有拦截，最终返回<code>false</code>，所以后续将不会接受到任何事件</p>
<p><strong>场景3</strong>:我们在<code>TouchViewGroup</code>的时候是在<code>onInterceptTouchEvent</code>返回<code>true</code>，所以我们<code>intercepted=true</code>，这时候就不会给<code>mFirstTouchTarget</code>赋值，这个时候就调用自身的<code>dispatchTransformedTouchEvent</code>，同样的返回<code>false</code>，后续将不会接受到事件。</p>
<p>通过源码的角度我们也知道了为什么会这么执行，初步有点模糊，我们需要通过项目慢慢的来完善对它的认知。希望对大家有所帮助。</p>
<p>参考链接：<br><a href="http://www.jianshu.com/p/98d1895c409d" target="_blank" rel="noopener">http://www.jianshu.com/p/98d1895c409d</a><br>                  <a href="http://www.jianshu.com/p/e99b5e8bd67b" target="_blank" rel="noopener">http://www.jianshu.com/p/e99b5e8bd67b</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android Handler源码分析.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android Handler源码分析.html" itemprop="url">Android Handler源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-14T09:52:57+08:00">
                2018-03-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android Handler源码分析.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android Handler源码分析.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  763字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>Handler</code>：主要用于将<code>Message</code>加入到队列<code>MessageQueue</code>中（按照时间排序）,<code>Looper</code>和<code>MessageQueue</code>中间的桥梁。</p>
<p><code>MessageQueue</code>：<code>Message</code>消息队列。通过<code>Handler</code>加入新的<code>Message</code>,通过<code>Looper</code>循环不断调用<code>next()</code>拿出要消费的<code>Message</code>来触发<code>Handler.dispatchMessage(msg)</code>然后在回收消费的<code>Message</code>。</p>
<p><code>Looper</code> ：通过<code>ThreadLocal</code>来保证每个线程只有一个<code>Looper</code>。通过<code>Looper.prepare();</code>和<code>Looper.loop();</code>来开启死循环不断取出要消费的<code>Message</code>。</p>
<p>如下图所示:</p>
<p><img src="https://github.com/ChinaZeng/YouDaoImage/blob/master/handler/handler.gif?raw=true" alt="handler"></p>
<p><code>Handler.sendMessage() --&gt;sendMessageDelyed()--&gt; MessageQueue.enqueueMessage()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(Message msg, <span class="keyword">long</span> when)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.target == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Message must have a target."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (msg.isInUse()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg + <span class="string">" This message is already in use."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                IllegalStateException e = <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                        msg.target + <span class="string">" sending message to a Handler on a dead thread"</span>);</span><br><span class="line">                Log.w(TAG, e.getMessage(), e);</span><br><span class="line">                msg.recycle();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            msg.markInUse();</span><br><span class="line">            msg.when = when;</span><br><span class="line">            Message p = mMessages;</span><br><span class="line">            <span class="keyword">boolean</span> needWake;</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</span><br><span class="line">                <span class="comment">// New head, wake up the event queue if blocked.</span></span><br><span class="line">                msg.next = p;</span><br><span class="line">                mMessages = msg;</span><br><span class="line">                needWake = mBlocked;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Inserted within the middle of the queue.  Usually we don't have to wake</span></span><br><span class="line">                <span class="comment">// up the event queue unless there is a barrier at the head of the queue</span></span><br><span class="line">                <span class="comment">// and the message is the earliest asynchronous message in the queue.</span></span><br><span class="line">                needWake = mBlocked &amp;&amp; p.target == <span class="keyword">null</span> &amp;&amp; msg.isAsynchronous();</span><br><span class="line">                Message prev;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                    prev = p;</span><br><span class="line">                    p = p.next;</span><br><span class="line">                    <span class="keyword">if</span> (p == <span class="keyword">null</span> || when &lt; p.when) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</span><br><span class="line">                        needWake = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                msg.next = p; <span class="comment">// invariant: p == prev.next</span></span><br><span class="line">                prev.next = msg;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></span><br><span class="line">            <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">                nativeWake(mPtr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如下图所示:</p>
<p><img src="https://github.com/ChinaZeng/YouDaoImage/blob/master/handler/enqueueMessage.png?raw=true" alt="enqueueMessage"></p>
<p><code>Looper.loop()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the message queue in this thread. Be sure to call</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #quit()&#125; to end the loop.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取线程的 Looper 对象</span></span><br><span class="line">        <span class="keyword">final</span> Looper me = myLooper();</span><br><span class="line">        <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取队列</span></span><br><span class="line">        <span class="keyword">final</span> MessageQueue queue = me.mQueue;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">        <span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">        Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123; <span class="comment">// 死循环不断的获取 消息队列中的消息</span></span><br><span class="line">            Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">            <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">            <span class="keyword">final</span> Printer logging = me.mLogging;</span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</span><br><span class="line">                        msg.callback + <span class="string">": "</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> traceTag = me.mTraceTag;</span><br><span class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</span><br><span class="line">                Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="comment">// 通过 handler 去执行 Message 这个时候就调用了 handleMessage 方法</span></span><br><span class="line">                msg.target.dispatchMessage(msg);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                    Trace.traceEnd(traceTag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">            <span class="comment">// identity of the thread wasn't corrupted.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</span><br><span class="line">            <span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></span><br><span class="line">                        + Long.toHexString(ident) + <span class="string">" to 0x"</span></span><br><span class="line">                        + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></span><br><span class="line">                        + msg.target.getClass().getName() + <span class="string">" "</span></span><br><span class="line">                        + msg.callback + <span class="string">" what="</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 回收消息</span></span><br><span class="line">            msg.recycleUnchecked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>避免<code>handler</code>引起的内存泄漏问题：调用<code>handler.removeCallbacksAndMessages(null)</code>清空消息队列,在置<code>handler</code>为null。因为里面的<code>Message</code>被引用，所以<code>handler</code>只让它置为<code>null</code>是没有用的。</p>
<p>epoll唤醒分析: <a href="http://blog.csdn.net/ashqal/article/details/32107099" target="_blank" rel="noopener">http://blog.csdn.net/ashqal/article/details/32107099</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/自定义View（8） -- 汽车之家折叠列表.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/自定义View（8） -- 汽车之家折叠列表.html" itemprop="url">自定义View（8） -- 汽车之家折叠列表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-13T09:52:57+08:00">
                2018-03-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自定义view/" itemprop="url" rel="index">
                    <span itemprop="name">自定义view</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/自定义View（8） -- 汽车之家折叠列表.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/自定义View（8） -- 汽车之家折叠列表.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,252字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先看看汽车之家折叠列表的效果图<br><img src="http://upload-images.jianshu.io/upload_images/4658633-dfdb8438e0fdc092.gif?imageMogr2/auto-orient/strip" alt="汽车之家折叠列表"></p>
<p>接着看看实现的效果图</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-09837d627f8381e6.gif?imageMogr2/auto-orient/strip" alt="实现的效果"></p>
<p>在这篇文章中主要采用<code>ViewDragHelper</code>这个类，这个是系统提供的一个处理<code>view</code>拖动的一个类。具体请查看相关资料，在这就不多说。<br>先来解析实现的思路，<code>view</code>的移动采用<code>ViewDragHelper</code>即可，如果下方是一般的<code>View</code>的话就差不多了，但是如果是<code>ListView</code>或者<code>RecyclerView</code>之类的话主要处理一个事件拦截的逻辑。首先要清楚<code>ListView</code>或者<code>RecyclerView</code>在处理事件的时候调用了<code>getParent().requestDisallowInterceptTouchEvent(true);</code>请求父布局不拦截事件，所以当拦截的时候不能让<code>ListView</code>或者<code>RecyclerView</code>接受到<code>MOVE</code>事件。逻辑很简单，就是当下面的<code>ListView</code>或者<code>RecyclerView</code>到顶部 并且是下拉的时候就需要使用<code>ViewDragHelper</code>来响应拖动，如果上面的菜单是打开状态的话那么也需要响应，这时候就需要拦截<code>MOVE</code>事件来处理拖动。逻辑就是这么简单，但是细节的东西有很多，不能马虎并且熟悉相关的<code>api</code>。</p>
<hr>
<p>接下来开始撸码<br>这里我选择继承<code>FrameLayout</code>,在初始化的时候创建<code>ViewDragHelper</code>，资源加载完毕了得到需要拖动的<code>mDragView</code>，在测量之后获取到最大拖动的距离，也就是上方菜单的高度,当手指抬起的时候判断是需要关闭还是打开<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">class VerticalDragListView @JvmOverloads constructor(context: Context, attrs: AttributeSet? = null, @AttrRes defStyleAttr: Int = 0)</span><br><span class="line">    : FrameLayout(context, attrs, defStyleAttr) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> var mDragView: View? = <span class="keyword">null</span><span class="comment">//拖动的view</span></span><br><span class="line">    <span class="keyword">private</span> var mMenuViewHeight: Int = <span class="number">0</span> <span class="comment">//拖动的view 高度</span></span><br><span class="line">    <span class="keyword">private</span> var mMenuIsOpen: Boolean = <span class="keyword">false</span><span class="comment">//是否打开</span></span><br><span class="line">    <span class="keyword">private</span> var mViewDragHelper: ViewDragHelper? = <span class="keyword">null</span> <span class="comment">//拖动的辅助类</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> val mCallback: ViewDragHelper.Callback = object : ViewDragHelper.Callback() &#123;</span><br><span class="line">        <span class="comment">//指定view是否可以拖动</span></span><br><span class="line">        <span class="function">override fun <span class="title">tryCaptureView</span><span class="params">(child: View, pointerId: Int)</span>: Boolean </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> mDragView == child</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回移动的距离</span></span><br><span class="line">        <span class="function">override fun <span class="title">clampViewPositionVertical</span><span class="params">(child: View?, top: Int, dy: Int)</span>: Int </span>&#123;</span><br><span class="line">            <span class="comment">//滑动的范围只能是在menu的高度</span></span><br><span class="line">            var t: Int = top</span><br><span class="line">            <span class="keyword">if</span> (top &lt;= <span class="number">0</span>) t = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> (top &gt;= mMenuViewHeight) t = mMenuViewHeight</span><br><span class="line">            <span class="keyword">return</span> t</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//手松开的时候回调 打开还是关闭</span></span><br><span class="line">        <span class="function">override fun <span class="title">onViewReleased</span><span class="params">(releasedChild: View?, xvel: Float, yvel: Float)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//打开菜单</span></span><br><span class="line">            <span class="keyword">if</span> (mDragView!!.top &gt;= mMenuViewHeight / <span class="number">2</span>) &#123;</span><br><span class="line">                mViewDragHelper?.settleCapturedViewAt(<span class="number">0</span>, mMenuViewHeight)</span><br><span class="line">                mMenuIsOpen = <span class="keyword">true</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">//关闭菜单</span></span><br><span class="line">                mViewDragHelper?.settleCapturedViewAt(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">                mMenuIsOpen = <span class="keyword">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            invalidate()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//响应滚动</span></span><br><span class="line">    <span class="function">override fun <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mViewDragHelper!!.continueSettling(<span class="keyword">true</span>)) invalidate()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    init &#123;</span><br><span class="line">        mViewDragHelper = ViewDragHelper.create(<span class="keyword">this</span>, mCallback)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onFinishInflate()</span><br><span class="line">        <span class="keyword">if</span> (childCount != <span class="number">2</span>) <span class="keyword">throw</span> RuntimeException(<span class="string">"childCount只能包含两个子布局"</span>)</span><br><span class="line">        mDragView = getChildAt(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">onLayout</span><span class="params">(changed: Boolean, left: Int, top: Int, right: Int, bottom: Int)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom)</span><br><span class="line">        <span class="keyword">if</span> (changed) mMenuViewHeight = getChildAt(<span class="number">0</span>).measuredHeight</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">onTouchEvent</span><span class="params">(event: MotionEvent?)</span>: Boolean </span>&#123;</span><br><span class="line">        mViewDragHelper?.processTouchEvent(event)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这需要注意一点，当手指松开判断打开或者关闭菜单需要调用<code>invalidate()</code>并且重写<code>computeScroll()</code>函数来响应。</p>
<p>如果下方的<code>view</code>不是<code>ListView</code>或者<code>RecyclerView</code>之类的话，到这就可以了，但是实际开发中，下方一般是这种，所以就需要按照上面说的处理事件拦截<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> var mDownY: Float = <span class="number">0.0f</span></span><br><span class="line">   <span class="function">override fun <span class="title">onInterceptTouchEvent</span><span class="params">(ev: MotionEvent?)</span>: Boolean </span>&#123;</span><br><span class="line">       <span class="comment">// 菜单打开要拦截</span></span><br><span class="line">       <span class="keyword">if</span> (mMenuIsOpen) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 向下滑动拦截，不让ListView或者RecyclerView做处理</span></span><br><span class="line">       <span class="comment">// 谁拦截谁 父View拦截子View ，但是子 View 可以调这个方法</span></span><br><span class="line">       <span class="comment">// requestDisallowInterceptTouchEvent 请求父View不要拦截，改变的其实就是 mGroupFlags 的值</span></span><br><span class="line">       when (ev!!.action) &#123;</span><br><span class="line">           MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">               mDownY = ev.y</span><br><span class="line">               <span class="comment">// 让 DragHelper 拿一个完整的事件</span></span><br><span class="line">               mViewDragHelper!!.processTouchEvent(ev)</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line">               val moveY = ev.y</span><br><span class="line">               <span class="keyword">if</span> (moveY - mDownY &gt; <span class="number">0</span> &amp;&amp; !canChildScrollUp()) &#123;</span><br><span class="line">                   <span class="comment">// 向下滑动 &amp;&amp; 滚动到了顶部，拦截不让ListView或者RecyclerView做处理</span></span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">true</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">super</span>.onInterceptTouchEvent(ev)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> Whether it is possible for the child view of this layout to</span></span><br><span class="line"><span class="comment">    * *         scroll up. Override this if the child view is a custom view.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">fun <span class="title">canChildScrollUp</span><span class="params">()</span>: Boolean </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &lt; <span class="number">14</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (mDragView is AbsListView) &#123;</span><br><span class="line">               val absListView = mDragView as AbsListView</span><br><span class="line">               <span class="keyword">return</span> absListView.childCount &gt; <span class="number">0</span> &amp;&amp; (absListView.firstVisiblePosition &gt; <span class="number">0</span> || absListView.getChildAt(<span class="number">0</span>)</span><br><span class="line">                       .top &lt; absListView.paddingTop)</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> ViewCompat.canScrollVertically(mDragView, -<span class="number">1</span>) || mDragView!!.scrollY &gt; <span class="number">0</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> ViewCompat.canScrollVertically(mDragView, -<span class="number">1</span>)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里需要注意，如果不在<code>ACTION_DOWN</code>的时候调用<code>mViewDragHelper.processTouchEvent(ev)</code>的话，那么<code>ViewDragHelper</code>将会报错，将不会触发拖动事件<br><img src="http://upload-images.jianshu.io/upload_images/4658633-82de43e0c3b29414.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>从字面意思都可以看出需要一个完整的事件，所以需要在<code>ACTION_DOWN</code>的时候调用<code>ViewDragHelper.processTouchEvent(ev)</code></p>
<hr>
<p>在一步步的分析之下，这个效果就慢慢的完成了。有了新需求的时候，在动手应该理清思路，然后想好使用相关的<code>api</code>，处理一些手势可以使用<code>OnGestureListener</code>,处理拖动可以使用<code>ViewDragHelper</code>，这些都是系统封装好的辅助类，应该要合理的利用这些辅助类。相信如果不使用这些辅助类也可以写出这些效果，但是那样的话也会浪费大量的事件和精力，而且很容易出错。</p>
<p>本文源码下载地址：<a href="https://github.com/ChinaZeng/CustomView" target="_blank" rel="noopener">https://github.com/ChinaZeng/CustomView</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/自定义View（7） -- 酷狗侧滑菜单.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/自定义View（7） -- 酷狗侧滑菜单.html" itemprop="url">自定义View（7） -- 酷狗侧滑菜单</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-12T09:52:57+08:00">
                2018-03-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自定义view/" itemprop="url" rel="index">
                    <span itemprop="name">自定义view</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/自定义View（7） -- 酷狗侧滑菜单.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/自定义View（7） -- 酷狗侧滑菜单.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,865字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  14分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/4658633-558bd5c0a1eaf3ac.gif?imageMogr2/auto-orient/strip" alt="效果图"><br>上一篇我们自定义了一个流式布局的<code>ViewGroup</code>,我们为了熟悉自定义<code>ViewGroup</code>,就继续自定义<code>ViewGroup</code>。这篇的内容是是仿照酷狗的侧滑菜单。<br>我们写代码之前，先想清楚是怎么实现，解析实现的步骤。实现侧滑的方式很多种，在这里我选择继承<code>HorizontalScrollView</code>，为什么继承这个呢？因为继承这个的话，我们就不用写<code>childView</code>的<code>move   meause  layout</code>，这样就节约了很大的代码量和事件，因为内部<code>HorizontalScrollView</code>已经封装好了。我们在这个控件里面放置两个<code>childView</code>，一个是<code>menu</code>,一个是<code>content</code>。然后我们处理拦截和快速滑动事件就可以了。思路想清楚了我们就开始撸码。<br>首先我们自定义一个属性，用于打开的时候<code>content</code>还有多少可以看到，也就是打开的时候<code>menu</code>距离右边的距离。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"SkiddingMenuLayout"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"menuRightMargin"</span> <span class="attr">format</span>=<span class="string">"dimension"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在初始化的时候我们通过<code>menuRightMargin</code>属性获取<code>menu</code>真正的宽度<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SkiddingMenuLayout</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SkiddingMenuLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SkiddingMenuLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化自定义属性</span></span><br><span class="line">        TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.SkiddingMenuLayout);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> rightMargin = array.getDimension(</span><br><span class="line">                R.styleable.SkiddingMenuLayout_menuRightMargin, DisplayUtil.dip2px(context, <span class="number">50</span>));</span><br><span class="line">        <span class="comment">// 菜单页的宽度是 = 屏幕的宽度 - 右边的一小部分距离（自定义属性）</span></span><br><span class="line">        mMenuWidth = (<span class="keyword">int</span>) (DisplayUtil.getScreenWidth(context) - rightMargin);</span><br><span class="line">        array.recycle();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>接着我们在布局加载完毕的时候我们指定<code>menu</code>和<code>content</code>的宽度<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//xml 布局解析完毕回调的方法</span><br><span class="line">    @Override</span><br><span class="line">    protected void onFinishInflate() &#123;</span><br><span class="line">        super.onFinishInflate();</span><br><span class="line">        //指定宽高</span><br><span class="line">        //先拿到整体容器</span><br><span class="line">        ViewGroup container = (ViewGroup) getChildAt(0);</span><br><span class="line"></span><br><span class="line">        int childCount = container.getChildCount();</span><br><span class="line">        if (childCount != 2)</span><br><span class="line">            throw new RuntimeException("只能放置两个子View");</span><br><span class="line">        //菜单</span><br><span class="line">        mMenuView = container.getChildAt(0);</span><br><span class="line">        ViewGroup.LayoutParams meauParams = mMenuView.getLayoutParams();</span><br><span class="line">        meauParams.width = mMenuWidth;</span><br><span class="line">        //7.0一下的不加这句代码是正常的   7.0以上的必须加</span><br><span class="line">        mMenuView.setLayoutParams(meauParams);</span><br><span class="line"></span><br><span class="line">        //内容页</span><br><span class="line">        mContentView = container.getChildAt(1);</span><br><span class="line">        ViewGroup.LayoutParams contentParams = mContentView.getLayoutParams();</span><br><span class="line">        contentParams.width = DisplayUtil.getScreenWidth(getContext());</span><br><span class="line">        //7.0一下的不加这句代码是正常的   7.0以上的必须加</span><br><span class="line">        mContentView.setLayoutParams(contentParams);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里有一个细节，我们在刚进入的时候，菜单默认是关闭的，所以我们需要调用<code>scrollTo()</code>函数移动一下位置，但是发现在<code>onFinishInflate()</code>函数里面调用没有作用,这个是为什么呢？因为我们在<code>xml</code>加载完毕之后，才会真正的执行<code>View</code>的绘制流程，这时候调用<code>scrollTo()</code>这个函数其实是执行了代码的，但是在<code>onLaout()</code>摆放<code>childView</code>的时候，又默认回到了<code>(0,0)</code>位置，所以我们应该在<code>onLayout()</code>之后调用这个函数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onLayout(changed, l, t, r, b);</span><br><span class="line">        <span class="comment">//进入是关闭状态</span></span><br><span class="line">        scrollTo(mMenuWidth, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>初始化完毕了，接下来我们进行事件的拦截，<code>MOVE</code>的时候相应滑动事件，<code>UP</code>的时候判断是关闭还是打开，然后调用函数即可<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//手指抬起是二选一，要么关闭要么打开</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//    当菜单打开的时候，手指触摸右边内容部分需要关闭菜单，还需要拦截事件（打开情况下点击内容页不会响应点击事件）</span></span><br><span class="line">        <span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_UP) &#123;</span><br><span class="line">            <span class="comment">// 只需要管手指抬起 ，根据我们当前滚动的距离来判断</span></span><br><span class="line">            <span class="keyword">int</span> currentScrollX = getScrollX();</span><br><span class="line">            <span class="keyword">if</span> (currentScrollX &gt; mMenuWidth / <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="comment">// 关闭</span></span><br><span class="line">                closeMenu();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 打开</span></span><br><span class="line">                openMenu();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打开菜单 滚动到 0 的位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// smoothScrollTo 有动画</span></span><br><span class="line">        smoothScrollTo(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭菜单 滚动到 mMenuWidth 的位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        smoothScrollTo(mMenuWidth, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>到这的话，滑动事件和打开关闭事件都完成了，接下来我们就处理一个效果的问题，这里当从左往右滑动的时候，是慢慢打开菜单，这时候<code>content</code>是有一个慢慢的缩放,<code>menu</code>有一个放大和透明度变小，而反过来关闭菜单的话就是相反的效果，<code>content</code>慢慢放大，<code>menu</code>缩小和透明度变大。这里还有一个细节，就是<code>menu</code>慢慢的退出和进入，滑动的距离不是和移动的距离相同的，所以这里还有一个平移。接下来重写<code>onScrollChanged()</code>函数，然后计算出一个梯度值来做处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//滑动改变触发</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onScrollChanged</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> oldl, <span class="keyword">int</span> oldt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onScrollChanged(l, t, oldl, oldt);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        //抽屉效果  两种一样</span></span><br><span class="line"><span class="comment">//        ViewCompat.setTranslationX(mMenuView, l);</span></span><br><span class="line"><span class="comment">//        ViewCompat.setX(mMenuView, l);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        Log.e("zzz", "l-&gt;" + l + " t-&gt;" + t + " oldl-&gt;" + oldl + " oldt-&gt;" + oldt);</span></span><br><span class="line">        <span class="comment">//主要看l  手指从左往右滑动 由大变小</span></span><br><span class="line">        <span class="comment">//计算一个梯度值 1-&gt;0</span></span><br><span class="line">        <span class="keyword">float</span> scale = <span class="number">1.0f</span> * l / mMenuWidth;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//酷狗侧滑效果...</span></span><br><span class="line"><span class="comment">//        //右边的缩放 最小是0.7f ，最大是1.0f</span></span><br><span class="line">        <span class="keyword">float</span> rightScale = <span class="number">0.7f</span> + <span class="number">0.3f</span> * scale;</span><br><span class="line">        <span class="comment">//设置mContentView缩放的中心点位置</span></span><br><span class="line">        ViewCompat.setPivotX(mContentView, <span class="number">0</span>);</span><br><span class="line">        ViewCompat.setPivotY(mContentView, mContentView.getHeight() / <span class="number">2</span>);</span><br><span class="line">        <span class="comment">//设置右边缩放</span></span><br><span class="line">        ViewCompat.setScaleX(mContentView, rightScale);</span><br><span class="line">        ViewCompat.setScaleY(mContentView, rightScale);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//菜单</span></span><br><span class="line">        <span class="comment">//透明度是半透明到全透明  0.5f-1.0f</span></span><br><span class="line">        <span class="keyword">float</span> alpha = <span class="number">0.5f</span> + (<span class="number">1.0f</span> - scale) * <span class="number">0.5f</span>;</span><br><span class="line">        ViewCompat.setAlpha(mMenuView, alpha);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//缩放  0.7-1.0</span></span><br><span class="line">        <span class="keyword">float</span> leftScale = <span class="number">0.7f</span> + <span class="number">0.3f</span> * (<span class="number">1</span> - scale);</span><br><span class="line">        ViewCompat.setScaleX(mMenuView, leftScale);</span><br><span class="line">        ViewCompat.setScaleY(mMenuView, leftScale);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//退出按钮在右边</span></span><br><span class="line">        ViewCompat.setTranslationX(mMenuView, <span class="number">0.2f</span> * l);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这样的话我们就完成了效果，但是我们还有几个细节没有处理，首先是快速滑动的问题，还有一个是当打开<code>menu</code>的时候，点击<code>content</code>需要关闭菜单，而不是相应对应的事件。接下来我们对这两个问题进行处理。</p>
<p>快速滑动问题，这个问题我们采用<code>GestureDetector</code>这个类来做处理，这个类可以处理很多收拾问题:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The listener that is used to notify when gestures occur.</span></span><br><span class="line"><span class="comment">     * If you want to listen for all the different gestures then implement</span></span><br><span class="line"><span class="comment">     * this interface. If you only want to listen for a subset it might</span></span><br><span class="line"><span class="comment">     * be easier to extend &#123;<span class="doctag">@link</span> SimpleOnGestureListener&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnGestureListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Notified when a tap occurs with the down &#123;<span class="doctag">@link</span> MotionEvent&#125;</span></span><br><span class="line"><span class="comment">         * that triggered it. This will be triggered immediately for</span></span><br><span class="line"><span class="comment">         * every down event. All other events should be preceded by this.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e The down motion event.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onDown</span><span class="params">(MotionEvent e)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The user has performed a down &#123;<span class="doctag">@link</span> MotionEvent&#125; and not performed</span></span><br><span class="line"><span class="comment">         * a move or up yet. This event is commonly used to provide visual</span></span><br><span class="line"><span class="comment">         * feedback to the user to let them know that their action has been</span></span><br><span class="line"><span class="comment">         * recognized i.e. highlight an element.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e The down motion event</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onShowPress</span><span class="params">(MotionEvent e)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Notified when a tap occurs with the up &#123;<span class="doctag">@link</span> MotionEvent&#125;</span></span><br><span class="line"><span class="comment">         * that triggered it.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e The up motion event that completed the first tap</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> true if the event is consumed, else false</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onSingleTapUp</span><span class="params">(MotionEvent e)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Notified when a scroll occurs with the initial on down &#123;<span class="doctag">@link</span> MotionEvent&#125; and the</span></span><br><span class="line"><span class="comment">         * current move &#123;<span class="doctag">@link</span> MotionEvent&#125;. The distance in x and y is also supplied for</span></span><br><span class="line"><span class="comment">         * convenience.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e1 The first down motion event that started the scrolling.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e2 The move motion event that triggered the current onScroll.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> distanceX The distance along the X axis that has been scrolled since the last</span></span><br><span class="line"><span class="comment">         *              call to onScroll. This is NOT the distance between &#123;<span class="doctag">@code</span> e1&#125;</span></span><br><span class="line"><span class="comment">         *              and &#123;<span class="doctag">@code</span> e2&#125;.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> distanceY The distance along the Y axis that has been scrolled since the last</span></span><br><span class="line"><span class="comment">         *              call to onScroll. This is NOT the distance between &#123;<span class="doctag">@code</span> e1&#125;</span></span><br><span class="line"><span class="comment">         *              and &#123;<span class="doctag">@code</span> e2&#125;.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> true if the event is consumed, else false</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onScroll</span><span class="params">(MotionEvent e1, MotionEvent e2, <span class="keyword">float</span> distanceX, <span class="keyword">float</span> distanceY)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Notified when a long press occurs with the initial on down &#123;<span class="doctag">@link</span> MotionEvent&#125;</span></span><br><span class="line"><span class="comment">         * that trigged it.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e The initial on down motion event that started the longpress.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onLongPress</span><span class="params">(MotionEvent e)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Notified of a fling event when it occurs with the initial on down &#123;<span class="doctag">@link</span> MotionEvent&#125;</span></span><br><span class="line"><span class="comment">         * and the matching up &#123;<span class="doctag">@link</span> MotionEvent&#125;. The calculated velocity is supplied along</span></span><br><span class="line"><span class="comment">         * the x and y axis in pixels per second.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e1 The first down motion event that started the fling.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e2 The move motion event that triggered the current onFling.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> velocityX The velocity of this fling measured in pixels per second</span></span><br><span class="line"><span class="comment">         *              along the x axis.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> velocityY The velocity of this fling measured in pixels per second</span></span><br><span class="line"><span class="comment">         *              along the y axis.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> true if the event is consumed, else false</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onFling</span><span class="params">(MotionEvent e1, MotionEvent e2, <span class="keyword">float</span> velocityX, <span class="keyword">float</span> velocityY)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The listener that is used to notify when a double-tap or a confirmed</span></span><br><span class="line"><span class="comment">     * single-tap occur.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnDoubleTapListener</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Notified when a single-tap occurs.</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;</span></span><br><span class="line"><span class="comment">         * Unlike &#123;<span class="doctag">@link</span> OnGestureListener#onSingleTapUp(MotionEvent)&#125;, this</span></span><br><span class="line"><span class="comment">         * will only be called after the detector is confident that the user's</span></span><br><span class="line"><span class="comment">         * first tap is not followed by a second tap leading to a double-tap</span></span><br><span class="line"><span class="comment">         * gesture.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e The down motion event of the single-tap.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> true if the event is consumed, else false</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onSingleTapConfirmed</span><span class="params">(MotionEvent e)</span></span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Notified when a double-tap occurs.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e The down motion event of the first tap of the double-tap.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> true if the event is consumed, else false</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onDoubleTap</span><span class="params">(MotionEvent e)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Notified when an event within a double-tap gesture occurs, including</span></span><br><span class="line"><span class="comment">         * the down, move, and up events.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e The motion event that occurred during the double-tap gesture.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> true if the event is consumed, else false</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onDoubleTapEvent</span><span class="params">(MotionEvent e)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The listener that is used to notify when a context click occurs. When listening for a</span></span><br><span class="line"><span class="comment">     * context click ensure that you call &#123;<span class="doctag">@link</span> #onGenericMotionEvent(MotionEvent)&#125; in</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> View#onGenericMotionEvent(MotionEvent)&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnContextClickListener</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Notified when a context click occurs.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e The motion event that occurred during the context click.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> true if the event is consumed, else false</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onContextClick</span><span class="params">(MotionEvent e)</span></span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们主要是响应<code>onFling()</code>这个函数，然后判断当前是打开还是关闭状态，在根据快速滑动的手势来执行打开还是关闭的操作:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (mGestureDetector.onTouchEvent(ev))<span class="comment">//快速滑动触发了下面的就不要执行了</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;      </span><br><span class="line">      </span><br><span class="line">            <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//快速滑动</span></span><br><span class="line">    <span class="keyword">private</span> GestureDetector.OnGestureListener mOnGestureListener = <span class="keyword">new</span> GestureDetector.SimpleOnGestureListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onFling</span><span class="params">(MotionEvent e1, MotionEvent e2, <span class="keyword">float</span> velocityX, <span class="keyword">float</span> velocityY)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//快速滑动回调</span></span><br><span class="line">            <span class="comment">//打开的时候从右到左滑动关闭   关闭的时候从左往右打开</span></span><br><span class="line"><span class="comment">//            Log.e("zzz", "velocityX-&gt;" + velocityX);</span></span><br><span class="line">            <span class="comment">// &gt;0 从左往右边滑动  &lt;0 从右到左</span></span><br><span class="line">            <span class="keyword">if</span> (mMenuIsOpen) &#123;</span><br><span class="line">                <span class="keyword">if</span> (velocityX &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    closeMenu();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (velocityX &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    openMenu();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onFling(e1, e2, velocityX, velocityY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure></p>
<p>接下来处理<code>menu</code>打开状态下点击<code>content</code>关闭<code>menu</code>，这里我们需要用到<code>onInterceptTouchEvent</code>。当打开状态的时候，我们就把这个事件拦截，然后关闭菜单即可。但是这里有一个问题，当我们拦截了<code>DOWN</code>事件之后，后面的<code>MOVE  UP</code>事件都会被拦截并且相应自身的<code>onTouchEvent</code>事件，所以这里我们需要添加一个判断值，判断是否拦截，然后让其<code>onTouchEvent</code>是否继续执行操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">        isIntercept = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mMenuIsOpen &amp;&amp; ev.getX() &gt; mMenuWidth) &#123;<span class="comment">//打开状态  触摸右边关闭</span></span><br><span class="line">            isIntercept = <span class="keyword">true</span>;<span class="comment">//拦截的话就不执行自己的onTouchEvent</span></span><br><span class="line">            closeMenu();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onInterceptTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isIntercept)<span class="comment">//拦截的话就不执行自己的onTouchEvent</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<p>根据我们提出需求，然后分析需求，再完成需求。这一步步我们慢慢进行渗透，最终完成效果，完成之后你会发现其实也就那么一回事。当我们有新需求的时候，我们应该不要恐惧，应该欣然乐观的接收，再慢慢分析，最终完成。这样的话我们才能提高我们的技术。</p>
<p>本文源码下载地址:<a href="https://github.com/ChinaZeng/CustomView" target="_blank" rel="noopener">https://github.com/ChinaZeng/CustomView</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/自定义View（6） -- 流式布局.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/自定义View（6） -- 流式布局.html" itemprop="url">自定义View（6） -- 流式布局</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-11T09:52:57+08:00">
                2018-03-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自定义view/" itemprop="url" rel="index">
                    <span itemprop="name">自定义view</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/自定义View（6） -- 流式布局.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/自定义View（6） -- 流式布局.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,715字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  8分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先看效果图：<br><img src="http://upload-images.jianshu.io/upload_images/4658633-f7a783b28bb5db3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="tagLayout"></p>
<p>上几次都是自定义的<code>view</code>，这期我们来自定义一个简单的<code>ViewGroup</code>。和自定义<code>view</code>不同的是，<code>viewGroup</code>一般情况下是管理<code>childView</code>，所以主要是重写<code>onMeause()</code>来测量<code>childView</code>宽高，从而设置自身宽高，然后重写<code>onLayout</code>来摆放<code>childView</code>的位置，我们一般不对<code>viewGroup</code>进行绘制，如果特殊情况需要绘制，重写<code>dispatchDraw()</code>来进行重绘，因为<code>viewGroup</code>在不设置设置背景的情况下是不会调用<code>onDraw()</code>的，具体请看源码。</p>
<hr>
<p>接下来进行我们这篇文章的主题，先理清楚思路，我们实现的效果就是一个容器里面的<code>childView</code>挨着挨着的从左往右摆放，如果摆放的时候这个<code>childView</code>的宽度加上这行前面的<code>childView</code>宽度大于当前设置的宽度的时候，那么就需要换行。<br>初始化和属性我就不说了，如需要可以自行添加，这里我们要考略到<code>childView</code>的<code>margin</code>,所以我们仿照<code>LinearLayout</code>来重写<code>generateLayoutParams</code>函数来设置一个带有<code>margin</code>属性的<code>LayoutParams</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置自己需要的LayoutParams</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> LayoutParams <span class="title">generateLayoutParams</span><span class="params">(AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MarginLayoutParams(getContext(), attrs);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>重写<code>onMeause()</code>来进行<code>childView</code>的遍历测量，并且设置自生的宽高，因为我们考略到下面要重写<code>onLayout</code>来摆放<code>childView</code>的位置，难免会有一番计算，我们为了不重复计算，所以写了一个<code>List</code>来进行对<code>childView</code>以行为单位来组装，具体如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"> private List&lt;List&lt;View&gt;&gt; mChildViews = new ArrayList&lt;&gt;();</span><br><span class="line">    // 指定宽高</span><br><span class="line">    @Override</span><br><span class="line">    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">        super.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">        // 清空集合</span><br><span class="line">        mChildViews.clear();</span><br><span class="line"></span><br><span class="line">        int childCount = getChildCount();</span><br><span class="line"></span><br><span class="line">        // 获取到宽度</span><br><span class="line">        int width = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line"></span><br><span class="line">        // 高度需要计算</span><br><span class="line">        int height = getPaddingTop() + getPaddingBottom();</span><br><span class="line"></span><br><span class="line">        // 一行的宽度</span><br><span class="line">        int lineWidth = getPaddingLeft();</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;View&gt; childViews = new ArrayList&lt;&gt;();</span><br><span class="line">        mChildViews.add(childViews);</span><br><span class="line"></span><br><span class="line">        // 子View高度不一致的情况下</span><br><span class="line">        int maxHeight = 0;</span><br><span class="line">        for (int i = 0; i &lt; childCount; i++) &#123;</span><br><span class="line">            // for循环测量子View</span><br><span class="line">            View childView = getChildAt(i);</span><br><span class="line">            if (childView.getVisibility() == GONE) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            // 这段话执行之后就可以获取子View的宽高，因为会调用子View的onMeasure</span><br><span class="line">            measureChild(childView, widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">            // margin值 ViewGroup.LayoutParams 没有 就用系统的MarginLayoutParams</span><br><span class="line">            // LinearLayout有自己的 LayoutParams  会复写一个非常重要的方法</span><br><span class="line">            MarginLayoutParams params = (MarginLayoutParams) childView.getLayoutParams();</span><br><span class="line">            // 什么时候需要换行，一行不够的情况下 考虑 margin</span><br><span class="line">            if (lineWidth + (childView.getMeasuredWidth() + params.rightMargin + params.leftMargin) &gt; width) &#123;</span><br><span class="line">                // 换行,累加高度  加上一行条目中最大的高度</span><br><span class="line">                height += maxHeight;</span><br><span class="line"></span><br><span class="line">                //下面重新初始化</span><br><span class="line">                maxHeight = childView.getMeasuredHeight() + params.bottomMargin + params.topMargin;</span><br><span class="line">                lineWidth = childView.getMeasuredWidth() + params.rightMargin + params.leftMargin;</span><br><span class="line">                childViews = new ArrayList&lt;&gt;();</span><br><span class="line">                mChildViews.add(childViews);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                lineWidth += childView.getMeasuredWidth() + params.rightMargin + params.leftMargin;</span><br><span class="line">                maxHeight = Math.max(childView.getMeasuredHeight() + params.bottomMargin + params.topMargin, maxHeight);</span><br><span class="line">            &#125;</span><br><span class="line">            childViews.add(childView);</span><br><span class="line">        &#125;</span><br><span class="line">        height += maxHeight;//不要忘记最后一行的高度</span><br><span class="line"></span><br><span class="line">//        Log.e(&quot;TAG&quot;, &quot;width -&gt; &quot; + width + &quot; height-&gt; &quot; + height);</span><br><span class="line">        // 根据子View计算和指定自己的宽高</span><br><span class="line">        setMeasuredDimension(width, height);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后我们根据上面的组装的<code>List</code>数据来进行对<code>childView</code>进行摆放<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> left, top = getPaddingTop(), right, bottom;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (List&lt;View&gt; childViews : mChildViews) &#123;</span><br><span class="line">            left = getPaddingLeft();</span><br><span class="line">            <span class="keyword">int</span> maxHeight = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (View childView : childViews) &#123;</span><br><span class="line">                <span class="keyword">if</span> (childView.getVisibility() == GONE) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                MarginLayoutParams params = (MarginLayoutParams) childView.getLayoutParams();</span><br><span class="line">                left += params.leftMargin;</span><br><span class="line">                <span class="keyword">int</span> childTop = top + params.topMargin;</span><br><span class="line">                right = left + childView.getMeasuredWidth();</span><br><span class="line">                bottom = childTop + childView.getMeasuredHeight();</span><br><span class="line"><span class="comment">//                Log.e("TAG", "left -&gt; " + left + " top-&gt; " + childTop + " right -&gt; " + right + " bottom-&gt; " + bottom);</span></span><br><span class="line">                <span class="comment">// 摆放</span></span><br><span class="line">                childView.layout(left, childTop, right, bottom);</span><br><span class="line">                <span class="comment">// left 叠加</span></span><br><span class="line">                left += childView.getMeasuredWidth() + params.rightMargin;</span><br><span class="line">                <span class="comment">// 不断的叠加top值</span></span><br><span class="line">                <span class="keyword">int</span> childHeight = childView.getMeasuredHeight() + params.topMargin + params.bottomMargin;</span><br><span class="line">                maxHeight = Math.max(maxHeight, childHeight);</span><br><span class="line">            &#125;</span><br><span class="line">            top += maxHeight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>主要的逻辑代码已经写的很清楚了，细致一看就能很容易的理解。这样的画效果就实现了，但是我们在实际开发的过程中，一般是后台获取到一个<code>List</code>数据，然后我们在设置值，这里推荐一个设计模式就是<code>Adapter</code>模式。这样的话我们就可以自定义自己的<code>View</code>，轻松的降低了代码的耦合，并且复用效果也好,我们申明一个`Adapter’类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Email 240336124@qq.com</span></span><br><span class="line"><span class="comment"> * Created by Darren on 2017/6/11.</span></span><br><span class="line"><span class="comment"> * Version 1.0</span></span><br><span class="line"><span class="comment"> * Description: 流式布局的Adapter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.有多少个条目</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.getView通过position</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position,ViewGroup parent)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里就简单写了，然后我们在容器中添加<code>setAdapter()</code>函数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 设置Adapter</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> adapter</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAdapter</span><span class="params">(BaseAdapter adapter)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (adapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"adapter is null"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 清空所有子View</span></span><br><span class="line">       removeAllViews();</span><br><span class="line">       mAdapter = adapter;</span><br><span class="line">       <span class="comment">// 获取数量</span></span><br><span class="line">       <span class="keyword">int</span> childCount = mAdapter.getCount();</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">           <span class="comment">// 通过位置获取View</span></span><br><span class="line">           View childView = mAdapter.getView(i, <span class="keyword">this</span>);</span><br><span class="line">           addView(childView);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后我们使用就和<code>ListView</code>类似了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> TagLayout mTagLayout;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> List&lt;String&gt; mItems;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_taglayout);</span><br><span class="line">       mTagLayout = (TagLayout) findViewById(R.id.taglayout);</span><br><span class="line"></span><br><span class="line">       mItems = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">           mItems.add(<span class="string">"ABC"</span>+i);</span><br><span class="line">       &#125;</span><br><span class="line">       mTagLayout.setAdapter(<span class="keyword">new</span> BaseAdapter() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">return</span> mItems.size();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">               TextView tagTv = (TextView) LayoutInflater.from(TagLayoutActivity.<span class="keyword">this</span>)</span><br><span class="line">                       .inflate(R.layout.item_tag, parent, <span class="keyword">false</span>);</span><br><span class="line">               tagTv.setText(mItems.get(position));</span><br><span class="line">               <span class="comment">// 操作ListView的方式差不多</span></span><br><span class="line">               <span class="keyword">return</span> tagTv;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这样的话我们就简单的实现了流式布局的效果，如果需要单选多选之类的，在这基础上添加就可以了。<br>接下来再具体的总结下自定义<code>view</code>和自定义<code>viewGroup</code>的套路:</p>
<blockquote>
<p>######<code>View</code>的自定义套路</p>
<ol>
<li>初始化，自定义属性，获取自定义属性<strong>(配置属性)</strong></li>
<li><code>onMeasure()</code>方法用于测量计算自己的宽高，前提是继承自<code>View</code>，如果是继承自系统已有的 <code>TextView</code> , <code>Button</code>,已经给你计算好了宽高，就可以跳过这个步骤<strong>(设置宽高)</strong></li>
<li><code>onDraw()</code> 用于绘制自己的显示<strong>(<code>View</code>绘制)</strong></li>
<li><code>onTouch()</code> 用于与用户交互<strong>(事件分发)</strong></li>
</ol>
</blockquote>
<hr>
<blockquote>
<p>######<code>ViewGroup</code>的自定义套路</p>
<ol>
<li>自定义属性，获取自定义属性，很少有这种需求<strong>(配置属性)</strong><br>2.<code>onMeasure()</code>方法，<code>for</code>循环测量子<code>View</code>，根据<code>子View</code>的宽高来计算自己的宽高<strong>(设置宽高)</strong></li>
<li><code>onLayout()</code>用来摆放子View，前提是不是<code>GONE</code>的情况</li>
<li><code>onDraw()</code>一般不需要，默认情况下是不会调用，如果你要绘制需要实现<code>dispatchDraw()</code>方法<strong>(<code>View</code>绘制)</strong></li>
<li>在很多情况下不会继承自<code>ViewGroup</code> ，往往是继承 系统已经提供好的<code>ViewGroup</code> 如 <code>ViewPager ScrollView  RelativeLayout</code>,这样的话<code>onMeause()  onLayout()</code>一般都可以跳过，相应的重写一些方法来实现自己的需求。比如侧滑菜单可以继承<code>LinearLayout</code> 或者<code>RelativeLayout</code>等来重写<code>onInterceptTouchEvent</code>来实现。</li>
</ol>
</blockquote>
<p>这篇文章到这就结束了 ，希望对大家有所提升。</p>
<p>下载地址:<a href="https://github.com/ChinaZeng/CustomView" target="_blank" rel="noopener">https://github.com/ChinaZeng/CustomView</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/自定义View（5） -- 评分控件RatingBar.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/自定义View（5） -- 评分控件RatingBar.html" itemprop="url">自定义View（5） -- 评分控件RatingBar</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-10T09:52:57+08:00">
                2018-03-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自定义view/" itemprop="url" rel="index">
                    <span itemprop="name">自定义view</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/自定义View（5） -- 评分控件RatingBar.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/自定义View（5） -- 评分控件RatingBar.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,331字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先看效果图:<br><img src="http://upload-images.jianshu.io/upload_images/4658633-eb95f74dd941b0f1.gif?imageMogr2/auto-orient/strip" alt="评分.gif"><br>在我们画这个控件之前，我们想想一下怎么实现这个，显示对星星的处理，我们是自己绘制还是使用图片？其实都是可以的，但是我们为了更加快速的完成这个，我们选择了使用图片来完成。先自定义属性，在这个例子中我定义如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"RatingBar"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--未选中引用--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"starNormal"</span> <span class="attr">format</span>=<span class="string">"reference"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--选中引用--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"starFocus"</span> <span class="attr">format</span>=<span class="string">"reference"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--最大的分数--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"gradeNumber"</span> <span class="attr">format</span>=<span class="string">"integer"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--当前的分数--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"currentGrade"</span> <span class="attr">format</span>=<span class="string">"integer"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--星星之间的间距--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"statPadding"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>我们在初始化的时候获取相关数据:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> Bitmap mStarFocusBitmap, mStarNormalBitmap;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mGradeNumber;<span class="comment">//最大分数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCurrentGrade;<span class="comment">//当前分数  1开始的  最少为1分</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mStarPadding;<span class="comment">//间距</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RatingBar</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RatingBar</span><span class="params">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RatingBar</span><span class="params">(Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.RatingBar);</span><br><span class="line">        <span class="keyword">int</span> starNormalId = array.getResourceId(R.styleable.RatingBar_starNormal, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (starNormalId == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"请设置属性 starNormal "</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mStarNormalBitmap = BitmapFactory.decodeResource(getResources(), starNormalId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> starFocusId = array.getResourceId(R.styleable.RatingBar_starFocus, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (starFocusId == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"请设置属性 starFocus "</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mStarFocusBitmap = BitmapFactory.decodeResource(getResources(), starFocusId);</span><br><span class="line">        mGradeNumber = array.getInt(R.styleable.RatingBar_gradeNumber, <span class="number">0</span>);</span><br><span class="line">        mStarPadding = array.getDimensionPixelOffset(R.styleable.RatingBar_statPadding, DisplayUtil.dip2px(context, <span class="number">5</span>));</span><br><span class="line">        mCurrentGrade = array.getInt(R.styleable.RatingBar_currentGrade, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        array.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来我们设置宽高，本例中就直接写了，在实际开发中如有需要在修改<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">      <span class="comment">// 高度  一张图片的高度</span></span><br><span class="line">      <span class="keyword">int</span> height = mStarFocusBitmap.getHeight() + getPaddingTop() + getPaddingBottom();</span><br><span class="line">      <span class="keyword">int</span> width = mStarFocusBitmap.getWidth() * mGradeNumber</span><br><span class="line">              + getPaddingLeft() + getPaddingRight()</span><br><span class="line">              + mStarPadding * (mGradeNumber - <span class="number">1</span>);</span><br><span class="line">      setMeasuredDimension(width, height);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来调用<code>onDraw</code>函数绘制:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mGradeNumber; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; mCurrentGrade) &#123;</span><br><span class="line">                canvas.drawBitmap(mStarFocusBitmap,</span><br><span class="line">                        getPaddingLeft() + i * mStarFocusBitmap.getWidth() + i * mStarPadding, getPaddingTop(), <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                canvas.drawBitmap(mStarNormalBitmap,</span><br><span class="line">                        getPaddingLeft() + i * mStarFocusBitmap.getWidth() + i * mStarPadding, getPaddingTop(), <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>我们进行测试:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">   &gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.zzw.customview.view.RatingBar</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_centerInParent</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:currentGrade</span>=<span class="string">"2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:gradeNumber</span>=<span class="string">"5"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:statPadding</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:starFocus</span>=<span class="string">"@mipmap/star_selected"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:starNormal</span>=<span class="string">"@mipmap/star_normal"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>效果图如下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-932b27544e895b15.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>这时候只是一个静态的，点击的时候并没有变化，我们接下来进行<code>onTouchEvent</code>监听，然后进行改变值重绘:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                <span class="comment">//计算下标</span></span><br><span class="line">               <span class="keyword">int</span> pos = (<span class="keyword">int</span>) (x / (mStarFocusBitmap.getWidth() + mStarPadding));</span><br><span class="line">              <span class="keyword">if</span> (pos &lt; <span class="number">0</span>) pos = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">if</span> (pos &gt;= mGradeNumber)  pos = mGradeNumber - <span class="number">1</span>;</span><br><span class="line">                mCurrentGrade = pos + <span class="number">1</span>;</span><br><span class="line">                invalidate();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>我们为什么要加<code>1</code>呢？因为我们<code>mCurrentGrade</code>表示的是评分的分数，所以用下标加<code>1</code>，这个时候我们效果就达到了，但是我们不要忘记优化。<br>因为我们返回了<code>true</code>,所以在滑动的时候一直接受到<code>move</code>的事件，就一直进行调用了<code>invalidate</code>重绘 ，我们上次也说过<code>invalidate</code>会做很多事情，所以我们就要减少重绘的此时，我们应该加上判断：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                <span class="comment">//计算下标</span></span><br><span class="line">              <span class="keyword">int</span> pos = (<span class="keyword">int</span>) (x / (mStarFocusBitmap.getWidth() + mStarPadding));</span><br><span class="line">              <span class="keyword">if</span> (pos &lt; <span class="number">0</span>) pos = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">if</span> (pos &gt;= mGradeNumber)  pos = mGradeNumber - <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">if</span> (pos != mCurrentGrade - <span class="number">1</span>) &#123;<span class="comment">//分数-1 等于 坐标pos</span></span><br><span class="line">                    mCurrentGrade = pos + <span class="number">1</span>;</span><br><span class="line">                    invalidate();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这样的画就优雅了很多，当然也不要忘记<code>bitmap</code>的回收，我们将暴露出函数来给使用者在<code>activity</code>的<code>onDestory</code>生命周期调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回收</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mStarFocusBitmap != <span class="keyword">null</span>)</span><br><span class="line">            mStarFocusBitmap.recycle();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mStarNormalBitmap != <span class="keyword">null</span>)</span><br><span class="line">            mStarNormalBitmap.recycle();</span><br><span class="line"></span><br><span class="line">        mStarFocusBitmap=<span class="keyword">null</span>;</span><br><span class="line">        mStarNormalBitmap=<span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>在<code>activity</code>里面调用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onDestroy();</span><br><span class="line">       mRatingBar.recycle();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这样的话对于强迫症患者心里就舒坦多了。当然，我也是一个强迫症换患者。但是有时候我们也不能一定要追求极致，比如在获取位置的时候，我有一个想法，就是根据星星的范围精确的获取当前的位置,比如下面这样:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-8a5cfbfda05aad56.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>当时我就写了一个小算法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 计算位置</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">comPos</span><span class="params">(<span class="keyword">float</span> x)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> startX = getPaddingLeft();</span><br><span class="line">      <span class="keyword">if</span> (x &lt; startX) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (x &gt; getWidth() - getPaddingRight()) &#123;</span><br><span class="line">          <span class="keyword">return</span> mGradeNumber;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mGradeNumber; i++) &#123;</span><br><span class="line">          <span class="keyword">int</span> endX;</span><br><span class="line">          <span class="keyword">if</span> (i == <span class="number">0</span> || i == mGradeNumber - <span class="number">1</span>) &#123;<span class="comment">//第0个位置的后面的x</span></span><br><span class="line">              endX = startX + mStarFocusBitmap.getWidth() + mStarPadding / <span class="number">2</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              endX = startX + mStarFocusBitmap.getWidth() + mStarPadding;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (x &lt; endX) &#123;</span><br><span class="line">              pos = i;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          startX = endX;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> pos;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>这样的画就能够准确的拿到星星的位置，但是这样的弊端就是一个<code>for</code>循环，将会耗费更多的时间，所以最后还是改为了一个模糊的计算位置的方式。所以有时候也不能太强迫自己，不要钻牛角尖。<br>这篇文章结束了，希望对大家有所帮助!</p>
<p>下载链接:<a href="https://github.com/ChinaZeng/CustomView" target="_blank" rel="noopener">https://github.com/ChinaZeng/CustomView</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/自定义View（4） -- 字体变色.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/自定义View（4） -- 字体变色.html" itemprop="url">自定义View（4） -- 字体变色</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-09T09:52:57+08:00">
                2018-03-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自定义view/" itemprop="url" rel="index">
                    <span itemprop="name">自定义view</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/自定义View（4） -- 字体变色.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/自定义View（4） -- 字体变色.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,856字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  9分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/4658633-e84cba1783071f90.gif?imageMogr2/auto-orient/strip" alt="字体变色.gif"></p>
<p>初始化我就不说了，先思考我们需要什么属性，这里我就随便写了两个，一个是变色的颜色，一个是正常的颜色，当然也可以是默认的字体颜色，我们在<code>attr</code>里面申明<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;declare-styleable name=<span class="string">"ColorTrackTextView"</span>&gt;</span><br><span class="line">       &lt;attr name=<span class="string">"originColor"</span> format=<span class="string">"color"</span> /&gt;</span><br><span class="line">       &lt;attr name=<span class="string">"changeColor"</span> format=<span class="string">"color"</span> /&gt;</span><br><span class="line">   &lt;/declare-styleable&gt;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mOriginColor;<span class="comment">//不变化的颜色</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> mChangeColor;<span class="comment">//变化的颜色</span></span><br><span class="line">   <span class="keyword">private</span> Paint mOriginPaint, mChangePaint;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">       TypedArray ta = context.obtainStyledAttributes(attrs, R.styleable.ColorTrackTextView);</span><br><span class="line">       mOriginColor = ta.getColor(R.styleable.ColorTrackTextView_originColor, Color.BLACK);</span><br><span class="line">       mChangeColor = ta.getColor(R.styleable.ColorTrackTextView_changeColor, Color.RED);</span><br><span class="line">       ta.recycle();</span><br><span class="line"></span><br><span class="line">       mOriginPaint = <span class="keyword">new</span> Paint();</span><br><span class="line">       mOriginPaint.setColor(mOriginColor);</span><br><span class="line">       mOriginPaint.setAntiAlias(<span class="keyword">true</span>);</span><br><span class="line">       mOriginPaint.setTextSize(getTextSize());</span><br><span class="line"></span><br><span class="line">       mChangePaint = <span class="keyword">new</span> Paint();</span><br><span class="line">       mChangePaint.setColor(mChangeColor);</span><br><span class="line">       mChangePaint.setAntiAlias(<span class="keyword">true</span>);</span><br><span class="line">       mChangePaint.setTextSize(getTextSize());</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>因为我们选择了继承的是<code>TextView</code>，所以我们就不进行 <code>onMeasure()</code>，我们重写<code>onDraw()</code>,覆盖原有的绘制逻辑，我们自己来绘制，这里我们主要使用<code>canvas.clipRect(rect)</code>这个函数来实现裁剪，我们先来测试:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//思路：利用clipRect  来裁剪   使用两个画笔</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        super.onDraw(canvas);   //不使用TextView的绘制 自己画</span></span><br><span class="line"></span><br><span class="line">        canvas.save();</span><br><span class="line">        <span class="keyword">int</span> mid = <span class="number">500</span>;</span><br><span class="line">        Rect rect = <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, mid, getHeight());</span><br><span class="line">        canvas.clipRect(rect);</span><br><span class="line"></span><br><span class="line">        String text = getText().toString();</span><br><span class="line">        <span class="keyword">int</span> x = (<span class="keyword">int</span>) (getPaddingLeft() + getWidth() / <span class="number">2</span> - mOriginPaint.measureText(text) / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> y = getPaddingTop() + DisplayUtil.getTextBaseLine(getHeight(), mOriginPaint);</span><br><span class="line">        canvas.drawText(text, x, y, mChangePaint);</span><br><span class="line">        canvas.restore();</span><br><span class="line"></span><br><span class="line">        canvas.save();</span><br><span class="line">        rect.set(mid, <span class="number">0</span>, getWidth(), getHeight());</span><br><span class="line">        canvas.clipRect(rect);</span><br><span class="line">        canvas.drawText(text, x, y, mOriginPaint);</span><br><span class="line">        canvas.restore();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> &lt;com.zzw.customview.view.ColorTrackTextView xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">        android:id=<span class="string">"@+id/colortv"</span></span><br><span class="line">        android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">        android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">        android:layout_gravity=<span class="string">"center_horizontal"</span></span><br><span class="line">        android:gravity=<span class="string">"center"</span></span><br><span class="line">        android:text=<span class="string">"1111111"</span></span><br><span class="line">        android:textSize=<span class="string">"50sp"</span></span><br><span class="line">        app:changeColor=<span class="string">"@color/colorAccent"</span></span><br><span class="line">        app:originColor=<span class="string">"@color/colorPrimary"</span> /&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4658633-e2c652dacccad076.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>可以看到，我们是有效果的，因为我们考略到要和  <code>ViewPager</code> 一起配合使用，所以我们定义一个<code>float</code>类型的<code>mCurrentProgress</code>属性，用于表示当前的滑动进度，在设置一个方向，颜色是从左到右变化还是从右到左的变化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不同的朝向</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DIRECTION_LEFT_TO_RIGHT = <span class="number">1</span>;<span class="comment">//从左边变色</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DIRECTION_RIGHT_TO_LEFT = <span class="number">2</span>;<span class="comment">//从右边变色</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mDirection = DIRECTION_LEFT_TO_RIGHT;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//当前进度</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">float</span> mCurrentProgress;</span><br></pre></td></tr></table></figure></p>
<p>接下来我们修改<code>onDraw()</code>以及优化一下赘余代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//思路：利用clipRect  来裁剪   使用两个画笔</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        super.onDraw(canvas);   //不使用TextView的绘制 自己画</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> mid = comMiddle();</span><br><span class="line">        <span class="keyword">if</span> (mDirection == DIRECTION_LEFT_TO_RIGHT) &#123;</span><br><span class="line">            drawText(canvas, mChangePaint, <span class="number">0</span>, mid); <span class="comment">//画左边  颜色</span></span><br><span class="line">            drawText(canvas, mOriginPaint, mid, getWidth());<span class="comment">//画右边</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mid = getWidth() - mid;</span><br><span class="line">            drawText(canvas, mChangePaint, mid, getWidth());<span class="comment">//画右边  颜色</span></span><br><span class="line">            drawText(canvas, mOriginPaint, <span class="number">0</span>, mid); <span class="comment">//画左边</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据当前进度算出中间值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">comMiddle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (mCurrentProgress * getWidth());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据start  end  确定rect绘制文字</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> canvas</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paint</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> start</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawText</span><span class="params">(Canvas canvas, Paint paint, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        canvas.save();</span><br><span class="line">        Rect rect = <span class="keyword">new</span> Rect(start, <span class="number">0</span>, end, getHeight());<span class="comment">//确定区域</span></span><br><span class="line">        canvas.clipRect(rect);</span><br><span class="line"></span><br><span class="line">        String text = getText().toString();</span><br><span class="line">        <span class="keyword">int</span> x = (<span class="keyword">int</span>) (getPaddingLeft() + getWidth() / <span class="number">2</span> - paint.measureText(text) / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> y = getPaddingTop() + DisplayUtil.getTextBaseLine(getHeight(), paint);</span><br><span class="line">        canvas.drawText(text, x, y, paint);</span><br><span class="line">        canvas.restore();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来我们进行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public void leftToRight(View view) &#123;</span><br><span class="line">       mColorTrackTextView.setDirection(ColorTrackTextView.DIRECTION_LEFT_TO_RIGHT);</span><br><span class="line">       startAnim(0, 1);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public void RightToLeft(View view) &#123;</span><br><span class="line">       mColorTrackTextView.setDirection(ColorTrackTextView.DIRECTION_RIGHT_TO_LEFT);</span><br><span class="line">       startAnim(0, 1);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   private void startAnim(float startPro, float endPro) &#123;</span><br><span class="line">       ValueAnimator animator = ObjectAnimator.ofFloat(startPro, endPro);</span><br><span class="line">       animator.setDuration(2000);</span><br><span class="line">       animator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() &#123;</span><br><span class="line">           @Override</span><br><span class="line">           public void onAnimationUpdate(ValueAnimator animation) &#123;</span><br><span class="line">               float currentProgress = (float) animation.getAnimatedValue();</span><br><span class="line">               mColorTrackTextView.setCurrentProgress(currentProgress);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       animator.start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>就会得到如下图的效果:<br><img src="http://upload-images.jianshu.io/upload_images/4658633-fc06419bfad2c17f.gif?imageMogr2/auto-orient/strip" alt="字体变色测试.gif"></p>
<p>感觉离成功近了一步，这里我们顺便优化了一个性能的问题，因为是不端的调用<code>setCurrentProgress()</code>方法进行重新绘制，所以这里我们加个判断:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCurrentProgress</span><span class="params">(<span class="keyword">float</span> currentProgress)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mCurrentProgress == currentProgress)<span class="comment">//当前进度相同就不执行下一步</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.mCurrentProgress = currentProgress;</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>让它重复的时候不进行重绘，这只是一个小细节,接下来我们和<code>ViewPager</code>配合使用。我们在开发中一般遇到的是根据一个数据源，然后动态的添加<code>Fragment</code>和<code>ViewPager</code>进行关联，这里我们模拟这个场景。我们使用一个<code>LinearLayout</code>来管理这些字体变色的<code>view</code>，  <code>ViewPager</code>的<code>OnPageChangeListener</code>来管理字体变色,布局为下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingBottom</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/indicator_view"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">android.support.v4.view.ViewPager</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_pager"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>然后我们在代码中动态的添加:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzw.customview;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.Fragment;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.FragmentPagerAdapter;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.view.ViewPager;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.LinearLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zzw.customview.view.ColorTrackTextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by zzw on 2017/6/15.</span></span><br><span class="line"><span class="comment"> * Version:</span></span><br><span class="line"><span class="comment"> * Des: 字体变色和viewpager配合使用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewPagerActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String[] items = &#123;<span class="string">"热点"</span>, <span class="string">"推荐"</span>, <span class="string">"社会"</span>, <span class="string">"图片"</span>, <span class="string">"科技"</span>, <span class="string">"运动"</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> LinearLayout mIndicatorContainer;<span class="comment">// 变成通用的</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ColorTrackTextView&gt; mIndicators;</span><br><span class="line">    <span class="keyword">private</span> ViewPager mViewPager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_view_pager);</span><br><span class="line"></span><br><span class="line">        mIndicators = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        mIndicatorContainer = (LinearLayout) findViewById(R.id.indicator_view);</span><br><span class="line">        mViewPager = (ViewPager) findViewById(R.id.view_pager);</span><br><span class="line">        initIndicator();</span><br><span class="line">        initViewPager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化ViewPager</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initViewPager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mViewPager.setAdapter(<span class="keyword">new</span> FragmentPagerAdapter(getSupportFragmentManager()) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Fragment <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> ItemFragment.newInstance(items[position]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> items.length;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyItem</span><span class="params">(ViewGroup container, <span class="keyword">int</span> position, Object object)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        mViewPager.addOnPageChangeListener(<span class="keyword">new</span> ViewPager.OnPageChangeListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrolled</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">float</span> positionOffset, <span class="keyword">int</span> positionOffsetPixels)</span> </span>&#123;</span><br><span class="line">                Log.e(<span class="string">"TAG"</span>, <span class="string">"position -&gt; "</span> + position + <span class="string">"  positionOffset -&gt; "</span> + positionOffset + <span class="string">"  positionOffsetPixels-&gt;"</span> + positionOffsetPixels);</span><br><span class="line">                <span class="comment">// position 代表当前的位置</span></span><br><span class="line">                <span class="comment">// positionOffset 代表滚动的 0 - 1 百分比  左滑 1-&gt;0  右滑-&gt; 0-1</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 1.左边  位置 position</span></span><br><span class="line">                ColorTrackTextView left = mIndicators.get(position);</span><br><span class="line">                left.setDirection(ColorTrackTextView.DIRECTION_RIGHT_TO_LEFT);</span><br><span class="line">                left.setCurrentProgress(<span class="number">1</span> - positionOffset);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ColorTrackTextView right = mIndicators.get(position + <span class="number">1</span>);</span><br><span class="line">                    right.setDirection(ColorTrackTextView.DIRECTION_LEFT_TO_RIGHT);</span><br><span class="line">                    right.setCurrentProgress(positionOffset);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageSelected</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrollStateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化可变色的指示器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initIndicator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; items.length; i++) &#123;</span><br><span class="line">            <span class="comment">// 动态添加颜色跟踪的TextView</span></span><br><span class="line">            LinearLayout.LayoutParams params = <span class="keyword">new</span> LinearLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT,</span><br><span class="line">           ViewGroup.LayoutParams.WRAP_CONTENT);</span><br><span class="line">            params.weight = <span class="number">1</span>;</span><br><span class="line">            ColorTrackTextView colorTrackTextView = <span class="keyword">new</span> ColorTrackTextView(<span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">// 设置颜色</span></span><br><span class="line">            colorTrackTextView.setTextSize(<span class="number">20</span>);</span><br><span class="line">            colorTrackTextView.setChangeColor(Color.RED);</span><br><span class="line">            colorTrackTextView.setText(items[i]);</span><br><span class="line">            colorTrackTextView.setLayoutParams(params);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 把新的加入LinearLayout容器</span></span><br><span class="line">            mIndicatorContainer.addView(colorTrackTextView);</span><br><span class="line">            <span class="comment">// 加入集合</span></span><br><span class="line">            mIndicators.add(colorTrackTextView);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们发现左右滑动的时候可以实现了，但是点击<code>tab</code>的时候还会出现上一个没有变色的情况,这里我就不上图了，我们直接写一个函数，在选中之后把重新设置颜色即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">selectPos</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mIndicators.size(); i++) &#123;</span><br><span class="line">          ColorTrackTextView colorTrackTextView = mIndicators.get(i);</span><br><span class="line">          <span class="keyword">if</span> (i == pos) &#123;</span><br><span class="line">              colorTrackTextView.setCurrentProgress(<span class="number">1.0f</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              colorTrackTextView.setCurrentProgress(<span class="number">0.0f</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>最后要说的是，优化问题，在这篇文章中我们在绘制的过程中就已经进行优化了，我们要养成这种好习惯，不管是代码上还是性能上。<br>下载地址:<a href="https://github.com/ChinaZeng/CustomView" target="_blank" rel="noopener">https://github.com/ChinaZeng/CustomView</a></p>
<p>参考链接:<a href="http://www.jianshu.com/p/6e4b3eebbba0" target="_blank" rel="noopener">http://www.jianshu.com/p/6e4b3eebbba0</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/自定义View（3） -- 字母索引.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/自定义View（3） -- 字母索引.html" itemprop="url">自定义View（3） -- 字母索引</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-08T09:52:57+08:00">
                2018-03-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自定义view/" itemprop="url" rel="index">
                    <span itemprop="name">自定义view</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/自定义View（3） -- 字母索引.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/自定义View（3） -- 字母索引.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  788字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>效果图:<br><img src="http://upload-images.jianshu.io/upload_images/4658633-a66ad0b9d75308ac.gif?imageMogr2/auto-orient/strip" alt="字母索引"></p>
<p>自定义<code>view</code>的流程，具体请点此查看：<a href="&quot;http://www.jianshu.com/p/9e57d84b4497&quot;">自定义view套路</a><br>我们先重写构造器，然后重写<code>onMeasure</code>函数进行测量设置宽高，在本例中，宽我是根据<code>padding</code>和测量一个字母<code>w</code>的宽度来设置的，高度就是默认的，因为一般是设置为<code>match_parent</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AlphabeticalIndexView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AlphabeticalIndexView</span><span class="params">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AlphabeticalIndexView</span><span class="params">(Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">       init(context);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">       <span class="keyword">int</span> w = (<span class="keyword">int</span>) (getPaddingLeft() + getPaddingRight() + DisplayUtil.getTextWidth(<span class="string">"W"</span>, mPaint));</span><br><span class="line">       <span class="keyword">int</span> h = getMeasuredHeight();</span><br><span class="line">       setMeasuredDimension(w, h);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">       mPaint = <span class="keyword">new</span> Paint();</span><br><span class="line">       mPaint.setAntiAlias(<span class="keyword">true</span>);</span><br><span class="line">       mPaint.setTextSize(DisplayUtil.sp2px(context, <span class="number">15</span>));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>因为不是<code>viewGroup</code>，所以不必重写<code>onLayout</code>函数,我们直接进入<code>onDraw</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line">        <span class="comment">// 每个字母所占用的高度</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mLetters.length; i++) &#123;</span><br><span class="line">            String letter = mLetters[i];</span><br><span class="line">            <span class="keyword">if</span> (letter.equals(mCurrentTouchLetter))</span><br><span class="line">                mPaint.setColor(Color.BLUE);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                mPaint.setColor(Color.GRAY);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取字体的宽度</span></span><br><span class="line">            <span class="keyword">float</span> measureTextWidth = mPaint.measureText(letter);</span><br><span class="line">            <span class="comment">// 获取内容的宽度</span></span><br><span class="line">            <span class="keyword">int</span> contentWidth = getWidth() - getPaddingLeft() - getPaddingRight();</span><br><span class="line"></span><br><span class="line">            canvas.drawText(letter, getPaddingLeft() + (contentWidth - measureTextWidth) / <span class="number">2</span>, getPaddingTop()  + mSingLetterHeight * i + DisplayUtil.getTextBaseLine(mPaint), mPaint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里可能有点疑惑，为什么要用内容的宽度减去字体的宽度然后除于<code>2</code>，这是因为每个字母的宽度都不一样，如果不这样做的画，那么比如<code>I</code>就会和<code>A W</code>等字母左对齐，我们这样做的目的就是为了都居中。<br>这样我们就实现了一个静态的页面没我们要让他触摸改变，我们就重写<code>onTouchEvent</code>进行操作，并且添加相应的回调。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">switch</span> (ev.getAction()) &#123;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">               <span class="comment">// 获取当前手指触摸的Y位置</span></span><br><span class="line">               <span class="keyword">float</span> fingerY = ev.getY();</span><br><span class="line">               <span class="keyword">int</span> pos = (<span class="keyword">int</span>) (fingerY / mSingLetterHeight);</span><br><span class="line">               <span class="keyword">if</span> (pos &gt; -<span class="number">1</span> &amp;&amp; pos &lt; mLetters.length &amp;&amp; !mLetters[pos].equals(mCurrentTouchLetter)) &#123;</span><br><span class="line">                   mCurrentTouchLetter = mLetters[pos];</span><br><span class="line">                   triggerTouchListener(<span class="keyword">true</span>);</span><br><span class="line">                   invalidate();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">               triggerTouchListener(<span class="keyword">false</span>);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">triggerTouchListener</span><span class="params">(<span class="keyword">boolean</span> isTouch)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mTouchListener != <span class="keyword">null</span>)</span><br><span class="line">           mTouchListener.onTouch(mCurrentTouchLetter, isTouch);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 设置触摸监听</span></span><br><span class="line">   <span class="keyword">private</span> SideBarTouchListener mTouchListener;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnSideBarTouchListener</span><span class="params">(SideBarTouchListener touchListener)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.mTouchListener = touchListener;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SideBarTouchListener</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">void</span> <span class="title">onTouch</span><span class="params">(String letter, <span class="keyword">boolean</span> isTouch)</span></span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这样我们就可以实现了这个功能点。<br><strong>优化思路</strong><br>一个<code>view</code>绘制出来我们还需要进行优化，这一步是非常重要的。在本例中，我们的优化主要是在 <code>onTouchEvent</code>里面，因为我们知道，<code>invalidate</code>函数是一个一个做了很多事情的函数，具体请看:<a href="http://www.jianshu.com/p/e1fcec79249b" target="_blank" rel="noopener">Android invalidate流程分析</a>   我们要减少它的调用，所以我们应该先判断一下，如果当前的这个索引和触摸的这个不一样的话才调用<code>invalidate</code>，这样的话就优雅很多了。在本例中我没有将需要改变的属性，比如字体大小、选中颜色、默认颜色等提取在<code>attr</code>里面，需要的请自行添加。<br>参考:<a href="http://www.jianshu.com/p/1dc41a770f64" target="_blank" rel="noopener">Android字母索引列表</a></p>
<p>源码github下载地址:<br><a href="https://github.com/ChinaZeng/CustomView" target="_blank" rel="noopener">https://github.com/ChinaZeng/CustomView</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/header.jpg"
                alt="曾大稳丶" />
            
              <p class="site-author-name" itemprop="name">曾大稳丶</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">79</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">曾大稳丶</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: '5mOx5QUSJWyNMHeGUeqhG6uH-gzGzoHsz',
        appKey: '1gJRAgpCvNnFBWXPBRwEPmAM',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>