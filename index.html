<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<!--添加头部进度条-->
<!-- <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 2px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style> -->
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="曾大稳丶">
<meta property="og:url" content="http://www.zengzhaowen.cn/index.html">
<meta property="og:site_name" content="曾大稳丶">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="曾大稳丶">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.zengzhaowen.cn/"/>





  <title>曾大稳丶</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ccc0cac4d5d9e6f8efec9c129ada134d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">曾大稳丶</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android配置EGL环境C++版.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android配置EGL环境C++版.html" itemprop="url">Android配置EGL环境C++版</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-22T17:44:04+08:00">
                2019-04-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android配置EGL环境C++版.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android配置EGL环境C++版.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,405字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  8分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>android搭建opengles 的egl环境之前使用java已经写过，但是一般实际开发opengles的相关代码都在native层，因为native的话效率会比java高很多，步骤都是一致的，只是换一种语言写而已。之前使用java写的opengles egl环境搭建点击下面链接:<br><a href="https://www.jianshu.com/p/ce3496ab9e02" target="_blank" rel="noopener">https://www.jianshu.com/p/ce3496ab9e02</a></p>
<p>本文demo下载地址:<br><a href="https://github.com/ChinaZeng/NativeEglDemo" target="_blank" rel="noopener">https://github.com/ChinaZeng/NativeEglDemo</a></p>
<p>步骤都是一样的：</p>
<blockquote>
<p>1、得到Egl实例<br>2、得到默认的显示设备（就是窗口）<br>3、初始化默认显示设备<br>4、设置显示设备的属性<br>5、从系统中获取对应属性的配置<br>6、创建EglContext<br>7、创建渲染的Surface<br>8、绑定EglContext和Surface到显示设备中<br>9、刷新数据，显示渲染场景</p>
</blockquote>
<p>代码目录:</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB4a3d53c592b822848e0fcb7db0595bed?method=download&amp;shareKey=a82ef39457fce5127c000f62d2314067" alt="代码目录"></p>
<ol>
<li><p>首先配置android ndk开发环境，我使用的是cmake</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.4</span>.<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>( <span class="comment"># Sets the name of the library.</span></span><br><span class="line">        native-lib</span><br><span class="line">        SHARED</span><br><span class="line">        native-lib.cpp</span><br><span class="line">        egl/EglHelper.cpp</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(</span><br><span class="line">        native-lib</span><br><span class="line">        EGL</span><br><span class="line">        GLESv2</span><br><span class="line">        android</span><br><span class="line">        log</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>书写EglHelper，这个类主要负责egl的环境初始化，绘制和销毁</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//环境搭建初始化</span></span><br><span class="line"><span class="keyword">int</span> EglHelper::initEgl(EGLNativeWindowType window) &#123;</span><br><span class="line">    <span class="comment">//1.得到默认的显示设备（就是窗口） -- eglGetDisplay</span></span><br><span class="line">    mEglDisplay = eglGetDisplay(EGL_DEFAULT_DISPLAY);</span><br><span class="line">    <span class="keyword">if</span> (mEglDisplay == EGL_NO_DISPLAY) &#123;</span><br><span class="line">        LOGE(<span class="string">"eglGetDisplay error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 初始化默认显示设备 -- eglInitialize</span></span><br><span class="line">    EGLint *version = <span class="keyword">new</span> EGLint[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (!eglInitialize(mEglDisplay, &amp;version[<span class="number">0</span>], &amp;version[<span class="number">1</span>])) &#123;</span><br><span class="line">        LOGE(<span class="string">"eglInitialize error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 设置显示设备的属性</span></span><br><span class="line">    <span class="keyword">const</span> EGLint attrib_config_list[] = &#123;</span><br><span class="line">            EGL_RED_SIZE, <span class="number">8</span>,</span><br><span class="line">            EGL_GREEN_SIZE, <span class="number">8</span>,</span><br><span class="line">            EGL_BLUE_SIZE, <span class="number">8</span>,</span><br><span class="line">            EGL_ALPHA_SIZE, <span class="number">8</span>,</span><br><span class="line">            EGL_DEPTH_SIZE, <span class="number">8</span>,</span><br><span class="line">            EGL_STENCIL_SIZE, <span class="number">8</span>,<span class="comment">// 眼睛屏幕的距离</span></span><br><span class="line">            EGL_RENDERABLE_TYPE, EGL_OPENGL_ES2_BIT,<span class="comment">//版本号</span></span><br><span class="line">            EGL_NONE</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.1 根据所需的参数获取符合该参数的config_size，主要是解决有些手机eglChooseConfig失败的兼容性问题</span></span><br><span class="line">    EGLint num_config;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!eglChooseConfig(mEglDisplay, attrib_config_list, <span class="literal">NULL</span>, <span class="number">1</span>, &amp;num_config)) &#123;</span><br><span class="line">        LOGE(<span class="string">"eglChooseConfig error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.2 根据获取到的config_size得到eglConfig</span></span><br><span class="line">    EGLConfig eglConfig;</span><br><span class="line">    <span class="keyword">if</span> (!eglChooseConfig(mEglDisplay, attrib_config_list, &amp;eglConfig, num_config, &amp;num_config)) &#123;</span><br><span class="line">        LOGE(<span class="string">"eglChooseConfig error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 创建egl上下文 eglCreateContext</span></span><br><span class="line">    <span class="keyword">const</span> EGLint attrib_ctx_list[] = &#123;</span><br><span class="line">            EGL_CONTEXT_CLIENT_VERSION, <span class="number">2</span>,</span><br><span class="line">            EGL_NONE</span><br><span class="line">    &#125;;</span><br><span class="line">    mEglContext = eglCreateContext(mEglDisplay, eglConfig, <span class="literal">NULL</span>, attrib_ctx_list);</span><br><span class="line">    <span class="keyword">if</span> (mEglContext == EGL_NO_CONTEXT) &#123;</span><br><span class="line">        LOGE(<span class="string">"eglCreateContext  error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5.创建渲染的surface</span></span><br><span class="line">    mEglSurface = eglCreateWindowSurface(mEglDisplay, eglConfig, window, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (mEglSurface == EGL_NO_SURFACE) &#123;</span><br><span class="line">        LOGE(<span class="string">"eglCreateWindowSurface  error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. 绑定eglContext和surface到display</span></span><br><span class="line">    <span class="keyword">if</span> (!eglMakeCurrent(mEglDisplay, mEglSurface, mEglSurface, mEglContext)) &#123;</span><br><span class="line">        LOGE(<span class="string">"eglMakeCurrent  error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7. 刷新数据，显示渲染场景 -- eglSwapBuffers</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//交换缓冲 绘制</span></span><br><span class="line"><span class="keyword">int</span> EglHelper::swapBuffers() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mEglDisplay != EGL_NO_DISPLAY &amp;&amp; mEglSurface != EGL_NO_SURFACE &amp;&amp;</span><br><span class="line">        eglSwapBuffers(mEglDisplay, mEglSurface)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//销毁</span></span><br><span class="line"><span class="keyword">void</span> EglHelper::destroyEgl() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mEglDisplay != EGL_NO_DISPLAY) &#123;</span><br><span class="line">        <span class="comment">//解绑display上的eglContext和surface</span></span><br><span class="line">        eglMakeCurrent(mEglDisplay, EGL_NO_SURFACE, EGL_NO_SURFACE, EGL_NO_CONTEXT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//销毁surface 和 eglContext</span></span><br><span class="line">        <span class="keyword">if</span> (mEglSurface != EGL_NO_SURFACE) &#123;</span><br><span class="line">            eglDestroySurface(mEglDisplay, mEglSurface);</span><br><span class="line">            mEglSurface = EGL_NO_SURFACE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mEglContext != EGL_NO_CONTEXT) &#123;</span><br><span class="line">            eglDestroyContext(mEglDisplay, mEglContext);</span><br><span class="line">            mEglContext = EGL_NO_CONTEXT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mEglDisplay != EGL_NO_DISPLAY) &#123;</span><br><span class="line">            eglTerminate(mEglDisplay);</span><br><span class="line">            mEglDisplay = EGL_NO_DISPLAY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>书写EglThread，顾名思义，这个类主要负责开启一个线程然后根据外部的生命周期调用EglHelper完成egl的环境搭建，并且和外部交互。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">EglThread::EglThread() &#123;</span><br><span class="line">    pthread_mutex_init(&amp;pthread_mutex, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;pthread_cond, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EglThread::~EglThread() &#123;</span><br><span class="line">    pthread_mutex_destroy(&amp;pthread_mutex);</span><br><span class="line">    pthread_cond_destroy(&amp;pthread_cond);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">eglThreadImpl</span><span class="params">(<span class="keyword">void</span> *context)</span> </span>&#123;</span><br><span class="line">    EglThread *eglThread = <span class="keyword">static_cast</span>&lt;EglThread *&gt;(context);</span><br><span class="line">    <span class="keyword">if</span> (!eglThread) &#123;</span><br><span class="line">        LOGE(<span class="string">"eglThreadImpl eglThread is null"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EglHelper *eglHelper = <span class="keyword">new</span> EglHelper();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eglHelper-&gt;initEgl(eglThread-&gt;mANativeWindow) != <span class="number">0</span>) &#123;</span><br><span class="line">        LOGE(<span class="string">"eglHelper initEgl error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    eglThread-&gt;isExit = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!eglThread-&gt;isExit) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (eglThread-&gt;isCreate) &#123;</span><br><span class="line">            eglThread-&gt;isCreate = <span class="literal">false</span>;</span><br><span class="line">            eglThread-&gt;onCreate();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (eglThread-&gt;isChange) &#123;</span><br><span class="line">            eglThread-&gt;isChange = <span class="literal">false</span>;</span><br><span class="line">            eglThread-&gt;isStart = <span class="literal">true</span>;</span><br><span class="line">            eglThread-&gt;onChange(eglThread-&gt;surfaceWidth, eglThread-&gt;surfaceHeight);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (eglThread-&gt;isStart) &#123;</span><br><span class="line">            eglThread-&gt;onDraw();</span><br><span class="line">            <span class="comment">//切换缓冲区，显示</span></span><br><span class="line">            eglHelper-&gt;swapBuffers();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (eglThread-&gt;mRenderType == RENDER_MODULE_AUTO) &#123;</span><br><span class="line">                usleep(<span class="number">1000000</span> / <span class="number">60</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                pthread_mutex_lock(&amp;eglThread-&gt;pthread_mutex);</span><br><span class="line">                pthread_cond_wait(&amp;eglThread-&gt;pthread_cond, &amp;eglThread-&gt;pthread_mutex);</span><br><span class="line">                pthread_mutex_unlock(&amp;eglThread-&gt;pthread_mutex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    eglHelper-&gt;destroyEgl();</span><br><span class="line">    <span class="keyword">delete</span> eglHelper;</span><br><span class="line">    eglHelper = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//return 0表示线程结束</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> EglThread::onSurfaceCreate(EGLNativeWindowType window) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mEglThread == <span class="number">-1</span>) &#123;</span><br><span class="line">        isCreate = <span class="literal">true</span>;</span><br><span class="line">        mANativeWindow = window;</span><br><span class="line">        pthread_create(&amp;mEglThread, <span class="literal">NULL</span>, eglThreadImpl, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> EglThread::onSurfaceChange(<span class="keyword">int</span> width, <span class="keyword">int</span> height) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mEglThread != <span class="number">-1</span>) &#123;</span><br><span class="line">        surfaceWidth = width;</span><br><span class="line">        surfaceHeight = height;</span><br><span class="line">        isChange = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        notifyRender();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> EglThread::setRenderModule(<span class="keyword">int</span> renderType) &#123;</span><br><span class="line">    mRenderType = renderType;</span><br><span class="line">    notifyRender();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> EglThread::notifyRender() &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;pthread_mutex);</span><br><span class="line">    pthread_cond_signal(&amp;pthread_cond);</span><br><span class="line">    pthread_mutex_unlock(&amp;pthread_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> EglThread::callBackOnCreate(EglThread::OnCreate onCreate) &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;onCreate = onCreate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> EglThread::callBackOnChange(EglThread::OnChange onChange) &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;onChange = onChange;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> EglThread::callBackOnDraw(EglThread::OnDraw onDraw) &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;onDraw = onDraw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>书写java层和native层交互，对应生命周期回调即可<br>NationOpenGL.java<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NationOpenGL</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSurfaceCreate</span><span class="params">(Surface surface)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSurfaceChanged</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSurfaceDestroyed</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>NativeGLSurfaceView.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NativeGLSurfaceView</span> <span class="keyword">extends</span> <span class="title">SurfaceView</span> <span class="keyword">implements</span> <span class="title">SurfaceHolder</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> NationOpenGL mNationOpenGL;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NativeGLSurfaceView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NativeGLSurfaceView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NativeGLSurfaceView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        mNationOpenGL = <span class="keyword">new</span> NationOpenGL();</span><br><span class="line">        getHolder().addCallback(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceCreated</span><span class="params">(SurfaceHolder holder)</span> </span>&#123;</span><br><span class="line">        mNationOpenGL.nativeSurfaceCreate(holder.getSurface());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceChanged</span><span class="params">(SurfaceHolder holder, <span class="keyword">int</span> format, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        mNationOpenGL.nativeSurfaceChanged(width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceDestroyed</span><span class="params">(SurfaceHolder holder)</span> </span>&#123;</span><br><span class="line">        mNationOpenGL.nativeSurfaceDestroyed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>native-lib.cpp<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">EglThread *eglThread = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">callBackOnCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LOGE(<span class="string">"callBackOnCreate"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">callBackOnChange</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">    glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">    LOGE(<span class="string">"callBackOnChange"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">callBackOnDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    glClearColor(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">    glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line">    LOGE(<span class="string">"callBackOnDraw"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_zzw_nativeopnegldemo_opengl_NationOpenGL_nativeSurfaceCreate(JNIEnv *env, jobject instance,</span><br><span class="line">                                                                      jobject surface) &#123;</span><br><span class="line"></span><br><span class="line">    eglThread = <span class="keyword">new</span> EglThread();</span><br><span class="line">    eglThread-&gt;callBackOnCreate(callBackOnCreate);</span><br><span class="line">    eglThread-&gt;callBackOnChange(callBackOnChange);</span><br><span class="line">    eglThread-&gt;callBackOnDraw(callBackOnDraw);</span><br><span class="line">    eglThread-&gt;setRenderModule(RENDER_MODULE_MANUAL);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ANativeWindow *nativeWindow = ANativeWindow_fromSurface(env, surface);</span><br><span class="line">    eglThread-&gt;onSurfaceCreate(nativeWindow);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_zzw_nativeopnegldemo_opengl_NationOpenGL_nativeSurfaceChanged(JNIEnv *env,</span><br><span class="line">                                                                       jobject instance, jint width,</span><br><span class="line">                                                                       jint height) &#123;</span><br><span class="line">    <span class="keyword">if</span> (eglThread) &#123;</span><br><span class="line">        eglThread-&gt;onSurfaceChange(width, height);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_zzw_nativeopnegldemo_opengl_NationOpenGL_nativeSurfaceDestroyed(JNIEnv *env,</span><br><span class="line">                                                                         jobject instance) &#123;</span><br><span class="line">    <span class="keyword">if</span> (eglThread) &#123;</span><br><span class="line">        eglThread-&gt;isExit = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">delete</span> (eglThread);</span><br><span class="line">        eglThread = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android使用libRtmp直播推流.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android使用libRtmp直播推流.html" itemprop="url">Android使用libRtmp直播推流</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-20T17:38:27+08:00">
                2018-09-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android使用libRtmp直播推流.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android使用libRtmp直播推流.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,039字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>初始化rtmp</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//分配空间</span></span><br><span class="line">RTMP *rtmp = RTMP_Alloc();</span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line">RTMP_Init(rtmp);</span><br><span class="line"><span class="comment">//设置推流URL</span></span><br><span class="line">RTMP_SetupURL(rtmp, url);</span><br><span class="line"><span class="comment">//设置可写状态</span></span><br><span class="line">RTMP_EnableWrite(rtmp);</span><br><span class="line"><span class="comment">//链接服务器</span></span><br><span class="line">RTMP_Connect(rtmp, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">//链接流</span></span><br><span class="line">RTMP_ConnectStream(rtmp, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//循环推流（AAC、H264）	//开始推流</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">     <span class="keyword">int</span> result = RTMP_SendPacket(rtmp, packet, <span class="number">1</span>);</span><br><span class="line">     RTMPPacket_Free(packet);</span><br><span class="line">     <span class="built_in">free</span>(packet);</span><br><span class="line">     packet = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭链接</span></span><br><span class="line">RTMP_Close(rtmp);</span><br><span class="line"><span class="comment">//释放资源</span></span><br><span class="line">RTMP_Free(rtmp);</span><br><span class="line">rtmp=<span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>H264包封装。在发送每一帧关键帧之前得先发送SPS、PPS帧信息，发送的每一帧（I、P、SPS、PPS）数据得添加头部信息。  </li>
</ol>
<p><a href="https://www.jianshu.com/p/7ba52d1d6ad6" target="_blank" rel="noopener">获取摄像头预览数据并编码为H264,pcm数据编码AAC</a></p>
<p>2.1 SPS  PPS数据<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> RtmpPush::pushSPSPPS(<span class="keyword">char</span> *sps, <span class="keyword">int</span> spsLen, <span class="keyword">char</span> *pps, <span class="keyword">int</span> ppsLen) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>-&gt;<span class="built_in">queue</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> bodySize = spsLen + ppsLen + <span class="number">16</span>;</span><br><span class="line">    RTMPPacket *rtmpPacket = <span class="keyword">static_cast</span>&lt;RTMPPacket *&gt;(<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(RTMPPacket)));</span><br><span class="line">    RTMPPacket_Alloc(rtmpPacket, bodySize);</span><br><span class="line">    RTMPPacket_Reset(rtmpPacket);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *body = rtmpPacket-&gt;m_body;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//frame type(4bit)和CodecId(4bit)合成一个字节(byte)</span></span><br><span class="line">    <span class="comment">//frame type 关键帧1  非关键帧2</span></span><br><span class="line">    <span class="comment">//CodecId  7表示avc</span></span><br><span class="line">    body[i++] = <span class="number">0x17</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//fixed 4byte</span></span><br><span class="line">    body[i++] = <span class="number">0x00</span>;</span><br><span class="line">    body[i++] = <span class="number">0x00</span>;</span><br><span class="line">    body[i++] = <span class="number">0x00</span>;</span><br><span class="line">    body[i++] = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//configurationVersion： 版本 1byte</span></span><br><span class="line">    body[i++] = <span class="number">0x01</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//AVCProfileIndication：Profile 1byte  sps[1]</span></span><br><span class="line">    body[i++] = sps[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//compatibility：  兼容性 1byte  sps[2]</span></span><br><span class="line">    body[i++] = sps[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//AVCLevelIndication： ProfileLevel 1byte  sps[3]</span></span><br><span class="line">    body[i++] = sps[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//lengthSizeMinusOne： 包长数据所使用的字节数  1byte</span></span><br><span class="line">    body[i++] = <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sps个数 1byte</span></span><br><span class="line">    body[i++] = <span class="number">0xe1</span>;</span><br><span class="line">    <span class="comment">//sps长度 2byte</span></span><br><span class="line">    body[i++] = (spsLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">    body[i++] = spsLen &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sps data 内容</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;body[i], sps, spsLen);</span><br><span class="line">    i += spsLen;</span><br><span class="line">    <span class="comment">//pps个数 1byte</span></span><br><span class="line">    body[i++] = <span class="number">0x01</span>;</span><br><span class="line">    <span class="comment">//pps长度 2byte</span></span><br><span class="line">    body[i++] = (ppsLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">    body[i++] = ppsLen &amp; <span class="number">0xff</span>;</span><br><span class="line">    <span class="comment">//pps data 内容</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;body[i], pps, ppsLen);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    rtmpPacket-&gt;m_packetType = RTMP_PACKET_TYPE_VIDEO;</span><br><span class="line">    rtmpPacket-&gt;m_nBodySize = bodySize;</span><br><span class="line">    rtmpPacket-&gt;m_nTimeStamp = <span class="number">0</span>;</span><br><span class="line">    rtmpPacket-&gt;m_hasAbsTimestamp = <span class="number">0</span>;</span><br><span class="line">    rtmpPacket-&gt;m_nChannel = <span class="number">0x04</span>;<span class="comment">//音频或者视频</span></span><br><span class="line">    rtmpPacket-&gt;m_headerType = RTMP_PACKET_SIZE_MEDIUM;</span><br><span class="line">    rtmpPacket-&gt;m_nInfoField2 = <span class="keyword">this</span>-&gt;rtmp-&gt;m_stream_id;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">queue</span>-&gt;putRtmpPacket(rtmpPacket);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.2 H264数据</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RtmpPush::pushVideoData(<span class="keyword">char</span> *data, <span class="keyword">int</span> dataLen, <span class="keyword">bool</span> keyFrame) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>-&gt;<span class="built_in">queue</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> bodySize = dataLen + <span class="number">9</span>;</span><br><span class="line">    RTMPPacket *rtmpPacket = <span class="keyword">static_cast</span>&lt;RTMPPacket *&gt;(<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(RTMPPacket)));</span><br><span class="line">    RTMPPacket_Alloc(rtmpPacket, bodySize);</span><br><span class="line">    RTMPPacket_Reset(rtmpPacket);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *body = rtmpPacket-&gt;m_body;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//frame type(4bit)和CodecId(4bit)合成一个字节(byte)</span></span><br><span class="line">    <span class="comment">//frame type 关键帧1  非关键帧2</span></span><br><span class="line">    <span class="comment">//CodecId  7表示avc</span></span><br><span class="line">    <span class="keyword">if</span> (keyFrame) &#123;</span><br><span class="line">        body[i++] = <span class="number">0x17</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        body[i++] = <span class="number">0x27</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//fixed 4byte   0x01表示NALU单元</span></span><br><span class="line">    body[i++] = <span class="number">0x01</span>;</span><br><span class="line">    body[i++] = <span class="number">0x00</span>;</span><br><span class="line">    body[i++] = <span class="number">0x00</span>;</span><br><span class="line">    body[i++] = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//dataLen  4byte</span></span><br><span class="line">    body[i++] = (dataLen &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">    body[i++] = (dataLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">    body[i++] = (dataLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">    body[i++] = dataLen &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//data</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;body[i], data, dataLen);</span><br><span class="line"></span><br><span class="line">    rtmpPacket-&gt;m_packetType = RTMP_PACKET_TYPE_VIDEO;</span><br><span class="line">    rtmpPacket-&gt;m_nBodySize = bodySize;</span><br><span class="line">    <span class="comment">//持续播放时间</span></span><br><span class="line">    rtmpPacket-&gt;m_nTimeStamp = RTMP_GetTime() - <span class="keyword">this</span>-&gt;startTime;</span><br><span class="line">    <span class="comment">//进入直播播放开始时间</span></span><br><span class="line">    rtmpPacket-&gt;m_hasAbsTimestamp = <span class="number">0</span>;</span><br><span class="line">    rtmpPacket-&gt;m_nChannel = <span class="number">0x04</span>;<span class="comment">//音频或者视频</span></span><br><span class="line">    rtmpPacket-&gt;m_headerType = RTMP_PACKET_SIZE_LARGE;</span><br><span class="line">    rtmpPacket-&gt;m_nInfoField2 = <span class="keyword">this</span>-&gt;rtmp-&gt;m_stream_id;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">queue</span>-&gt;putRtmpPacket(rtmpPacket);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>AAC包封装   需要添加头部</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> RtmpPush::pushAudioData(<span class="keyword">char</span> *data, <span class="keyword">int</span> dataLen) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>-&gt;<span class="built_in">queue</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> bodySize = dataLen + <span class="number">2</span>;</span><br><span class="line">    RTMPPacket *rtmpPacket = <span class="keyword">static_cast</span>&lt;RTMPPacket *&gt;(<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(RTMPPacket)));</span><br><span class="line">    RTMPPacket_Alloc(rtmpPacket, bodySize);</span><br><span class="line">    RTMPPacket_Reset(rtmpPacket);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *body = rtmpPacket-&gt;m_body;</span><br><span class="line">    <span class="comment">//前四位表示音频数据格式  10（十进制）表示AAC，16进制就是A</span></span><br><span class="line">    <span class="comment">//第5-6位的数值表示采样率，0 = 5.5 kHz，1 = 11 kHz，2 = 22 kHz，3(11) = 44 kHz。</span></span><br><span class="line">    <span class="comment">//第7位表示采样精度，0 = 8bits，1 = 16bits。</span></span><br><span class="line">    <span class="comment">//第8位表示音频类型，0 = mono，1 = stereo</span></span><br><span class="line">    <span class="comment">//这里是44100 立体声 16bit 二进制就是1111   16进制就是F</span></span><br><span class="line">    body[<span class="number">0</span>] = <span class="number">0xAF</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//0x00 aac头信息,  0x01 aac 原始数据</span></span><br><span class="line">    <span class="comment">//这里都用0x01都可以</span></span><br><span class="line">    body[<span class="number">1</span>] = <span class="number">0x01</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//data</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;body[<span class="number">2</span>], data, dataLen);</span><br><span class="line"></span><br><span class="line">    rtmpPacket-&gt;m_packetType = RTMP_PACKET_TYPE_AUDIO;</span><br><span class="line">    rtmpPacket-&gt;m_nBodySize = bodySize;</span><br><span class="line">    <span class="comment">//持续播放时间</span></span><br><span class="line">    rtmpPacket-&gt;m_nTimeStamp = RTMP_GetTime() - <span class="keyword">this</span>-&gt;startTime;</span><br><span class="line">    <span class="comment">//进入直播播放开始时间</span></span><br><span class="line">    rtmpPacket-&gt;m_hasAbsTimestamp = <span class="number">0</span>;</span><br><span class="line">    rtmpPacket-&gt;m_nChannel = <span class="number">0x04</span>;<span class="comment">//音频或者视频</span></span><br><span class="line">    rtmpPacket-&gt;m_headerType = RTMP_PACKET_SIZE_LARGE;</span><br><span class="line">    rtmpPacket-&gt;m_nInfoField2 = <span class="keyword">this</span>-&gt;rtmp-&gt;m_stream_id;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">queue</span>-&gt;putRtmpPacket(rtmpPacket);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>Android MediaCodec获取PPS和SPS</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> outputBufferIndex = videoEncodec.dequeueOutputBuffer(videoBufferinfo, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (outputBufferIndex == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">    ByteBuffer spsb = videoEncodec.getOutputFormat().getByteBuffer(<span class="string">"csd-0"</span>);</span><br><span class="line">    <span class="keyword">byte</span>[] sps = <span class="keyword">new</span> <span class="keyword">byte</span>[spsb.remaining()];</span><br><span class="line">    spsb.get(sps, <span class="number">0</span>,sps.length);</span><br><span class="line">    Log.e(<span class="string">"zzz"</span>, <span class="string">"sps: "</span> + ByteUtil.bytesToHexSpaceString(sps));</span><br><span class="line"></span><br><span class="line">    ByteBuffer ppsb = videoEncodec.getOutputFormat().getByteBuffer(<span class="string">"csd-1"</span>);</span><br><span class="line">    <span class="keyword">byte</span>[] pps = <span class="keyword">new</span> <span class="keyword">byte</span>[ppsb.remaining()];</span><br><span class="line">    ppsb.get(pps, <span class="number">0</span>,pps.length);</span><br><span class="line">    Log.e(<span class="string">"zzz"</span>, <span class="string">"pps: "</span> + ByteUtil.bytesToHexSpaceString(pps));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/25720FC115104CFD87D5C7BE3BEF7DD1?method=download&amp;shareKey=73989030eb6590a62c2b12c4607b7a88" alt=""></p>
<p>具体查看demo: <a href="https://github.com/ChinaZeng/RtmpLivePushDemo" target="_blank" rel="noopener">https://github.com/ChinaZeng/RtmpLivePushDemo</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/Android集成libRtmp.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android集成libRtmp.html" itemprop="url">Android集成libRtmp</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-20T17:38:16+08:00">
                2018-09-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/Android集成libRtmp.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/Android集成libRtmp.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  100字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>librtmp下载: <a href="http://rtmpdump.mplayerhq.hu/download/" target="_blank" rel="noopener">http://rtmpdump.mplayerhq.hu/download/</a><br><img src="https://note.youdao.com/yws/api/personal/file/6E663CDA2ED34DE9A90A0F2F405ADC99?method=download&amp;shareKey=d1ce14b31c60989694b79e54c38cf53b" alt="librtmp下载"></p>
</li>
<li><p>拷贝相关文件到cpp里面  </p>
</li>
</ol>
<p><img src="https://note.youdao.com/yws/api/personal/file/4F70D8D0487E443DBE1A6BFEBB89D51C?method=download&amp;shareKey=df1af54075293de8b03e0f1c3236dcd6" alt="目录"></p>
<ol start="3">
<li>cmake配置<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.4</span>.<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#不配置ssl</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_C_FLAGS <span class="string">"$&#123;CMAKE_C_FLAGS&#125; -DNO_CRYPTO"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>( lib-native</span><br><span class="line">             SHARED</span><br><span class="line">           </span><br><span class="line">             src/main/cpp/librtmp/amf.c</span><br><span class="line">             src/main/cpp/librtmp/hashswf.c</span><br><span class="line">             src/main/cpp/librtmp/log.c</span><br><span class="line">             src/main/cpp/librtmp/parseurl.c</span><br><span class="line">             src/main/cpp/librtmp/rtmp.c</span><br><span class="line">              )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>( lib-native</span><br><span class="line">                       log)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>具体的配置查看README</p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/MediaCodec录制音视频并将合成为一个文件.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/MediaCodec录制音视频并将合成为一个文件.html" itemprop="url">MediaCodec录制音视频并将合成为一个文件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-30T15:15:24+08:00">
                2018-08-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MediaCodec/" itemprop="url" rel="index">
                    <span itemprop="name">MediaCodec</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/MediaCodec录制音视频并将合成为一个文件.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/MediaCodec录制音视频并将合成为一个文件.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  797字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>主要的步骤分为视频录制，音频录制，视频合成。</p>
<blockquote>
<p><strong>视频录制</strong>采用<code>OpenGLES</code>渲染预览摄像头画面，通过<code>MediaCodec</code>创建一个<code>surface</code>，然后通过创建一个新的<code>egl</code>环境共享预览的<code>EglContext</code>和这个<code>surface</code>绑定，渲染摄像头预览的<code>fbo</code>绑定的纹理，即可录制。<br><strong>音频录制</strong>采用<code>MediaCodec</code>即可，从外部传入<code>pcm</code>数据进行编码录制。<br><strong>音视频合成</strong>采用<code>MediaMuxer</code>合成。</p>
</blockquote>
<p><img src="https://note.youdao.com/yws/api/personal/file/9F415E4F5F414E3280B34A21104731DA?method=download&amp;shareKey=e98037f3617f0138d1debbfdf6c69adf" alt="录制"></p>
<p><strong>视频录制</strong><br><a href="https://www.jianshu.com/p/9735feef1367" target="_blank" rel="noopener">OpenGLES渲染画面通过MediaCodec录制</a></p>
<p><strong>音频录制</strong><br>相关参考  <a href="https://www.jianshu.com/p/7cffd2921131" target="_blank" rel="noopener">MediaCodec硬编码pcm2aac</a><br>主要分为以下几步骤:</p>
<ol>
<li><p>初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initAudioEncoder</span><span class="params">(String mineType, <span class="keyword">int</span> sampleRate, <span class="keyword">int</span> channel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mAudioEncodec = MediaCodec.createEncoderByType(mineType);</span><br><span class="line">            MediaFormat audioFormat = MediaFormat.createAudioFormat(mineType, sampleRate, channel);</span><br><span class="line">            audioFormat.setInteger(MediaFormat.KEY_BIT_RATE, <span class="number">96000</span>);</span><br><span class="line">            audioFormat.setInteger(MediaFormat.KEY_AAC_PROFILE, MediaCodecInfo.CodecProfileLevel.AACObjectLC);</span><br><span class="line">            audioFormat.setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, <span class="number">4096</span>);</span><br><span class="line">            mAudioEncodec.configure(audioFormat, <span class="keyword">null</span>, <span class="keyword">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);</span><br><span class="line"></span><br><span class="line">            mAudioBuffInfo = <span class="keyword">new</span> MediaCodec.BufferInfo();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            mAudioEncodec = <span class="keyword">null</span>;</span><br><span class="line">            mAudioBuffInfo = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>开始录制</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">audioEncodec.start();</span><br><span class="line"><span class="keyword">int</span> outputBufferIndex = audioEncodec.dequeueOutputBuffer(audioBufferinfo, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    ByteBuffer outputBuffer = audioEncodec.getOutputBuffers()[outputBufferIndex];</span><br><span class="line">    outputBuffer.position(audioBufferinfo.offset);</span><br><span class="line">    outputBuffer.limit(audioBufferinfo.offset + audioBufferinfo.size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置时间戳</span></span><br><span class="line">    <span class="keyword">if</span> (pts == <span class="number">0</span>) &#123;</span><br><span class="line">        pts = audioBufferinfo.presentationTimeUs;</span><br><span class="line">    &#125;</span><br><span class="line">    audioBufferinfo.presentationTimeUs = audioBufferinfo.presentationTimeUs - pts;</span><br><span class="line">    <span class="comment">//写入数据</span></span><br><span class="line">    mediaMuxer.writeSampleData(audioTrackIndex, outputBuffer, audioBufferinfo);</span><br><span class="line"></span><br><span class="line">    audioEncodec.releaseOutputBuffer(outputBufferIndex, <span class="keyword">false</span>);</span><br><span class="line">    outputBufferIndex = audioEncodec.dequeueOutputBuffer(audioBufferinfo, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>传入数据</li>
</ol>
<p>这里编码为<code>aac</code>不用添加<code>adts</code>是因为这里是写入到<code>mp4</code>,而不是单独的<code>aac</code>文件 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> audioPts;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getAudioPts</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> sampleRate, <span class="keyword">int</span> channel, <span class="keyword">int</span> sampleBit)</span> </span>&#123;</span><br><span class="line">    audioPts += (<span class="keyword">long</span>) (<span class="number">1.0</span> * size / (sampleRate * channel * (sampleBit / <span class="number">8</span>)) * <span class="number">1000000.0</span>);</span><br><span class="line">    <span class="keyword">return</span> audioPts;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putPcmData</span><span class="params">(<span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mAudioEncodecThread != <span class="keyword">null</span> &amp;&amp; !mAudioEncodecThread.isExit &amp;&amp; buffer != <span class="keyword">null</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> inputBufferIndex = mAudioEncodec.dequeueInputBuffer(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (inputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            ByteBuffer byteBuffer = mAudioEncodec.getInputBuffers()[inputBufferIndex];</span><br><span class="line">            byteBuffer.clear();</span><br><span class="line">            byteBuffer.put(buffer);</span><br><span class="line">            <span class="comment">//获取时间戳</span></span><br><span class="line">            <span class="keyword">long</span> pts = getAudioPts(size, sampleRate, channel, sampleBit);</span><br><span class="line">            Log.e(<span class="string">"zzz"</span>, <span class="string">"AudioTime = "</span> + pts / <span class="number">1000000.0f</span>);</span><br><span class="line">            mAudioEncodec.queueInputBuffer(inputBufferIndex, <span class="number">0</span>, size, pts, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>停止录制</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">audioEncodec.stop();</span><br><span class="line">audioEncodec.release();</span><br><span class="line">audioEncodec = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p><strong>音视频合成</strong></p>
<p>有了音视频数据，通过<code>MediaMuxer</code>进行合并。</p>
<p>官方示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">//MediaMuxer facilitates muxing elementary streams. Currently MediaMuxer supports MP4, Webm</span><br><span class="line">      //and 3GP file as the output. It also supports muxing B-frames in MP4 since Android Nougat.</span><br><span class="line">      //MediaMuxer muxer = new MediaMuxer(&quot;temp.mp4&quot;, OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br><span class="line">      // More often, the MediaFormat will be retrieved from MediaCodec.getOutputFormat()</span><br><span class="line">      // or MediaExtractor.getTrackFormat().</span><br><span class="line">      MediaFormat audioFormat = new MediaFormat(...);</span><br><span class="line">      MediaFormat videoFormat = new MediaFormat(...);</span><br><span class="line">      int audioTrackIndex = muxer.addTrack(audioFormat);</span><br><span class="line">      int videoTrackIndex = muxer.addTrack(videoFormat);</span><br><span class="line">      ByteBuffer inputBuffer = ByteBuffer.allocate(bufferSize);</span><br><span class="line">      boolean finished = false;</span><br><span class="line">      BufferInfo bufferInfo = new BufferInfo();</span><br><span class="line">     </span><br><span class="line">      muxer.start();</span><br><span class="line">      while(!finished) &#123;</span><br><span class="line">        // getInputBuffer() will fill the inputBuffer with one frame of encoded</span><br><span class="line">        // sample from either MediaCodec or MediaExtractor, set isAudioSample to</span><br><span class="line">        // true when the sample is audio data, set up all the fields of bufferInfo,</span><br><span class="line">        // and return true if there are no more samples.</span><br><span class="line">        finished = getInputBuffer(inputBuffer, isAudioSample, bufferInfo);</span><br><span class="line">        if (!finished) &#123;</span><br><span class="line">          int currentTrackIndex = isAudioSample ? audioTrackIndex : videoTrackIndex;</span><br><span class="line">          muxer.writeSampleData(currentTrackIndex, inputBuffer, bufferInfo);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      muxer.stop();</span><br><span class="line">      muxer.release();</span><br></pre></td></tr></table></figure>
<p>主要步骤如下:</p>
<ol>
<li>初始化</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mMediaMuxer = <span class="keyword">new</span> MediaMuxer(savePath, MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>获取录制音视频的<code>TrackIndex</code> </li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> outputBufferIndex = videoEncodec.dequeueOutputBuffer(videoBufferinfo, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (outputBufferIndex == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">    videoTrackIndex = mediaMuxer.addTrack(videoEncodec.getOutputFormat());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> outputBufferIndex = audioEncodec.dequeueOutputBuffer(audioBufferinfo, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (outputBufferIndex == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">    audioTrackIndex = mediaMuxer.addTrack(audioEncodec.getOutputFormat());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>开始合成</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mediaMuxer.start();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//写入视频数据</span></span><br><span class="line">mediaMuxer.writeSampleData(videoTrackIndex, outputBuffer, videoBufferinfo);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//写入音频数据</span></span><br><span class="line">mediaMuxer.writeSampleData(audioTrackIndex, outputBuffer, audioBufferinfo);</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>合成结束，写入头信息</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mediaMuxer.stop();</span><br><span class="line">mediaMuxer.release();</span><br><span class="line">mediaMuxer = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>具体查看demo：<br><a href="https://github.com/ChinaZeng/SurfaceRecodeDemo" target="_blank" rel="noopener">https://github.com/ChinaZeng/SurfaceRecodeDemo</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/OpenGLES添加水印.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/OpenGLES添加水印.html" itemprop="url">OpenGLES添加水印</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-24T14:21:47+08:00">
                2018-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/OpenGLES添加水印.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/OpenGLES添加水印.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,177字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  12分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>原理</strong></p>
<blockquote>
<p>多个纹理绘制在一个<code>surface</code>上</p>
</blockquote>
<p>理解了添加水印的原理，不管是视频水印还是图片水印都是很简单的了，只是使用的纹理不一样而已。如果是绘制文字水印的话，则需要将文字生成图片，然后将图片使用纹理绘制即可。</p>
<p><a href="https://www.jianshu.com/p/cb55d8f2b4d0" target="_blank" rel="noopener">Android OpenGLES 绘制图片纹理</a></p>
<p>那么怎样将多个纹理添加到同一个<code>surface</code>上？ </p>
<p>简单示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zzw.live.R;</span><br><span class="line"><span class="keyword">import</span> com.zzw.live.egl.EglSurfaceView;</span><br><span class="line"><span class="keyword">import</span> com.zzw.live.util.ShaderUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteOrder;</span><br><span class="line"><span class="keyword">import</span> java.nio.FloatBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CameraRender</span> <span class="keyword">implements</span> <span class="title">EglSurfaceView</span>.<span class="title">Render</span> </span>&#123;</span><br><span class="line">    <span class="comment">//顶点坐标</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> vertexData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            -<span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            -<span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line"></span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>,<span class="comment">//水印预留位置</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>,</span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>,</span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//纹理坐标  对应顶点坐标  与之映射</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> textureData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//每一次取点的时候取几个点</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COORDS_PER_VERTEX = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> vertexCount = vertexData.length / COORDS_PER_VERTEX;</span><br><span class="line">    <span class="comment">//每一次取的总的点 大小</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexStride = COORDS_PER_VERTEX * <span class="number">4</span>; <span class="comment">// 4 bytes per vertex</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//位置</span></span><br><span class="line">    <span class="keyword">protected</span> FloatBuffer vertexBuffer;</span><br><span class="line">    <span class="comment">//纹理</span></span><br><span class="line">    <span class="keyword">protected</span> FloatBuffer textureBuffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> program;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> avPosition;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//纹理位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> afPosition;</span><br><span class="line">    <span class="comment">//纹理  默认第0个位置 可以不获取</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> texture;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//vbo id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> vboId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fboTextureId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Bitmap bitmap;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> waterTextureId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CameraRender</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        initWater();</span><br><span class="line"></span><br><span class="line">        vertexBuffer = ByteBuffer.allocateDirect(vertexData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(vertexData);</span><br><span class="line">        vertexBuffer.position(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        textureBuffer = ByteBuffer.allocateDirect(textureData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(textureData);</span><br><span class="line">        textureBuffer.position(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="comment">//启用透明</span></span><br><span class="line">        GLES20.glEnable(GLES20.GL_BLEND);</span><br><span class="line">        GLES20.glBlendFunc(GLES20.GL_SRC_ALPHA, GLES20.GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line">        program = ShaderUtil.createProgram(ShaderUtil.readRawTxt(context, R.raw.vertex_shader_screen),</span><br><span class="line">                ShaderUtil.readRawTxt(context, R.raw.fragment_shader_screen));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (program &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//获取顶点坐标字段</span></span><br><span class="line">            avPosition = GLES20.glGetAttribLocation(program, <span class="string">"av_Position"</span>);</span><br><span class="line">            <span class="comment">//获取纹理坐标字段</span></span><br><span class="line">            afPosition = GLES20.glGetAttribLocation(program, <span class="string">"af_Position"</span>);</span><br><span class="line">            <span class="comment">//获取纹理字段</span></span><br><span class="line">            texture = GLES20.glGetUniformLocation(program, <span class="string">"sTexture"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建vbo</span></span><br><span class="line">            createVBO();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建水印纹理</span></span><br><span class="line">            createWaterTextureId();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//宽高</span></span><br><span class="line">        GLES20.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//清空颜色</span></span><br><span class="line">        GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT);</span><br><span class="line">        <span class="comment">//设置背景颜色</span></span><br><span class="line">        GLES20.glClearColor(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用程序</span></span><br><span class="line">        GLES20.glUseProgram(program);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置纹理</span></span><br><span class="line">        <span class="comment">//绑定渲染纹理  默认是第0个位置</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, fboTextureId);</span><br><span class="line"></span><br><span class="line">        GLES20.glEnableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glEnableVertexAttribArray(afPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用VBO设置纹理和顶点值</span></span><br><span class="line">        useVboSetVertext();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        //设置顶点位置值</span></span><br><span class="line"><span class="comment">//        GLES20.glVertexAttribPointer(avPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, false, vertexStride, vertexBuffer);</span></span><br><span class="line"><span class="comment">//        //设置纹理位置值</span></span><br><span class="line"><span class="comment">//        GLES20.glVertexAttribPointer(afPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, false, vertexStride, textureBuffer);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//绘制 GLES20.GL_TRIANGLE_STRIP:复用坐标</span></span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(afPosition);</span><br><span class="line">        <span class="comment">//解绑纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        drawWater();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(<span class="keyword">int</span> fboTextureId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fboTextureId = fboTextureId;</span><br><span class="line">        onDrawFrame();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建vbo</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createVBO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 创建VBO</span></span><br><span class="line">        <span class="keyword">int</span>[] vbos = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        GLES20.glGenBuffers(vbos.length, vbos, <span class="number">0</span>);</span><br><span class="line">        vboId = vbos[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//2. 绑定VBO</span></span><br><span class="line">        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, vboId);</span><br><span class="line">        <span class="comment">//3. 分配VBO需要的缓存大小</span></span><br><span class="line">        GLES20.glBufferData(GLES20.GL_ARRAY_BUFFER, vertexData.length * <span class="number">4</span> + textureData.length * <span class="number">4</span>, <span class="keyword">null</span>, GLES20.GL_STATIC_DRAW);</span><br><span class="line">        <span class="comment">//4. 为VBO设置顶点数据的值</span></span><br><span class="line">        GLES20.glBufferSubData(GLES20.GL_ARRAY_BUFFER, <span class="number">0</span>, vertexData.length * <span class="number">4</span>, vertexBuffer);</span><br><span class="line">        GLES20.glBufferSubData(GLES20.GL_ARRAY_BUFFER, vertexData.length * <span class="number">4</span>, textureData.length * <span class="number">4</span>, textureBuffer);</span><br><span class="line">        <span class="comment">//5. 解绑VBO</span></span><br><span class="line">        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用vbo设置顶点位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">useVboSetVertext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 绑定VBO</span></span><br><span class="line">        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, vboId);</span><br><span class="line">        <span class="comment">//2. 设置顶点数据</span></span><br><span class="line">        GLES20.glVertexAttribPointer(avPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, <span class="number">0</span>);</span><br><span class="line">        GLES20.glVertexAttribPointer(afPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, vertexData.length * <span class="number">4</span>);</span><br><span class="line">        <span class="comment">//3. 解绑VBO</span></span><br><span class="line">        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initWater</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bitmap = ShaderUtil.createTextImage(<span class="string">"我是水印"</span>, <span class="number">40</span>, <span class="string">"#fff000"</span>, <span class="string">"#00000000"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置位置 根据需求自己配置</span></span><br><span class="line">        <span class="keyword">float</span> r = <span class="number">1.0f</span> * bitmap.getWidth() / bitmap.getHeight();</span><br><span class="line">        <span class="keyword">float</span> w = r * <span class="number">0.1f</span>;</span><br><span class="line">        vertexData[<span class="number">12</span>] = <span class="number">0.8f</span> - w;</span><br><span class="line">        vertexData[<span class="number">13</span>] = -<span class="number">0.8f</span>;</span><br><span class="line">        vertexData[<span class="number">14</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        vertexData[<span class="number">15</span>] = <span class="number">0.8f</span>;</span><br><span class="line">        vertexData[<span class="number">16</span>] = -<span class="number">0.8f</span>;</span><br><span class="line">        vertexData[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        vertexData[<span class="number">18</span>] = <span class="number">0.8f</span> - w;</span><br><span class="line">        vertexData[<span class="number">19</span>] = -<span class="number">0.7f</span>;</span><br><span class="line">        vertexData[<span class="number">20</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        vertexData[<span class="number">21</span>] = <span class="number">0.8f</span>;</span><br><span class="line">        vertexData[<span class="number">22</span>] = -<span class="number">0.7f</span>;</span><br><span class="line">        vertexData[<span class="number">23</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createWaterTextureId</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] textureIds = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">//创建纹理</span></span><br><span class="line">        GLES20.glGenTextures(<span class="number">1</span>, textureIds, <span class="number">0</span>);</span><br><span class="line">        waterTextureId = textureIds[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//绑定纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, waterTextureId);</span><br><span class="line">        <span class="comment">//环绕（超出纹理坐标范围）  （s==x t==y GL_REPEAT 重复）</span></span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_REPEAT);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_REPEAT);</span><br><span class="line">        <span class="comment">//过滤（纹理像素映射到坐标点）  （缩小、放大：GL_LINEAR线性）</span></span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</span><br><span class="line"></span><br><span class="line">        ByteBuffer bitmapBuffer = ByteBuffer.allocate(bitmap.getHeight() * bitmap.getWidth() * <span class="number">4</span>);<span class="comment">//RGBA</span></span><br><span class="line">        bitmap.copyPixelsToBuffer(bitmapBuffer);</span><br><span class="line">        <span class="comment">//将bitmapBuffer位置移动到初始位置</span></span><br><span class="line">        bitmapBuffer.flip();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置内存大小绑定内存地址</span></span><br><span class="line">        GLES20.glTexImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, GLES20.GL_RGBA, bitmap.getWidth(), bitmap.getHeight(),</span><br><span class="line">                <span class="number">0</span>, GLES20.GL_RGBA, GLES20.GL_UNSIGNED_BYTE, bitmapBuffer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解绑纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawWater</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, vboId);</span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, waterTextureId);</span><br><span class="line"></span><br><span class="line">        GLES20.glEnableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glEnableVertexAttribArray(afPosition);</span><br><span class="line"></span><br><span class="line">        GLES20.glVertexAttribPointer(avPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride,</span><br><span class="line">                vertexStride * <span class="number">4</span>);<span class="comment">//四个坐标之后的是水印的坐标</span></span><br><span class="line">        GLES20.glVertexAttribPointer(afPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride,</span><br><span class="line">                vertexData.length * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        GLES20.glDisableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(afPosition);</span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line">        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ShaderUtil.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShaderUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ShaderUtil"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readRawTxt</span><span class="params">(Context context, <span class="keyword">int</span> rawId)</span> </span>&#123;</span><br><span class="line">        InputStream inputStream = context.getResources().openRawResource(rawId);</span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream));</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sb.append(line).append(<span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            reader.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">loadShader</span><span class="params">(<span class="keyword">int</span> shaderType, String source)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// create a vertex shader type (GLES20.GL_VERTEX_SHADER)</span></span><br><span class="line">        <span class="comment">// or a fragment shader type (GLES20.GL_FRAGMENT_SHADER)</span></span><br><span class="line">        <span class="keyword">int</span> shader = GLES20.glCreateShader(shaderType);</span><br><span class="line">        <span class="keyword">if</span> (shader != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//添加代码到shader</span></span><br><span class="line">            GLES20.glShaderSource(shader, source);</span><br><span class="line">            <span class="comment">//编译shader</span></span><br><span class="line">            GLES20.glCompileShader(shader);</span><br><span class="line">            <span class="keyword">int</span>[] compile = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//检测是否编译成功</span></span><br><span class="line">            GLES20.glGetShaderiv(shader, GLES20.GL_COMPILE_STATUS, compile, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (compile[<span class="number">0</span>] != GLES20.GL_TRUE) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"shader compile error"</span>);</span><br><span class="line">                GLES20.glDeleteShader(shader);</span><br><span class="line">                shader = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> shader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">createProgram</span><span class="params">(String vertexSource, String fragmentSource)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取vertex shader</span></span><br><span class="line">        <span class="keyword">int</span> vertexShader = loadShader(GLES20.GL_VERTEX_SHADER, vertexSource);</span><br><span class="line">        <span class="keyword">if</span> (vertexShader == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取fragment shader</span></span><br><span class="line">        <span class="keyword">int</span> fragmentShader = loadShader(GLES20.GL_FRAGMENT_SHADER, fragmentSource);</span><br><span class="line">        <span class="keyword">if</span> (fragmentShader == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建一个空的渲染程序</span></span><br><span class="line">        <span class="keyword">int</span> program = GLES20.glCreateProgram();</span><br><span class="line">        <span class="keyword">if</span> (program != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//添加vertexShader到渲染程序</span></span><br><span class="line">            GLES20.glAttachShader(program, vertexShader);</span><br><span class="line">            <span class="comment">//添加fragmentShader到渲染程序</span></span><br><span class="line">            GLES20.glAttachShader(program, fragmentShader);</span><br><span class="line">            <span class="comment">//关联为可执行渲染程序</span></span><br><span class="line">            GLES20.glLinkProgram(program);</span><br><span class="line">            <span class="keyword">int</span>[] linsStatus = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//检测是否关联成功</span></span><br><span class="line">            GLES20.glGetProgramiv(program, GLES20.GL_LINK_STATUS, linsStatus, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (linsStatus[<span class="number">0</span>] != GLES20.GL_TRUE) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"link program error"</span>);</span><br><span class="line">                GLES20.glDeleteProgram(program);</span><br><span class="line">                program = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> program;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">createTextImage</span><span class="params">(String text, <span class="keyword">int</span> textSize, String textColor, String bgColor, <span class="keyword">int</span> padding)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Paint paint = <span class="keyword">new</span> Paint();</span><br><span class="line">        paint.setColor(Color.parseColor(textColor));</span><br><span class="line">        paint.setTextSize(textSize);</span><br><span class="line">        paint.setStyle(Paint.Style.FILL);</span><br><span class="line">        paint.setAntiAlias(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> width = paint.measureText(text, <span class="number">0</span>, text.length());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> top = paint.getFontMetrics().top;</span><br><span class="line">        <span class="keyword">float</span> bottom = paint.getFontMetrics().bottom;</span><br><span class="line"></span><br><span class="line">        Bitmap bm = Bitmap.createBitmap((<span class="keyword">int</span>) (width + padding * <span class="number">2</span>), (<span class="keyword">int</span>) ((bottom - top) + padding * <span class="number">2</span>), Bitmap.Config.ARGB_8888);</span><br><span class="line">        Canvas canvas = <span class="keyword">new</span> Canvas(bm);</span><br><span class="line"></span><br><span class="line">        canvas.drawColor(Color.parseColor(bgColor));</span><br><span class="line">        canvas.drawText(text, padding, -top + padding, paint);</span><br><span class="line">        <span class="keyword">return</span> bm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">loadBitmapTexture</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] textureIds = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        GLES20.glGenTextures(<span class="number">1</span>, textureIds, <span class="number">0</span>);</span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureIds[<span class="number">0</span>]);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_REPEAT);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_REPEAT);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</span><br><span class="line"></span><br><span class="line">        ByteBuffer bitmapBuffer = ByteBuffer.allocate(bitmap.getHeight() * bitmap.getWidth() * <span class="number">4</span>);<span class="comment">//ARGB</span></span><br><span class="line">        bitmap.copyPixelsToBuffer(bitmapBuffer);</span><br><span class="line">        bitmapBuffer.flip();</span><br><span class="line"></span><br><span class="line">        GLES20.glTexImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, GLES20.GL_RGBA, bitmap.getWidth(),</span><br><span class="line">                bitmap.getHeight(), <span class="number">0</span>, GLES20.GL_RGBA, GLES20.GL_UNSIGNED_BYTE, bitmapBuffer);</span><br><span class="line">        <span class="keyword">return</span> textureIds[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们只需要在当前<code>GL_TEXTURE_2D</code>纹理绘制之后在<code>glBindTexture</code>绑定水印的纹理绘制即可。这里需要注意的几个点:</p>
<ol>
<li>需要开启透明,不然没有透明效果。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//启用透明</span></span><br><span class="line">GLES20.glEnable(GLES20.GL_BLEND);</span><br><span class="line">GLES20.glBlendFunc(GLES20.GL_SRC_ALPHA, GLES20.GL_ONE_MINUS_SRC_ALPHA);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>如果是<code>OES</code>纹理上添加水印，需要开个<code>fbo</code>来绘制<code>OES</code>的纹理，然后另外用一个<code>Render</code>来绘制<code>OES</code>的<code>fbo</code>纹理和添加水印，也就是说:<strong><code>OES</code>和<code>2D</code>不能混用</strong>，不然不会起作用。如果可以混用（我试了混用绘制不出来），可以留言告诉我一下，谢谢。</p>
</li>
<li><p>使用<code>VBO</code>需要注意点的位置。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/OpenGLES渲染画面通过MediaCodec录制.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/OpenGLES渲染画面通过MediaCodec录制.html" itemprop="url">OpenGLES渲染画面通过MediaCodec录制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-22T17:55:44+08:00">
                2018-08-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/OpenGLES渲染画面通过MediaCodec录制.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/OpenGLES渲染画面通过MediaCodec录制.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  526字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>录制原理</strong>  </p>
<ul>
<li>预览</li>
</ul>
<p>通过<code>fbo</code>处理视频数据,通过<code>samplerExternalOES</code>纹理来创建<code>SurfaceTexture</code>,这样的话摄像头数据就和<code>fbo</code>相关联，具体可以看<a href="https://www.jianshu.com/p/6e61efc17008" target="_blank" rel="noopener">OpenGLES通过SurfaceTexture预览摄像头画面</a></p>
<ul>
<li>录制</li>
</ul>
<p>通过<code>MediaCodec</code>创建一个<code>surface</code>，然后通过创建一个新的<code>egl</code>环境共享预览的<code>EglContext</code>和这个<code>surface</code>绑定，渲染<code>fbo</code>绑定的纹理，即可录制。<br><code>egl</code>环境配置：<br><a href="https://www.jianshu.com/p/ce3496ab9e02" target="_blank" rel="noopener">Android配置EGL环境</a><br><a href="https://www.jianshu.com/p/08f9338aebb1" target="_blank" rel="noopener">Android自定义GLSurfaceView</a></p>
<p>流程如下图所示:<br><img src="https://note.youdao.com/yws/api/personal/file/D67B5A7797E347739DED9C15657BE017?method=download&amp;shareKey=fe4202e02956a4ded59b495e96fe47ca" alt="录制原理"></p>
<p><strong>MediaCodec录制主要代码</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="keyword">private</span> MediaMuxer mMediaMuxer;</span><br><span class="line"> <span class="keyword">private</span> MediaCodec.BufferInfo mBuffInfo;</span><br><span class="line"> <span class="keyword">private</span> MediaCodec mVideoEncodec;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">int</span> width, height;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//初始化</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initEncoder</span><span class="params">(EGLContext eglContext,String savePath,String mineType,<span class="keyword">int</span> width,<span class="keyword">int</span> height)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.width = width;</span><br><span class="line">        <span class="keyword">this</span>.height = height;</span><br><span class="line">        <span class="keyword">this</span>.mEGLContext = eglContext;</span><br><span class="line">        initMediaEncoder(savePath,mineType,width,height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initMediaEncoder</span><span class="params">(String savePath, String mineType, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mMediaMuxer = <span class="keyword">new</span> MediaMuxer(savePath,MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br><span class="line">            initVideoEncoder(mineType,width,height);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initVideoEncoder</span><span class="params">(String mineType, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mVideoEncodec= MediaCodec.createEncoderByType(mineType);</span><br><span class="line"></span><br><span class="line">            MediaFormat videoFormat = MediaFormat.createVideoFormat(mineType,width,height);</span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, MediaCodecInfo.CodecCapabilities.COLOR_FormatSurface);</span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_FRAME_RATE,<span class="number">30</span>);<span class="comment">//30帧</span></span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_BIT_RATE,width*height*<span class="number">4</span>);<span class="comment">//RGBA</span></span><br><span class="line">            videoFormat.setInteger(MediaFormat.KEY_BIT_RATE,width*height*<span class="number">4</span>);<span class="comment">//RGBA</span></span><br><span class="line">            <span class="comment">//设置压缩等级  默认是baseline</span></span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">                videoFormat.setInteger(MediaFormat.KEY_PROFILE,MediaCodecInfo.CodecProfileLevel.AVCProfileMain);</span><br><span class="line">                <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">                    videoFormat.setInteger(MediaFormat.KEY_LEVEL, MediaCodecInfo.CodecProfileLevel.AVCLevel3);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mVideoEncodec.configure(videoFormat,<span class="keyword">null</span>,<span class="keyword">null</span>,MediaCodec.CONFIGURE_FLAG_ENCODE);</span><br><span class="line"></span><br><span class="line">            mBuffInfo = <span class="keyword">new</span> MediaCodec.BufferInfo();</span><br><span class="line">            mSurface = mVideoEncodec.createInputSurface();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            mVideoEncodec=<span class="keyword">null</span>;</span><br><span class="line">            mBuffInfo=<span class="keyword">null</span>;</span><br><span class="line">            mSurface=<span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//开始录制</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startRecode</span><span class="params">()</span></span>&#123;</span><br><span class="line">    videoEncodec.start();</span><br><span class="line">    <span class="keyword">int</span> outputBufferIndex = videoEncodec.dequeueOutputBuffer(videoBufferinfo, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (outputBufferIndex == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) &#123;</span><br><span class="line">        videoTrackIndex = mediaMuxer.addTrack(videoEncodec.getOutputFormat());</span><br><span class="line">        mediaMuxer.start();</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (outputBufferIndex&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">            ByteBuffer outputBuffer= videoEncodec.getOutputBuffers()[outputBufferIndex];</span><br><span class="line">            outputBuffer.position(videoBufferinfo.offset);</span><br><span class="line">            outputBuffer.limit(videoBufferinfo.offset + videoBufferinfo.size);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置时间戳</span></span><br><span class="line">            <span class="keyword">if</span>(pts==<span class="number">0</span>)&#123;</span><br><span class="line">                pts = videoBufferinfo.presentationTimeUs;</span><br><span class="line">            &#125;</span><br><span class="line">            videoBufferinfo.presentationTimeUs = videoBufferinfo.presentationTimeUs - pts;</span><br><span class="line">            <span class="comment">//写入数据</span></span><br><span class="line">            mediaMuxer.writeSampleData(videoTrackIndex,outputBuffer,videoBufferinfo);</span><br><span class="line">            <span class="keyword">if</span>(encoderWeakReference.get().onMediaInfoListener!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                encoderWeakReference.get().onMediaInfoListener.onMediaTime((<span class="keyword">int</span>) (videoBufferinfo.presentationTimeUs/<span class="number">1000000</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            videoEncodec.releaseOutputBuffer(outputBufferIndex,<span class="keyword">false</span>);</span><br><span class="line">            outputBufferIndex = videoEncodec.dequeueOutputBuffer(videoBufferinfo, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//停止录制</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopRecode</span><span class="params">()</span></span>&#123;</span><br><span class="line">    videoEncodec.stop();</span><br><span class="line">    videoEncodec.release();</span><br><span class="line">    videoEncodec =<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    mediaMuxer.stop();</span><br><span class="line">    mediaMuxer.release();</span><br><span class="line">    mediaMuxer = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体示例请看:<br><a href="https://github.com/ChinaZeng/SurfaceRecodeDemo" target="_blank" rel="noopener">https://github.com/ChinaZeng/SurfaceRecodeDemo</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/OpenGLES通过SurfaceTexture预览摄像头画面.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/OpenGLES通过SurfaceTexture预览摄像头画面.html" itemprop="url">OpenGLES通过SurfaceTexture预览摄像头画面</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-21T16:10:03+08:00">
                2018-08-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/OpenGLES通过SurfaceTexture预览摄像头画面.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/OpenGLES通过SurfaceTexture预览摄像头画面.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,110字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在这篇文章主要用到的知识点有如下，建议先看一下:  </p>
<p><a href="https://www.jianshu.com/p/cb55d8f2b4d0" target="_blank" rel="noopener">OpenGLES绘制图片纹理</a></p>
<p><a href="https://www.jianshu.com/p/d1be0d2921c6" target="_blank" rel="noopener">OpenGLES顶点缓冲VBO</a></p>
<p><a href="https://www.jianshu.com/p/78a64b8fb315" target="_blank" rel="noopener">OpenGLES帧缓冲FBO</a></p>
<p>有一个渲染流数据的相关的示例，也可以看一下，这样对本篇理解就会很简单 :</p>
<p><a href="https://www.jianshu.com/p/d75cd124ba21" target="_blank" rel="noopener">Android OpenGLES渲染MediaCodec解码数据</a></p>
<p><strong>原理</strong></p>
<blockquote>
<p>利用<code>OpenGL</code>生成纹理并绑定到<code>SurfaceTexture</code>,然后把<code>camera</code>的预览数据设置显示到<code>SurfaceTexture</code>中，这样就可以在<code>OpenGL</code>中拿到摄像头数据并显示了。</p>
</blockquote>
<p><strong>主要步骤</strong></p>
<blockquote>
<p>1.<code>OpenGL ES</code>生成纹理<br>2.<code>OpenGL ES</code>创建<code>SurfaceTexture</code>并绑定<br>3.<code>OpenGL ES</code>摄像头预览</p>
</blockquote>
<p>比如美颜相机那些，处理摄像头数据展示出来，为了提高预览的效率，所以这里使用了<code>VBO</code>和<code>FBO</code>,如果不知道这个，请看上面的文章。  </p>
<p><code>FBO</code>所需的<code>glsl</code>:<br>vertex_shader.glsl</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">attribute</span> <span class="type">vec4</span> av_Position;<span class="comment">//顶点位置</span></span><br><span class="line"><span class="keyword">attribute</span> <span class="type">vec2</span> af_Position;<span class="comment">//纹理位置</span></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec2</span> v_texPo;<span class="comment">//纹理位置  与fragment_shader交互</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> u_Matrix;<span class="comment">//矩阵变换</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    v_texPo = af_Position;</span><br><span class="line">    <span class="built_in">gl_Position</span> = av_Position * u_Matrix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fragment_shader.glsl<br><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#extension GL_OES_EGL_image_external : require //申明使用扩展纹理</span></span><br><span class="line"><span class="keyword">precision</span> <span class="keyword">mediump</span> <span class="type">float</span>;<span class="comment">//精度 为float</span></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec2</span> v_texPo;<span class="comment">//纹理位置  接收于vertex_shader</span></span><br><span class="line"><span class="keyword">uniform</span> samplerExternalOES  sTexture;<span class="comment">//加载流数据(摄像头数据)</span></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    <span class="built_in">gl_FragColor</span>=<span class="built_in">texture2D</span>(sTexture, v_texPo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里使用<code>FBO</code>里面使用<code>samplerExternalOES</code>是为了加载流数据，摄像头数据属于流数据，所以这里需要用这个。</p>
<p>创建相机预览扩展纹理:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 创建摄像头预览扩展纹理</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createCameraRenderTexture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span>[] textureIds = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">       GLES20.glGenTextures(<span class="number">1</span>, textureIds, <span class="number">0</span>);</span><br><span class="line">       cameraRenderTextureId = textureIds[<span class="number">0</span>];</span><br><span class="line">       GLES20.glBindTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, cameraRenderTextureId);</span><br><span class="line">       <span class="comment">//环绕（超出纹理坐标范围）  （s==x t==y GL_REPEAT 重复）</span></span><br><span class="line">       GLES20.glTexParameteri(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_REPEAT);</span><br><span class="line">       GLES20.glTexParameteri(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_REPEAT);</span><br><span class="line">       <span class="comment">//过滤（纹理像素映射到坐标点）  （缩小、放大：GL_LINEAR线性）</span></span><br><span class="line">       GLES20.glTexParameteri(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">       GLES20.glTexParameteri(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</span><br><span class="line"></span><br><span class="line">       surfaceTexture = <span class="keyword">new</span> SurfaceTexture(cameraRenderTextureId);</span><br><span class="line">       surfaceTexture.setOnFrameAvailableListener(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (onSurfaceListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">//这里相机拿到surfaceTexture绑定</span></span><br><span class="line">           onSurfaceListener.onSurfaceCreate(surfaceTexture);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 解绑扩展纹理</span></span><br><span class="line">       GLES20.glBindTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, <span class="number">0</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>camera绑定SurfaceTexture:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">camera.setPreviewTexture(surfaceTexture);</span><br></pre></td></tr></table></figure></p>
<p>预览画面，先通过<code>fbo</code>处理，然后拿到<code>fbo</code>的纹理<code>id</code>渲染即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//调用触发onFrameAvailable</span></span><br><span class="line">        surfaceTexture.updateTexImage();</span><br><span class="line">        <span class="comment">//清空颜色</span></span><br><span class="line">        GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT);</span><br><span class="line">        <span class="comment">//设置背景颜色</span></span><br><span class="line">        GLES20.glClearColor(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用程序</span></span><br><span class="line">        GLES20.glUseProgram(program);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绑定fbo</span></span><br><span class="line">        GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, fboId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//摄像头预览扩展纹理赋值</span></span><br><span class="line">        GLES20.glActiveTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES);</span><br><span class="line">        GLES20.glBindTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, cameraRenderTextureId);</span><br><span class="line">        GLES20.glUniform1i(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//给变换矩阵赋值</span></span><br><span class="line">        GLES20.glUniformMatrix4fv(uMatrix, <span class="number">1</span>, <span class="keyword">false</span>, matrix, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        GLES20.glEnableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glEnableVertexAttribArray(afPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用VBO设置纹理和顶点值</span></span><br><span class="line">        useVboSetVertext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绘制 GLES20.GL_TRIANGLE_STRIP:复用坐标</span></span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="number">0</span>, vertexCount);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(afPosition);</span><br><span class="line"></span><br><span class="line">        GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//渲染显示</span></span><br><span class="line">        cameraRender.onDraw(fboTextureId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>摄像头方向调整</strong></p>
<p>默认的摄像头预览不同的角度预览出来效果是不同的，我们需要把它给矫正，一般通常是在<code>camera</code>里面设置<code>parms</code>，这里通过<code>OpenGLES</code>自己矫正，通过变换矩阵实现即可:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//变换矩阵 location</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> uMatrix;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//变换矩阵</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">float</span>[] matrix = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">uMatrix = GLES20.glGetUniformLocation(program, <span class="string">"u_Matrix"</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="comment">//...</span></span><br><span class="line"> <span class="comment">//给变换矩阵赋值</span></span><br><span class="line">GLES20.glUniformMatrix4fv(uMatrix, <span class="number">1</span>, <span class="keyword">false</span>, matrix, <span class="number">0</span>); </span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化矩阵</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resetMatirx</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    Matrix.setIdentityM(matrix, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 旋转</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> angle</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> y</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> z</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAngle</span><span class="params">(<span class="keyword">float</span> angle, <span class="keyword">float</span> x, <span class="keyword">float</span> y, <span class="keyword">float</span> z)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//旋转</span></span><br><span class="line">    Matrix.rotateM(matrix, <span class="number">0</span>, angle, x, y, z);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在外层调用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">previewAngle</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> angle = ((WindowManager) context.getSystemService(Context.WINDOW_SERVICE)).getDefaultDisplay().getRotation();</span><br><span class="line">        render.resetMatirx();</span><br><span class="line">        <span class="keyword">switch</span> (angle) &#123;</span><br><span class="line">            <span class="keyword">case</span> Surface.ROTATION_0:</span><br><span class="line">                <span class="keyword">if</span> (cameraId == Camera.CameraInfo.CAMERA_FACING_BACK) &#123;</span><br><span class="line">                    render.setAngle(<span class="number">90</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">                    render.setAngle(<span class="number">180</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    render.setAngle(<span class="number">90f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Surface.ROTATION_90:</span><br><span class="line">                <span class="keyword">if</span> (cameraId == Camera.CameraInfo.CAMERA_FACING_BACK) &#123;</span><br><span class="line">                    render.setAngle(<span class="number">180</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">                    render.setAngle(<span class="number">180</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    render.setAngle(<span class="number">90f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Surface.ROTATION_180:</span><br><span class="line">                <span class="keyword">if</span> (cameraId == Camera.CameraInfo.CAMERA_FACING_BACK) &#123;</span><br><span class="line">                    render.setAngle(<span class="number">90f</span>, <span class="number">0.0f</span>, <span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line">                    render.setAngle(<span class="number">180f</span>, <span class="number">0.0f</span>, <span class="number">1f</span>, <span class="number">0f</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    render.setAngle(-<span class="number">90</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Surface.ROTATION_270:</span><br><span class="line">                <span class="keyword">if</span> (cameraId == Camera.CameraInfo.CAMERA_FACING_BACK) &#123;</span><br><span class="line">                    render.setAngle(<span class="number">180f</span>, <span class="number">0.0f</span>, <span class="number">1f</span>, <span class="number">0f</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    render.setAngle(<span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>具体代码下载地址:  <a href="https://github.com/ChinaZeng/OpenGLESCameraDemo" target="_blank" rel="noopener">https://github.com/ChinaZeng/OpenGLESCameraDemo</a></p>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/OpenGLES正交投影.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/OpenGLES正交投影.html" itemprop="url">OpenGLES正交投影</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-17T15:22:16+08:00">
                2018-08-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/OpenGLES正交投影.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/OpenGLES正交投影.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,456字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  8分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在图片渲染的时候，之前使用的顶点坐标是占满整个屏幕的归一化坐标<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//顶点坐标</span></span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">float</span> vertexData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">           -<span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">           <span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">           -<span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">           <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure></p>
<p>这样就导致了如下图所示的的问题</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/207F6FABD59F43A4BC3C7B8EDD690167?method=download&amp;shareKey=a7d0ebb87824c4cb766c79105e493d18" alt="横竖屏切换存在的问题"></p>
<p>所以我们应该根据屏幕宽高和图片宽高对应的比例算出正确的位置:</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/6C83107622EB45ACBA03C05D0334DA3D?method=download&amp;shareKey=c89d0611219943dfade055e5b2dd9db3" alt="横竖屏切换问题解决"></p>
<p>上面我们得到的（ ？）是不在归一化坐标范围内的，为了能使<code>OpenGL</code>正确的渲染，我们就需要把（？）以及其他边统一转换到归一化坐标内，这个操作就是<strong>正交投影</strong></p>
<p>使用正交投影，不管物体多远多近，物体看起来总是形状、大小比例相同的。</p>
<p>在OpenGLES里面使用投影矩阵:</p>
<p>vertex_shader_m.glsl</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">attribute</span> <span class="type">vec4</span> av_Position;<span class="comment">//顶点位置</span></span><br><span class="line"><span class="keyword">attribute</span> <span class="type">vec2</span> af_Position;<span class="comment">//纹理位置</span></span><br><span class="line"><span class="keyword">varying</span> <span class="type">vec2</span> v_texPo;<span class="comment">//纹理位置  与fragment_shader交互</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> u_Matrix; <span class="comment">//投影矩阵</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    v_texPo = af_Position;</span><br><span class="line">    <span class="built_in">gl_Position</span> = av_Position * u_Matrix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在使用的时候:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//投影矩阵</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> uMatrix;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">float</span>[] matrix = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">4</span> * <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//1. 获取投影矩阵</span></span><br><span class="line">uMatrix = GLES20.glGetUniformLocation(program, <span class="string">"u_Matrix"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//2. 计算值</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (width &gt; height) &#123;</span><br><span class="line">        <span class="keyword">float</span> x = width / ((<span class="keyword">float</span>) height / bitmap.getHeight() * bitmap.getWidth());</span><br><span class="line">        Matrix.orthoM(matrix, <span class="number">0</span>, -x, x, -<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">float</span> y = height / ((<span class="keyword">float</span>) width / bitmap.getWidth() * bitmap.getHeight());</span><br><span class="line">        Matrix.orthoM(matrix, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">1</span>, -y, y, -<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 赋值</span></span><br><span class="line"></span><br><span class="line">GLES20.glUniformMatrix4fv(uMatrix, <span class="number">1</span>, <span class="keyword">false</span>, matrix, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>主要代码如下：BitmapTexture.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLUtils;</span><br><span class="line"><span class="keyword">import</span> android.opengl.Matrix;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteOrder;</span><br><span class="line"><span class="keyword">import</span> java.nio.FloatBuffer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//纹理  根据坐标系映射</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitmapTexture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//顶点坐标</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> vertexData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            -<span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            -<span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//纹理坐标  对应顶点坐标  与之映射</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> textureData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每一次取点的时候取几个点</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COORDS_PER_VERTEX = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexCount = vertexData.length / COORDS_PER_VERTEX;</span><br><span class="line">    <span class="comment">//每一次取的总的点 大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexStride = COORDS_PER_VERTEX * <span class="number">4</span>; <span class="comment">// 4 bytes per vertex</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//位置</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer vertexBuffer;</span><br><span class="line">    <span class="comment">//纹理</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer textureBuffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> program;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> avPosition;</span><br><span class="line">    <span class="comment">//纹理位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> afPosition;</span><br><span class="line">    <span class="comment">//正交投影</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> uMatrix;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span>[] matrix = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">4</span> * <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//需要渲染的纹理id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> imageTextureId;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Bitmap bitmap;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBitmap</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bitmap = bitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BitmapTexture</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line"></span><br><span class="line">        vertexBuffer = ByteBuffer.allocateDirect(vertexData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(vertexData);</span><br><span class="line">        vertexBuffer.position(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        textureBuffer = ByteBuffer.allocateDirect(textureData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(textureData);</span><br><span class="line">        textureBuffer.position(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String vertexSource = ShaderUtil.readRawTxt(context, R.raw.vertex_shader_m);</span><br><span class="line">        String fragmentSource = ShaderUtil.readRawTxt(context, R.raw.fragment_shader);</span><br><span class="line">        program = ShaderUtil.createProgram(vertexSource, fragmentSource);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (program &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//获取顶点坐标字段</span></span><br><span class="line">            avPosition = GLES20.glGetAttribLocation(program, <span class="string">"av_Position"</span>);</span><br><span class="line">            <span class="comment">//获取纹理坐标字段</span></span><br><span class="line">            afPosition = GLES20.glGetAttribLocation(program, <span class="string">"af_Position"</span>);</span><br><span class="line"></span><br><span class="line">            uMatrix = GLES20.glGetUniformLocation(program, <span class="string">"u_Matrix"</span>);</span><br><span class="line"></span><br><span class="line">            imageTextureId = createImageTexture();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (width &gt; height) &#123;</span><br><span class="line">            <span class="keyword">float</span> x = width / ((<span class="keyword">float</span>) height / bitmap.getHeight() * bitmap.getWidth());</span><br><span class="line">            Matrix.orthoM(matrix, <span class="number">0</span>, -x, x, -<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">float</span> y = height / ((<span class="keyword">float</span>) width / bitmap.getWidth() * bitmap.getHeight());</span><br><span class="line">            Matrix.orthoM(matrix, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">1</span>, -y, y, -<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用程序</span></span><br><span class="line">        GLES20.glUseProgram(program);</span><br><span class="line"></span><br><span class="line">        GLES20.glUniformMatrix4fv(uMatrix, <span class="number">1</span>, <span class="keyword">false</span>, matrix, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绑定渲染纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, imageTextureId);</span><br><span class="line"></span><br><span class="line">        GLES20.glEnableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glEnableVertexAttribArray(afPosition);</span><br><span class="line">        <span class="comment">//设置顶点位置值</span></span><br><span class="line">        GLES20.glVertexAttribPointer(avPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, vertexBuffer);</span><br><span class="line">        <span class="comment">//设置纹理位置值</span></span><br><span class="line">        GLES20.glVertexAttribPointer(afPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, textureBuffer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绘制 GLES20.GL_TRIANGLE_STRIP:复用坐标</span></span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="number">0</span>, vertexCount);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(afPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解绑纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createImageTexture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] textureIds = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">//创建纹理</span></span><br><span class="line">        GLES20.glGenTextures(<span class="number">1</span>, textureIds, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (textureIds[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//绑定纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureIds[<span class="number">0</span>]);</span><br><span class="line">        <span class="comment">//环绕（超出纹理坐标范围）  （s==x t==y GL_REPEAT 重复）</span></span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_REPEAT);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_REPEAT);</span><br><span class="line">        <span class="comment">//过滤（纹理像素映射到坐标点）  （缩小、放大：GL_LINEAR线性）</span></span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//测试图片</span></span><br><span class="line">        GLUtils.texImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, bitmap, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解绑纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> textureIds[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意:</strong> 在使用<code>FBO</code>  <code>GLES20.glTexImage2D</code>分配内存大小的时候，需要根据横竖屏来设置值。不然计算出来的值和渲染的宽高不一样，渲染就会出现变形。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (width &gt; height) &#123;</span><br><span class="line">           <span class="keyword">float</span> x = width / ((<span class="keyword">float</span>) height / bitmap.getHeight() * bitmap.getWidth());</span><br><span class="line">           Matrix.orthoM(matrix, <span class="number">0</span>, -x, x, -<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">float</span> y = height / ((<span class="keyword">float</span>) width / bitmap.getWidth() * bitmap.getHeight());</span><br><span class="line">           Matrix.orthoM(matrix, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">1</span>, -y, y, -<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (fboId != <span class="number">0</span>) &#123;</span><br><span class="line">           GLES20.glDeleteFramebuffers(<span class="number">1</span>, <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;fboId&#125;, <span class="number">0</span>);</span><br><span class="line">           GLES20.glDeleteTextures(<span class="number">1</span>, <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;imageTextureId&#125;, <span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       createFBO(width, height);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createFBO</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"bitmap is null"</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//1. 创建FBO</span></span><br><span class="line">       <span class="keyword">int</span>[] fbos = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">       GLES20.glGenFramebuffers(<span class="number">1</span>, fbos, <span class="number">0</span>);</span><br><span class="line">       fboId = fbos[<span class="number">0</span>];</span><br><span class="line">       <span class="comment">//2. 绑定FBO</span></span><br><span class="line">       GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, fboId);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//3. 创建FBO纹理</span></span><br><span class="line">       fboTextureId = createTexture();</span><br><span class="line"></span><br><span class="line">       <span class="comment">//4. 把纹理绑定到FBO</span></span><br><span class="line">       GLES20.glFramebufferTexture2D(GLES20.GL_FRAMEBUFFER, GLES20.GL_COLOR_ATTACHMENT0,</span><br><span class="line">               GLES20.GL_TEXTURE_2D, fboTextureId, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//5. 设置FBO分配内存大小</span></span><br><span class="line">       GLES20.glTexImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, GLES20.GL_RGBA, w, h,</span><br><span class="line">               <span class="number">0</span>, GLES20.GL_RGBA, GLES20.GL_UNSIGNED_BYTE, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//6. 检测是否绑定从成功</span></span><br><span class="line">       <span class="keyword">if</span> (GLES20.glCheckFramebufferStatus(GLES20.GL_FRAMEBUFFER)</span><br><span class="line">               != GLES20.GL_FRAMEBUFFER_COMPLETE) &#123;</span><br><span class="line">           Log.e(<span class="string">"zzz"</span>, <span class="string">"glFramebufferTexture2D error"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//7. 解绑纹理和FBO</span></span><br><span class="line">       GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line">       GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/OpenGLES帧缓冲FBO.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/OpenGLES帧缓冲FBO.html" itemprop="url">OpenGLES帧缓冲FBO</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-17T11:36:36+08:00">
                2018-08-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/OpenGLES帧缓冲FBO.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/OpenGLES帧缓冲FBO.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,122字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>FBO</strong></p>
<p>Frame Buffer object</p>
<p><strong>为什么要用FBO</strong></p>
<blockquote>
<p>我们需要对纹理进行多次渲染采样时，而这些渲染采样是不需要展示给用户看的，所以我们就可以用一个单独的缓冲对象（离屏渲染）来存储我们的这几次渲染采样的结果，等处理完后才显示到窗口上</p>
</blockquote>
<p><strong>优势</strong></p>
<blockquote>
<p>提高渲染效率，避免闪屏，可以很方便的实现纹理共享等。</p>
</blockquote>
<p><strong>渲染方式</strong></p>
<blockquote>
<ol>
<li>渲染到纹理（Texture）- 图像渲染</li>
<li>渲染到缓冲区（Render）- 深度测试和模板测试</li>
</ol>
</blockquote>
<p><strong>FBO纹理的坐标系</strong></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/4A5135C4EBC74CACB54D3567DF4E8988?method=download&amp;shareKey=220bd5a8e91019b6f2572c5c7466cce3" alt="FBO坐标系"></p>
<p><strong>渲染到纹理</strong></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/494EFDCEB3FC4AD281FB6C9A025239D0?method=download&amp;shareKey=f434505d8b8f2d506fece27e142ca1b4" alt="工作流程"></p>
<p>创建FBO的步骤:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//1. 创建FBO</span></span><br><span class="line"><span class="keyword">int</span>[] fbos = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">GLES20.glGenFramebuffers(<span class="number">1</span>, fbos, <span class="number">0</span>);</span><br><span class="line">fboId = fbos[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. 绑定FBO</span></span><br><span class="line">GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, fboId);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 创建FBO纹理</span></span><br><span class="line">fboTextureId = createTexture();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//4. 把纹理绑定到FBO</span></span><br><span class="line">GLES20.glFramebufferTexture2D(GLES20.GL_FRAMEBUFFER, GLES20.GL_COLOR_ATTACHMENT0,GLES20.GL_TEXTURE_2D, fboTextureId, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//5. 设置FBO分配内存大小</span></span><br><span class="line">GLES20.glTexImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, GLES20.GL_RGBA,bitmap.getWidth(), bitmap.getHeight(),<span class="number">0</span>, GLES20.GL_RGBA, GLES20.GL_UNSIGNED_BYTE, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//6. 检测是否绑定从成功</span></span><br><span class="line"><span class="keyword">if</span> (GLES20.glCheckFramebufferStatus(GLES20.GL_FRAMEBUFFER)!= GLES20.GL_FRAMEBUFFER_COMPLETE) &#123;</span><br><span class="line">    Log.e(<span class="string">"zzz"</span>, <span class="string">"glFramebufferTexture2D error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//7. 解绑纹理和FBO</span></span><br><span class="line">GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line">GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>使用FBO的步骤:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. 绑定fbo</span></span><br><span class="line">GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, fboId);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. FBO绘制</span></span><br><span class="line">GLES20.glUseProgram(program);</span><br><span class="line"><span class="comment">//绑定渲染纹理</span></span><br><span class="line">GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, imageTextureId);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//解绑纹理</span></span><br><span class="line">GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//解绑fbo</span></span><br><span class="line">GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 根据绑定到fbo上的纹理id，渲染</span></span><br><span class="line"> GLES20.glUseProgram(program);</span><br><span class="line"><span class="comment">//绑定渲染纹理</span></span><br><span class="line">GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureId);</span><br><span class="line"> <span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>示例代码如下:</p>
<p>TexureRender.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TexureRender</span> <span class="keyword">implements</span> <span class="title">EglSurfaceView</span>.<span class="title">Renderer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BitmapFboTexture bitmapFboTexture;</span><br><span class="line">    <span class="keyword">private</span> BitmapRenderTexture bitmapRenderTexture;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TexureRender</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        bitmapFboTexture = <span class="keyword">new</span> BitmapFboTexture(context);</span><br><span class="line">        bitmapFboTexture.setBitmap(BitmapFactory.decodeResource(context.getResources(),R.mipmap.bg));</span><br><span class="line"></span><br><span class="line">        bitmapRenderTexture = <span class="keyword">new</span> BitmapRenderTexture(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bitmapFboTexture.onSurfaceCreated();</span><br><span class="line">        bitmapRenderTexture.onSurfaceCreated();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//宽高</span></span><br><span class="line">        GLES20.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line"></span><br><span class="line">        bitmapFboTexture.onSurfaceChanged(width, height);</span><br><span class="line">        bitmapRenderTexture.onSurfaceChanged(width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//清空颜色</span></span><br><span class="line">        GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT);</span><br><span class="line">        <span class="comment">//设置背景颜色</span></span><br><span class="line">        GLES20.glClearColor(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">        <span class="comment">//FBO处理</span></span><br><span class="line">        bitmapFboTexture.draw();</span><br><span class="line">        <span class="comment">//通过FBO处理之后，拿到纹理id，然后渲染</span></span><br><span class="line">        bitmapRenderTexture.draw(bitmapFboTexture.getFboTextureId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FBO处理类： BitmapFboTexture.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLUtils;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteOrder;</span><br><span class="line"><span class="keyword">import</span> java.nio.FloatBuffer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//纹理  根据坐标系映射</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitmapFboTexture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//顶点坐标</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> vertexData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            -<span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            -<span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//正常纹理坐标  对应顶点坐标  与之映射</span></span><br><span class="line"><span class="comment">//    static float textureData[] = &#123;   // in counterclockwise order:</span></span><br><span class="line"><span class="comment">//            0f, 1f, 0.0f, // bottom left</span></span><br><span class="line"><span class="comment">//            1f, 1f, 0.0f, // bottom right</span></span><br><span class="line"><span class="comment">//            0f, 0f, 0.0f, // top left</span></span><br><span class="line"><span class="comment">//            1f, 0f, 0.0f,  // top right</span></span><br><span class="line"><span class="comment">//    &#125;;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//fbo 纹理坐标</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> textureData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每一次取点的时候取几个点</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COORDS_PER_VERTEX = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexCount = vertexData.length / COORDS_PER_VERTEX;</span><br><span class="line">    <span class="comment">//每一次取的总的点 大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexStride = COORDS_PER_VERTEX * <span class="number">4</span>; <span class="comment">// 4 bytes per vertex</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//位置</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer vertexBuffer;</span><br><span class="line">    <span class="comment">//纹理</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer textureBuffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> program;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> avPosition;</span><br><span class="line">    <span class="comment">//纹理位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> afPosition;</span><br><span class="line">    <span class="comment">//需要渲染的纹理id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> imageTextureId;</span><br><span class="line">    <span class="comment">//fbo纹理id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fboTextureId;</span><br><span class="line">    <span class="comment">//fbo Id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fboId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Bitmap bitmap;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBitmap</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bitmap = bitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BitmapFboTexture</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line"></span><br><span class="line">        vertexBuffer = ByteBuffer.allocateDirect(vertexData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(vertexData);</span><br><span class="line">        vertexBuffer.position(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        textureBuffer = ByteBuffer.allocateDirect(textureData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(textureData);</span><br><span class="line">        textureBuffer.position(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String vertexSource = ShaderUtil.readRawTxt(context, R.raw.vertex_shader);</span><br><span class="line">        String fragmentSource = ShaderUtil.readRawTxt(context, R.raw.fragment_shader);</span><br><span class="line">        program = ShaderUtil.createProgram(vertexSource, fragmentSource);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (program &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//获取顶点坐标字段</span></span><br><span class="line">            avPosition = GLES20.glGetAttribLocation(program, <span class="string">"av_Position"</span>);</span><br><span class="line">            <span class="comment">//获取纹理坐标字段</span></span><br><span class="line">            afPosition = GLES20.glGetAttribLocation(program, <span class="string">"af_Position"</span>);</span><br><span class="line">            createFBO();</span><br><span class="line">            imageTextureId = createImageTexture();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绑定fbo</span></span><br><span class="line">        GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, fboId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用程序</span></span><br><span class="line">        GLES20.glUseProgram(program);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绑定渲染纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, imageTextureId);</span><br><span class="line"></span><br><span class="line">        GLES20.glEnableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glEnableVertexAttribArray(afPosition);</span><br><span class="line">        <span class="comment">//设置顶点位置值</span></span><br><span class="line">        GLES20.glVertexAttribPointer(avPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, vertexBuffer);</span><br><span class="line">        <span class="comment">//设置纹理位置值</span></span><br><span class="line">        GLES20.glVertexAttribPointer(afPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, textureBuffer);</span><br><span class="line">        <span class="comment">//绘制 GLES20.GL_TRIANGLE_STRIP:复用坐标</span></span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="number">0</span>, vertexCount);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(afPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解绑纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解绑fbo</span></span><br><span class="line">        GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createFBO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"bitmap is  null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. 创建FBO</span></span><br><span class="line">        <span class="keyword">int</span>[] fbos = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        GLES20.glGenFramebuffers(<span class="number">1</span>, fbos, <span class="number">0</span>);</span><br><span class="line">        fboId = fbos[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//2. 绑定FBO</span></span><br><span class="line">        GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, fboId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 创建FBO纹理</span></span><br><span class="line">        fboTextureId = createTexture();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 把纹理绑定到FBO</span></span><br><span class="line">        GLES20.glFramebufferTexture2D(GLES20.GL_FRAMEBUFFER, GLES20.GL_COLOR_ATTACHMENT0,</span><br><span class="line">                GLES20.GL_TEXTURE_2D, fboTextureId, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 设置FBO分配内存大小</span></span><br><span class="line">        GLES20.glTexImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, GLES20.GL_RGBA, bitmap.getWidth(), bitmap.getHeight(),</span><br><span class="line">                <span class="number">0</span>, GLES20.GL_RGBA, GLES20.GL_UNSIGNED_BYTE, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6. 检测是否绑定从成功</span></span><br><span class="line">        <span class="keyword">if</span> (GLES20.glCheckFramebufferStatus(GLES20.GL_FRAMEBUFFER)</span><br><span class="line">                != GLES20.GL_FRAMEBUFFER_COMPLETE) &#123;</span><br><span class="line">            Log.e(<span class="string">"zzz"</span>, <span class="string">"glFramebufferTexture2D error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//7. 解绑纹理和FBO</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line">        GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createImageTexture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] textureIds = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">//创建纹理</span></span><br><span class="line">        GLES20.glGenTextures(<span class="number">1</span>, textureIds, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (textureIds[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//绑定纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureIds[<span class="number">0</span>]);</span><br><span class="line">        <span class="comment">//环绕（超出纹理坐标范围）  （s==x t==y GL_REPEAT 重复）</span></span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_REPEAT);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_REPEAT);</span><br><span class="line">        <span class="comment">//过滤（纹理像素映射到坐标点）  （缩小、放大：GL_LINEAR线性）</span></span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//测试图片</span></span><br><span class="line">        GLUtils.texImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, bitmap, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解绑纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> textureIds[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createTexture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] textureIds = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">//创建纹理</span></span><br><span class="line">        GLES20.glGenTextures(<span class="number">1</span>, textureIds, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (textureIds[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//绑定纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureIds[<span class="number">0</span>]);</span><br><span class="line">        <span class="comment">//环绕（超出纹理坐标范围）  （s==x t==y GL_REPEAT 重复）</span></span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_REPEAT);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_REPEAT);</span><br><span class="line">        <span class="comment">//过滤（纹理像素映射到坐标点）  （缩小、放大：GL_LINEAR线性）</span></span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">        GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">        <span class="keyword">return</span> textureIds[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getFboTextureId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fboTextureId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>渲染类：BitmapRenderTexture.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteOrder;</span><br><span class="line"><span class="keyword">import</span> java.nio.FloatBuffer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//纹理  根据坐标系映射</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitmapRenderTexture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//顶点坐标</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> vertexData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            -<span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            -<span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//纹理坐标  对应顶点坐标  与之映射</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> textureData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每一次取点的时候取几个点</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COORDS_PER_VERTEX = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexCount = vertexData.length / COORDS_PER_VERTEX;</span><br><span class="line">    <span class="comment">//每一次取的总的点 大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexStride = COORDS_PER_VERTEX * <span class="number">4</span>; <span class="comment">// 4 bytes per vertex</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line">    <span class="comment">//位置</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer vertexBuffer;</span><br><span class="line">    <span class="comment">//纹理</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer textureBuffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> program;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> avPosition;</span><br><span class="line">    <span class="comment">//纹理位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> afPosition;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BitmapRenderTexture</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line"></span><br><span class="line">        vertexBuffer = ByteBuffer.allocateDirect(vertexData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(vertexData);</span><br><span class="line">        vertexBuffer.position(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        textureBuffer = ByteBuffer.allocateDirect(textureData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(textureData);</span><br><span class="line">        textureBuffer.position(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String vertexSource = ShaderUtil.readRawTxt(context, R.raw.vertex_shader);</span><br><span class="line">        String fragmentSource = ShaderUtil.readRawTxt(context, R.raw.fragment_shader);</span><br><span class="line">        program = ShaderUtil.createProgram(vertexSource, fragmentSource);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (program &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//获取顶点坐标字段</span></span><br><span class="line">            avPosition = GLES20.glGetAttribLocation(program, <span class="string">"av_Position"</span>);</span><br><span class="line">            <span class="comment">//获取纹理坐标字段</span></span><br><span class="line">            afPosition = GLES20.glGetAttribLocation(program, <span class="string">"af_Position"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">int</span> textureId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用程序</span></span><br><span class="line">        GLES20.glUseProgram(program);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绑定渲染纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureId);</span><br><span class="line"></span><br><span class="line">        GLES20.glEnableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glEnableVertexAttribArray(afPosition);</span><br><span class="line">        <span class="comment">//设置顶点位置值</span></span><br><span class="line">        GLES20.glVertexAttribPointer(avPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, vertexBuffer);</span><br><span class="line">        <span class="comment">//设置纹理位置值</span></span><br><span class="line">        GLES20.glVertexAttribPointer(afPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, textureBuffer);</span><br><span class="line">        <span class="comment">//绘制 GLES20.GL_TRIANGLE_STRIP:复用坐标</span></span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="number">0</span>, vertexCount);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(afPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解绑纹理</span></span><br><span class="line">        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        GLES20.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zengzhaowen.cn/OpenGLES顶点缓冲VBO.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="曾大稳丶">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="曾大稳丶">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/OpenGLES顶点缓冲VBO.html" itemprop="url">OpenGLES顶点缓冲VBO</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-16T15:18:07+08:00">
                2018-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenGLES/" itemprop="url" rel="index">
                    <span itemprop="name">OpenGLES</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/OpenGLES顶点缓冲VBO.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/OpenGLES顶点缓冲VBO.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,122字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>VBO</strong> </p>
<p>Vertex Buffer object</p>
<p><strong>为什么要用VBO</strong></p>
<blockquote>
<p>不使用VBO时，我们每次绘制（ glDrawArrays ）图形时都是从本地内存处获取顶点数据然后传输给OpenGL来绘制，这样就会频繁的操作CPU-&gt;GPU增大开销，从而降低效率。<br>使用VBO，我们就能把顶点数据缓存到GPU开辟的一段内存中，然后使用时不必再从本地获取，而是直接从显存中获取，这样就能提升绘制的效率。</p>
</blockquote>
<p>创建VBO的主要步骤:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. 创建VBO得到vboId</span></span><br><span class="line"><span class="keyword">int</span>[] vbos = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">GLES20.glGenBuffers(<span class="number">1</span>, vbos, <span class="number">0</span>);</span><br><span class="line">vboId = vbos[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. 根据id绑定VBO</span></span><br><span class="line">GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, vboId);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 分配VBO需要的缓存大小</span></span><br><span class="line">GLES20.glBufferData(GLES20.GL_ARRAY_BUFFER, vertex.length * <span class="number">4</span>,<span class="keyword">null</span>, GLES20. GL_STATIC_DRAW);</span><br><span class="line"></span><br><span class="line"><span class="comment">//4. 为VBO设置顶点数据的值</span></span><br><span class="line">GLES20.glBufferSubData(GLES20.GL_ARRAY_BUFFER, <span class="number">0</span>, vertexData.length * <span class="number">4</span>, vertexBuffer);</span><br><span class="line"></span><br><span class="line"><span class="comment">//5. 解绑VBO</span></span><br><span class="line">GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>使用VBO的主要步骤:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. 根据id绑定VBO</span></span><br><span class="line">GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, vboId);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. 设置顶点数据</span></span><br><span class="line">GLES20.glVertexAttribPointer(vPosition, <span class="number">2</span>, GLES20.GL_FLOAT, <span class="keyword">false</span>, <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 解绑VBO</span></span><br><span class="line">GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>我使用绘制图片纹理的代码来进行改造为<code>VBO</code>，<a href="http://zengzhaowen.cn/Android%20OpenGLES%20%E7%BB%98%E5%88%B6%E5%9B%BE%E7%89%87%E7%BA%B9%E7%90%86.html" target="_blank" rel="noopener">OpenGLES 绘制图片纹理</a></p>
<p>改造的只有<code>BitmapTexture</code>这个类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLES20;</span><br><span class="line"><span class="keyword">import</span> android.opengl.GLUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteOrder;</span><br><span class="line"><span class="keyword">import</span> java.nio.FloatBuffer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//纹理  根据坐标系映射</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitmapTexture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//顶点坐标</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> vertexData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            -<span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, -<span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            -<span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//纹理坐标  对应顶点坐标  与之映射</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">float</span> textureData[] = &#123;   <span class="comment">// in counterclockwise order:</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">1f</span>, <span class="number">0.0f</span>, <span class="comment">// bottom right</span></span><br><span class="line">            <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>, <span class="comment">// top left</span></span><br><span class="line">            <span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0.0f</span>,  <span class="comment">// top right</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每一次取点的时候取几个点</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COORDS_PER_VERTEX = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexCount = vertexData.length / COORDS_PER_VERTEX;</span><br><span class="line">    <span class="comment">//每一次取的总的点 大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexStride = COORDS_PER_VERTEX * <span class="number">4</span>; <span class="comment">// 4 bytes per vertex</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//位置</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer vertexBuffer;</span><br><span class="line">    <span class="comment">//纹理</span></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer textureBuffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> program;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> avPosition;</span><br><span class="line">    <span class="comment">//纹理位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> afPosition;</span><br><span class="line">    <span class="comment">//纹理id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> textureId;</span><br><span class="line">    <span class="comment">//vbo id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> vboId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BitmapTexture</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line"></span><br><span class="line">        vertexBuffer = ByteBuffer.allocateDirect(vertexData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(vertexData);</span><br><span class="line">        vertexBuffer.position(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        textureBuffer = ByteBuffer.allocateDirect(textureData.length * <span class="number">4</span>)</span><br><span class="line">                .order(ByteOrder.nativeOrder())</span><br><span class="line">                .asFloatBuffer()</span><br><span class="line">                .put(textureData);</span><br><span class="line">        textureBuffer.position(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String vertexSource = ShaderUtil.readRawTxt(context, R.raw.vertex_shader);</span><br><span class="line">        String fragmentSource = ShaderUtil.readRawTxt(context, R.raw.fragment_shader);</span><br><span class="line">        program = ShaderUtil.createProgram(vertexSource, fragmentSource);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (program &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//获取顶点坐标字段</span></span><br><span class="line">            avPosition = GLES20.glGetAttribLocation(program, <span class="string">"av_Position"</span>);</span><br><span class="line">            <span class="comment">//获取纹理坐标字段</span></span><br><span class="line">            afPosition = GLES20.glGetAttribLocation(program, <span class="string">"af_Position"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建vbo</span></span><br><span class="line">            createVBO();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span>[] textureIds = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//创建纹理</span></span><br><span class="line">            GLES20.glGenTextures(<span class="number">1</span>, textureIds, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (textureIds[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            textureId = textureIds[<span class="number">0</span>];</span><br><span class="line">            <span class="comment">//绑定纹理</span></span><br><span class="line">            GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, textureId);</span><br><span class="line">            <span class="comment">//环绕（超出纹理坐标范围）  （s==x t==y GL_REPEAT 重复）</span></span><br><span class="line">            GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_REPEAT);</span><br><span class="line">            GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_REPEAT);</span><br><span class="line">            <span class="comment">//过滤（纹理像素映射到坐标点）  （缩小、放大：GL_LINEAR线性）</span></span><br><span class="line">            GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_LINEAR);</span><br><span class="line">            GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);</span><br><span class="line"></span><br><span class="line">            Bitmap bitmap = BitmapFactory.decodeResource(context.getResources(), R.mipmap.bg);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//设置纹理为2d图片</span></span><br><span class="line">            GLUtils.texImage2D(GLES20.GL_TEXTURE_2D, <span class="number">0</span>, bitmap, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用程序</span></span><br><span class="line">        GLES20.glUseProgram(program);</span><br><span class="line">        GLES20.glEnableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glEnableVertexAttribArray(afPosition);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//直接设置</span></span><br><span class="line">        <span class="comment">// 设置顶点位置值</span></span><br><span class="line"><span class="comment">//        GLES20.glVertexAttribPointer(avPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, false, vertexStride, vertexBuffer);</span></span><br><span class="line">        <span class="comment">//设置纹理值</span></span><br><span class="line"><span class="comment">//        GLES20.glVertexAttribPointer(afPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, false, vertexStride, textureBuffer);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用vbo设置</span></span><br><span class="line">        useVboDraw();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绘制 GLES20.GL_TRIANGLE_STRIP:复用坐标</span></span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="number">0</span>, vertexCount);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(avPosition);</span><br><span class="line">        GLES20.glDisableVertexAttribArray(afPosition);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createVBO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 创建VBO</span></span><br><span class="line">        <span class="keyword">int</span>[] vbos = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        GLES20.glGenBuffers(vbos.length, vbos, <span class="number">0</span>);</span><br><span class="line">        vboId = vbos[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//2. 绑定VBO</span></span><br><span class="line">        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, vboId);</span><br><span class="line">        <span class="comment">//3. 分配VBO需要的缓存大小</span></span><br><span class="line">        GLES20.glBufferData(GLES20.GL_ARRAY_BUFFER, vertexData.length * <span class="number">4</span> + textureData.length * <span class="number">4</span>, <span class="keyword">null</span>, GLES20.GL_STATIC_DRAW);</span><br><span class="line">        <span class="comment">//4. 为VBO设置顶点数据的值</span></span><br><span class="line">        GLES20.glBufferSubData(GLES20.GL_ARRAY_BUFFER, <span class="number">0</span>, vertexData.length * <span class="number">4</span>, vertexBuffer);</span><br><span class="line">        GLES20.glBufferSubData(GLES20.GL_ARRAY_BUFFER, vertexData.length * <span class="number">4</span>, textureData.length * <span class="number">4</span>, textureBuffer);</span><br><span class="line">        <span class="comment">//5. 解绑VBO</span></span><br><span class="line">        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">useVboDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 绑定VBO</span></span><br><span class="line">        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, vboId);</span><br><span class="line">        <span class="comment">//2. 设置顶点数据</span></span><br><span class="line">        GLES20.glVertexAttribPointer(avPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, <span class="number">0</span>);</span><br><span class="line">        GLES20.glVertexAttribPointer(afPosition, COORDS_PER_VERTEX, GLES20.GL_FLOAT, <span class="keyword">false</span>, vertexStride, vertexData.length * <span class="number">4</span>);</span><br><span class="line">        <span class="comment">//3. 解绑VBO</span></span><br><span class="line">        GLES20.glBindBuffer(GLES20.GL_ARRAY_BUFFER, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    
    <div>
    
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>



    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/header.jpg"
                alt="曾大稳丶" />
            
              <p class="site-author-name" itemprop="name">曾大稳丶</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">80</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">曾大稳丶</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>







        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: '5mOx5QUSJWyNMHeGUeqhG6uH-gzGzoHsz',
        appKey: '1gJRAgpCvNnFBWXPBRwEPmAM',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>